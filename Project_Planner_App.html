<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Project Planner (v20)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --bg-grad-start:#0e1e45; --bg-grad-end:transparent;
      --ios:#4e79a7; --android:#59a14f; --web:#f28e2c; --be:#9c755f; --qa:#edc948;
      --label-pad: 180px;
    }
    body{background-image: radial-gradient(1200px 700px at 15% -10%, var(--bg-grad-start) 0%, var(--bg-grad-end) 60%); background-attachment: fixed;}
    .app-header{position:sticky;top:0;z-index:1030;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08);}
    @media (min-width:1400px){.container-xxl{max-width:1800px}}
    .pointer{cursor:pointer}
    .card-hover{transition:box-shadow .2s, transform .1s; cursor:pointer}
    .card-hover:hover{box-shadow:0 8px 30px rgba(0,0,0,.25); transform:translateY(-2px)}
    .mini-timeline{border-radius:.5rem;border:1px solid var(--bs-border-color); overflow:hidden}
    .mini-phase{height:8px;background:var(--bs-border-color);opacity:.6; position:relative}
    .mini-platforms{height:8px;display:flex;width:100%}
    .seg{height:8px;flex:1 1 0}
    .gantt-wrap{border:1px solid var(--bs-border-color); border-radius:.75rem; overflow:hidden}
    .gantt-toolbar{position:sticky;top:0;z-index:2;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color)}
    .gantt{position:relative; height:540px; overflow:auto; cursor:grab}
    .gantt:active{cursor:grabbing}
    .gantt .content{position:relative}
    .ruler{position:sticky; top:0; height:60px; background:linear-gradient(180deg, var(--bs-body-bg), var(--bs-body-bg) 62%, transparent); margin-left:var(--label-pad); border-bottom:1px solid var(--bs-border-color); z-index:1}
    .tick{position:absolute; bottom:0; width:1px; height:12px; background:rgba(127,127,127,.35)}
    .tick.major{height:24px; background:rgba(127,127,127,.6)}
    .label{position:absolute; bottom:24px; transform:translateX(-50%); font-size:.75em; color:var(--bs-secondary-color); white-space:nowrap}
    .month-section{position:absolute; bottom:0; height:24px; display:flex; align-items:center; justify-content:center; font-weight:600; color:var(--bs-body-color); font-size:.8em; pointer-events:none}
    .grid{position:absolute; left:0; right:0; top:60px; bottom:0; pointer-events:none}
    .gridline{position:absolute; top:0; bottom:0; width:1px; background:rgba(127,127,127,.15)}
    .gridline.week{background:rgba(127,127,127,.22)}
    .gridline.major{background:rgba(127,127,127,.28)}
    .hover-line{position:absolute; top:60px; bottom:0; width:1px; background:rgba(255,255,255,.3); pointer-events:none; display:none}
    .hover-label{position:absolute; top:0; transform:translateX(-50%); font-size:.75em; color:var(--bs-body-color); background:var(--bs-body-bg); border:1px solid var(--bs-border-color); padding:1px 4px; border-radius:4px; pointer-events:none; display:none}
    .lane{position:relative; height:44px; border-bottom:1px dashed var(--bs-border-color); display:flex; align-items:center}
    .lane-label{position:absolute; left:12px; top:10px; width:160px; font-weight:600}
    .bar{position:absolute; top:4px; height:36px; border-radius:.5rem; display:flex; align-items:center; padding:0 .6rem; color:#000; font-weight:700; border:1px solid rgba(0,0,0,.18); user-select:none}
    .release-bar{background:#6f42c1;color:#fff}
    .sprint-bar{background:#dc3545;color:#fff;font-size:.75em}
    .phase-bar{background:var(--bs-secondary);color:#fff;font-size:.75em}
    .phase-badge{background:var(--bs-secondary);color:#fff}
    .badge-lane{display:inline-flex;align-items:center;gap:.3rem}
    .badge-lane .dot{width:.7rem;height:.7rem;border-radius:50%}
    .pdf-sheet{width:1100px; margin:0 auto; padding:24px}
    .pdf-h1{font-size:24px; font-weight:700}
    .pdf-h2{font-size:20px; font-weight:700; margin-top:16px}
    .pdf-h3{font-size:16px; font-weight:700; margin-top:12px}
    .pdf-meta{color:#6c757d; font-size:.9rem}
    .pdf-card{border:1px solid #dee2e6; border-radius:12px; padding:16px; margin-top:12px}
    #phaseTaskContainers{min-height:360px}
    .pt-box{width:260px; display:flex; flex-direction:column; height:100%}
    .pt-pool-box{width:300px}
    .pt-drop{flex:1; min-height:60px; overflow:auto}
    .pt-task{cursor:move; font-size:.875rem; border:1px solid var(--bs-border-color); border-radius:.25rem; padding:2px 6px; background:var(--bs-tertiary-bg); display:flex; align-items:center; gap:.25rem}
    .pt-task.selected{outline:2px solid var(--bs-link-color); background:var(--bs-secondary-bg)}
    .pt-task .pt-remove{cursor:pointer}
    .pt-tags{display:flex; flex-wrap:wrap; gap:.25rem}
    .pt-matrix-wrapper{max-height:420px;overflow:auto}
    #phaseTaskMatrix th{position:sticky;top:0;background:var(--bs-body-bg)}
    #phaseTaskMatrix th:first-child{position:sticky;left:0;background:var(--bs-body-bg);z-index:2}
    #phaseTaskMatrix td:first-child{position:sticky;left:0;background:var(--bs-body-bg);z-index:1}
    .specialty-field{background:var(--bs-light)!important; color:var(--bs-dark)!important; border:1px solid var(--bs-border-color)!important; min-height:38px; display:flex; align-items:center; font-weight:500; border-radius:0.375rem; box-shadow:inset 0 1px 2px rgba(0,0,0,.075); transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}
    .capacity-indicator{transition:transform .15s ease-in-out}
    .capacity-indicator:hover{transform:scale(1.2)}
    .capacity-tooltip{pointer-events:none}
    
    /* Toast styling */
    #toast-container .toast {
      min-width: 300px;
      max-width: 400px;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      border-radius: 0.5rem;
      transition: opacity 0.3s ease-in;
    }
    
    #toast-container .toast .toast-body {
      font-size: 0.9rem;
      padding: 0.75rem 1rem;
      word-wrap: break-word;
    }
    
    #toast-container .toast .btn-close {
      filter: brightness(0) invert(1);
    }
    
    /* Responsive toast positioning */
    @media (max-width: 768px) {
      #toast-container {
        top: 0;
        right: 0;
        left: 0;
        padding: 0.5rem;
      }
      
      #toast-container .toast {
        min-width: auto;
        max-width: none;
        margin-bottom: 0.5rem;
      }
    }

  </style>
</head>
<body>
  <!-- Toast Container for Notifications -->
  <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
  
  <header class="app-header py-2 px-3">
    <div class="d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <div>
          <h1 class="h5 mb-0">Project Planner <span class="text-secondary">(v20)</span></h1>

<div class="small text-secondary">Start: <b id="startLabel">2025-08-13</b> • Efficiency: <b id="effLabel">0.8</b> md/eng/day • Local JSON persistence</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="small text-secondary">Theme</span>
          <select id="themeSelect" class="form-select form-select-sm"></select>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group">
          <button id="btn-manage" class="btn btn-outline-primary"><i class="bi bi-sliders"></i> Configure</button>
          <div class="btn-group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-database"></i> Data</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" id="exportTasksCSV"><i class="bi bi-filetype-csv me-1"></i>Export Tasks (CSV)</a></li>
              <li><a class="dropdown-item" id="exportTasksXLSX"><i class="bi bi-filetype-xlsx me-1"></i>Export Tasks (Excel)</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><label class="dropdown-item pointer mb-0">
                <i class="bi bi-box-arrow-in-down me-1"></i>Import Tasks (CSV/Excel)
                <input id="importTasks" type="file" accept=".csv, .xlsx, .xls" hidden>
              </label></li>
            </ul>
          </div>
          <div class="btn-group">
            <button class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-filetype-xlsx"></i> Export Excel</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" id="btn-export-project-xlsx-styled"><i class="bi bi-palette me-1"></i>Project (Styled)</a></li>
              <li><a class="dropdown-item" id="btn-export-plan-xlsx-styled"><i class="bi bi-palette me-1"></i>Plan (Styled)</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" id="btn-export-project-xlsx"><i class="bi bi-table me-1"></i>Project (Basic)</a></li>
              <li><a class="dropdown-item" id="btn-export-plan-xlsx"><i class="bi bi-table me-1"></i>Plan (Basic)</a></li>
            </ul>
          </div>
          <button id="btn-export" class="btn btn-outline-secondary"><i class="bi bi-box-arrow-down"></i> Export JSON</button>
          <label class="btn btn-outline-secondary mb-0 pointer">
            <i class="bi bi-upload"></i> Import <input id="file-import" type="file" accept=".json" hidden>
          </label>
          <button id="btn-reset" class="btn btn-outline-danger"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container-xxl py-3">
    <div id="projectsLayer" class="row g-3"></div>

    <div id="plansLayer" style="display:none">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center gap-2">
          <button id="btn-back-projects" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Projects</button>
          <h2 id="plans-title" class="h6 mb-0"></h2>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="btn-export-project-pdf" class="btn btn-primary btn-sm"><i class="bi bi-filetype-pdf"></i> Export Project PDF</button>
          <button id="btn-open-efforts" class="btn btn-outline-secondary btn-sm"><i class="bi bi-sliders"></i> Edit Task Efforts</button>
          <button id="btn-export-project-xlsx-basic" class="btn btn-success btn-sm"><i class="bi bi-filetype-xlsx"></i> Export Project Excel (Basic)</button>
        </div>
      </div>
      <div id="plansGrid" class="row g-3"></div>
    </div>

    <div id="detail" class="mt-2" style="display:none">
      <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
        <div class="d-flex align-items-center gap-2">
          <button id="btn-back-plans" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Plans</button>
          <h2 id="detail-title" class="h6 mb-0"></h2>
          <span class="badge text-bg-secondary" id="detail-team"></span>
          <span class="badge text-bg-secondary">Buffer <span id="detail-buffer"></span>%</span>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" id="laneMenuBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside">Lanes</button>
            <div id="lane-menu" class="dropdown-menu p-2"></div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="btn-export-plan-pdf" class="btn btn-primary btn-sm"><i class="bi bi-filetype-pdf"></i> Export Plan PDF</button>
          <button id="btn-export-plan-xlsx-basic" class="btn btn-success btn-sm"><i class="bi bi-filetype-xlsx"></i> Export Plan Excel (Basic)</button>
        </div>
      </div>

      <div class="gantt-wrap mb-3">
        <div class="gantt-toolbar p-2 d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-4">
            <div class="d-flex align-items-center gap-2">
              <span class="small text-secondary">Zoom</span>
              <button class="btn btn-sm btn-outline-secondary" id="zoomMinus">−</button>
              <input type="range" id="zoomRange" min="6" max="44" step="2" value="18" style="width:240px">
              <button class="btn btn-sm btn-outline-secondary" id="zoomPlus">+</button>
              <button class="btn btn-sm btn-outline-secondary" id="zoomFit">Fit</button>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="small text-secondary">Font</span>
              <button class="btn btn-sm btn-outline-secondary" id="fontMinus">−</button>
              <input type="range" id="fontRange" min="0.5" max="2" step="0.1" value="1" style="width:120px">
              <button class="btn btn-sm btn-outline-secondary" id="fontPlus">+</button>
            </div>
          </div>
          <div class="small text-secondary">Drag any bar to shift dates. Click a bar to view task breakdown.</div>
        </div>
        <div class="gantt" id="ganttScroll">
          <div class="content" id="ganttContent"></div>
        </div>
      </div>

      <!-- Phase Schedule Table (moved up, right after chart) -->
      <div class="card mt-3">
        <div class="card-header d-flex align-items-center justify-content-between" style="cursor: pointer;" onclick="toggleCollapsible('phaseSchedule')">
          <span><i class="bi bi-calendar-event"></i> Phase Schedule</span>
          <i class="bi bi-chevron-down" id="phaseSchedule-icon"></i>
        </div>
        <div class="card-body" id="phaseSchedule-content">
          <div class="table-responsive">
            <table id="phaseDatesTable" class="table table-sm table-bordered table-striped mb-0 align-middle">
              <thead class="table-dark"></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Effort Breakdown Table -->
      <div class="card mt-3">
        <div class="card-header d-flex align-items-center justify-content-between" style="cursor: pointer;" onclick="toggleCollapsible('effortBreakdown')">
          <span><i class="bi bi-pie-chart"></i> Effort Breakdown (totals by phase)</span>
          <i class="bi bi-chevron-down" id="effortBreakdown-icon"></i>
        </div>
        <div class="card-body" id="effortBreakdown-content">
          <div class="small text-secondary mb-2" id="detail-span"></div>
          <div class="table-responsive">
            <table id="effTable" class="table table-sm table-bordered mb-0 align-middle">
              <thead class="table-dark"></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Team Capacity Table -->
      <div class="card mt-3">
        <div class="card-header d-flex align-items-center justify-content-between" style="cursor: pointer;" onclick="toggleCollapsible('teamCapacity')">
          <span><i class="bi bi-people"></i> Team Capacity &amp; Structure</span>
          <i class="bi bi-chevron-down" id="teamCapacity-icon"></i>
        </div>
        <div class="card-body" id="teamCapacity-content">
          <div class="table-responsive">
            <table id="teamTable" class="table table-sm table-bordered mb-0 align-middle">
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span>Detailed Phase → Task effort breakdown</span>
          <div class="small text-secondary">Explicit task efforts are honored; otherwise FE/QA efforts are distributed across FE tasks in a phase.</div>
        </div>
        <div class="card-body">
          <div class="accordion" id="phaseBreakdown"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Manage Modal (CRUD Console) -->
  <div class="modal fade" id="manageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-sliders"></i> Configure</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" id="manageTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-projects" data-bs-toggle="tab" data-bs-target="#pane-projects" type="button" role="tab">Projects</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-plans" data-bs-toggle="tab" data-bs-target="#pane-plans" type="button" role="tab">Delivery Plans</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-phases" data-bs-toggle="tab" data-bs-target="#pane-phases" type="button" role="tab">Phases</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-teams" data-bs-toggle="tab" data-bs-target="#pane-teams" type="button" role="tab">Teams</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-sprints" data-bs-toggle="tab" data-bs-target="#pane-sprints" type="button" role="tab">Sprints</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-releases" data-bs-toggle="tab" data-bs-target="#pane-releases" type="button" role="tab">Releases</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-tasks" data-bs-toggle="tab" data-bs-target="#pane-tasks" type="button" role="tab">Tasks</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-phase-tasks" data-bs-toggle="tab" data-bs-target="#pane-phase-tasks" type="button" role="tab">Phase Tasks</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-effort-types" data-bs-toggle="tab" data-bs-target="#pane-effort-types" type="button" role="tab">Effort Types</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-team-members" data-bs-toggle="tab" data-bs-target="#pane-team-members" type="button" role="tab">Team Members</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-efforts" data-bs-toggle="tab" data-bs-target="#pane-efforts" type="button" role="tab">Efforts</button>
  </li>
  <li class="nav-item ms-auto" role="presentation">
    <button class="nav-link" id="tab-general" data-bs-toggle="tab" data-bs-target="#pane-general" type="button" role="tab"><i class="bi bi-gear"></i> General</button>
  </li>
</ul>
          <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="pane-projects" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-projects" class="form-control" placeholder="Search projects">
                </div>
                <button class="btn btn-primary" id="btn-add-project"><i class="bi bi-plus-lg"></i> Add Project</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-projects">
                  <thead><tr><th style="width:25%">Name</th><th>Description</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-plans" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-plans" class="form-control" placeholder="Search delivery plans">
                </div>
                <button class="btn btn-primary" id="btn-add-plan"><i class="bi bi-plus-lg"></i> Add Delivery Plan</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-plans">
                  <thead><tr><th>Title</th><th>Project</th><th>Team</th><th>Phases</th><th>Buffer%</th><th style="width:260px">Mini Timeline</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-phases" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-phases" class="form-control" placeholder="Search phases">
                </div>
                <button class="btn btn-primary" id="btn-add-phase"><i class="bi bi-plus-lg"></i> Add Phase</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-phases">
                  <thead><tr><th style="width:25%">Title</th><th>Description</th><th style="width:10%">Order</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-teams" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-teams" class="form-control" placeholder="Search teams">
                </div>
                <button class="btn btn-primary" id="btn-add-team"><i class="bi bi-plus-lg"></i> Add Team</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-teams">
                  <thead><tr id="teams-head"></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-sprints" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-sprints" class="form-control" placeholder="Search sprints">
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-danger" id="btn-reset-sprints"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                  <button class="btn btn-primary" id="btn-add-sprint"><i class="bi bi-plus-lg"></i> Add Sprint</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-sprints">
                  <thead><tr><th style="width:25%">Name</th><th style="width:20%">Start</th><th style="width:20%">End</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-releases" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-releases" class="form-control" placeholder="Search releases">
                </div>
                <button class="btn btn-primary" id="btn-add-release"><i class="bi bi-plus-lg"></i> Add Release</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-releases">
                  <thead><tr><th style="width:25%">Version</th><th style="width:20%">Code Freeze</th><th style="width:20%">Release</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-tasks" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-tasks" class="form-control" placeholder="Search tasks">
                </div>
                <button class="btn btn-primary" id="btn-add-task"><i class="bi bi-plus-lg"></i> Add Task</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-tasks">
                  <thead><tr><th style="width:28%">Title</th><th style="width:12%">Start</th><th style="width:18%">Project</th><th style="width:12%">Viable</th><th>Efforts</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-phase-tasks" role="tabpanel">
              <div class="d-flex align-items-center gap-2 mb-2">
                <label class="form-label mb-0">Project</label>
                <select id="pt-proj" class="form-select" style="max-width:240px"></select>
                <input id="pt-search" type="search" class="form-control" placeholder="Search tasks" style="max-width:260px">
                <div class="btn-group" role="group">
                  <button id="pt-view-board" class="btn btn-outline-secondary btn-sm active"><i class="bi bi-kanban"></i></button>
                  <button id="pt-view-matrix" class="btn btn-outline-secondary btn-sm"><i class="bi bi-table"></i></button>
                </div>
                <button id="pt-save" class="btn btn-primary btn-sm"><i class="bi bi-check2"></i> Save</button>
              </div>
              <div id="phaseLegend" class="mb-2 d-flex flex-wrap gap-2 small"></div>
              <div id="phaseTaskContainers" class="d-flex flex-wrap gap-3 align-items-stretch"></div>
            </div>

            <div class="tab-pane fade" id="pane-effort-types" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-effort-types" class="form-control" placeholder="Search effort types">
                </div>
                <button class="btn btn-primary" id="btn-add-effort-type"><i class="bi bi-plus-lg"></i> Add Effort Type</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-effort-types">
                  <thead><tr><th style="width:25%">Title</th><th style="width:20%">Color</th><th style="width:15%">Key</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-team-members" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-team-members" class="form-control" placeholder="Search team members">
                </div>
                <button class="btn btn-primary" id="btn-add-team-member"><i class="bi bi-plus-lg"></i> Add Team Member</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-team-members">
                  <thead><tr><th style="width:25%">Name</th><th style="width:20%">Specialty</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-efforts" role="tabpanel">
  <div class="d-flex align-items-center gap-2 mb-2">
    <label class="form-label mb-0">Project</label>
    <select id="eff-proj" class="form-select" style="max-width:240px"></select>
    <input id="eff-search" class="form-control" placeholder="Search tasks" style="max-width:260px">
    <button id="eff-save" class="btn btn-primary btn-sm"><i class="bi bi-check2"></i> Save</button>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="tbl-eff">
      <thead><tr id="eff-head"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="tab-pane fade" id="pane-general" role="tabpanel">
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-header">Scheduling</div>
                    <div class="card-body vstack gap-3">
                      <div><label class="form-label">Global start date</label><input id="gen-start" type="date" class="form-control"></div>
                      <div><label class="form-label">Efficiency (md per engineer per day)</label><input id="gen-eff" type="number" step="0.05" min="0.2" max="1.2" class="form-control"></div>
                      <div><label class="form-label">Default zoom (px per day)</label><input id="gen-px" type="number" min="6" max="44" step="1" class="form-control"></div>
                      <div class="form-check form-switch"><input id="gen-rtl" class="form-check-input" type="checkbox"><label class="form-check-label" for="gen-rtl">Enable RTL layout</label></div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-header">Appearance</div>
                    <div class="card-body vstack gap-3">
                      <div><label class="form-label">Theme</label>
                        <select id="gen-theme" class="form-select"></select>
                      </div>
                      <div class="small text-secondary">Themes adjust background and effort type colors. Changes persist.</div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="gen-save"><i class="bi bi-check2"></i> Save Settings</button>
                    <button class="btn btn-outline-secondary" id="gen-apply-px"><i class="bi bi-arrows"></i> Apply default zoom to all plans</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <div class="text-secondary small me-auto">Storage key: <code>project_planner_v20</code></div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" id="btn-save-manage">Save All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTitle">Edit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" class="vstack gap-3"></form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger me-auto d-none" id="editDelete"><i class="bi bi-trash"></i> Delete</button>
          <button class="btn btn-primary" id="editSave"><i class="bi bi-check2"></i> Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Breakdown Modal -->
  <div class="modal fade" id="breakdownModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="breakdownTitle">Task Breakdown</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3" id="bdTabs"></ul>
          <div id="bdContent"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed top-0 start-0 p-3" style="z-index:1080">
    <div id="appToast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Saved</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- XLSX / XlsxPopulate / Chart.js resilient loaders -->
  <script>
    const XLSX_SOURCES = [
      "https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js",
      "https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"
    ];
    const XPOP_SOURCES = [
      "https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js",
      "https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"
    ];
    const CHART_SOURCES = [
      "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.3/chart.umd.min.js",
      "https://unpkg.com/chart.js@4.4.3/dist/chart.umd.min.js"
    ];
    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s=document.createElement('script');
        s.src=src; s.async=true; s.type='text/javascript'; s.crossOrigin='anonymous'; s.onload=()=>resolve(src); s.onerror=()=>reject(src);
        document.head.appendChild(s);
      });
    }
    async function ensureXLSX(){ if(window.XLSX) return true; for(const src of XLSX_SOURCES){ try{ await loadScript(src); if(window.XLSX) return true; }catch(e){} } return !!window.XLSX; }
    async function ensureXPOP(){ if(window.XlsxPopulate) return true; for(const src of XPOP_SOURCES){ try{ await loadScript(src); if(window.XlsxPopulate) return true; }catch(e){} } return !!window.XlsxPopulate; }
    async function ensureCHART(){ if(window.Chart) return true; for(const src of CHART_SOURCES){ try{ await loadScript(src); if(window.Chart) return true; }catch(e){} } return !!window.Chart; }
  </script>

  <script type="module">
      import { aggregate, computeSchedule } from './schedule.js';
      import { exportPlanJSON, importPlanJSON, validateColumns } from './export.js';
      import { state, load, save, getTeam, getPhase, getProject, replaceState, mergeState, assignTaskToPhase, getTaskPhaseIds, getTasksByProject, getTasksByPhase, removeEffortType, DEFAULT_EFFORT_TYPES, ensureSprints, resetSprints, defaultPlanLanes, getTeamSizes, getTeamSizesForDate, createDefaultTeam, getAllTeamMembers, getTeamMember, addTeamMember, updateTeamMember, deleteTeamMember, createDefaultTeamMember } from './data.js';
      load();
      ensureSprints();
    /* ===================== APP CODE (v20) ===================== */
    const STORAGE_KEY = "project_planner_v20";
    const dayMs = 86400000;

    function effortTypes(){
      return (state.meta.effortTypes||[]).map(e=>e.key);
    }
    function effortTypeMeta(){
      const m={};
      (state.meta.effortTypes||[]).forEach(e=>{m[e.key]=e;});
      return m;
    }
    function effortTypeColor(k){ return effortTypeMeta()[k]?.color || '#888'; }
    function effortTypeTitle(k){ return effortTypeMeta()[k]?.title || k; }

    // Make these functions globally accessible
    window.effortTypes = effortTypes;
    window.effortTypeMeta = effortTypeMeta;
    window.effortTypeColor = effortTypeColor;
    window.effortTypeTitle = effortTypeTitle;

    const THEMES = {
      "Dark":     { bs:"dark", vars:{ bgStart:"#0e1e45", bgEnd:"transparent", ios:"#4e79a7", android:"#59a14f", web:"#f28e2c", be:"#9c755f", qa:"#edc948" } },
      "Light":    { bs:"light", vars:{ bgStart:"#e8eefc", bgEnd:"transparent", ios:"#356dab", android:"#2b8a3e", web:"#e3821b", be:"#7f5b4b", qa:"#bfa63a" } },
      "Midnight": { bs:"dark", vars:{ bgStart:"#090b1a", bgEnd:"transparent", ios:"#6ea8fe", android:"#63e6be", web:"#ffd43b", be:"#e599f7", qa:"#ffa8a8" } },
      "Emerald":  { bs:"dark", vars:{ bgStart:"#0a352e", bgEnd:"transparent", ios:"#77c3ff", android:"#4dd4ac", web:"#ffd08a", be:"#cfa8a1", qa:"#ffe066" } },
      "Royal":    { bs:"dark", vars:{ bgStart:"#1b2a4a", bgEnd:"transparent", ios:"#5ab0ff", android:"#78e08f", web:"#ffb347", be:"#b58e7c", qa:"#ffe066" } },
      "Ocean":    { bs:"dark", vars:{ bgStart:"#022c43", bgEnd:"transparent", ios:"#00a8cc", android:"#00c49a", web:"#f6b93b", be:"#ee5253", qa:"#48dbfb" } },
      "Sunset":   { bs:"light", vars:{ bgStart:"#fff3e0", bgEnd:"transparent", ios:"#ef5350", android:"#66bb6a", web:"#ffa726", be:"#8d6e63", qa:"#ffd54f" } },
      "Forest":   { bs:"dark", vars:{ bgStart:"#003311", bgEnd:"transparent", ios:"#66bb6a", android:"#43a047", web:"#c0ca33", be:"#8d6e63", qa:"#ffd54f" } },
      "Mono":     { bs:"light", vars:{ bgStart:"#f0f0f0", bgEnd:"transparent", ios:"#5c5c5c", android:"#787878", web:"#a0a0a0", be:"#3a3a3a", qa:"#c0c0c0" } },
      "High Contrast": { bs:"dark", vars:{ bgStart:"#000", bgEnd:"transparent", ios:"#00e5ff", android:"#00ff6a", web:"#ffea00", be:"#ff1744", qa:"#ffffff" } },
      "Solarized":{ bs:"light", vars:{ bgStart:"#fdf6e3", bgEnd:"transparent", ios:"#268bd2", android:"#2aa198", web:"#b58900", be:"#6c71c4", qa:"#859900" } },
      "Candy":    { bs:"light", vars:{ bgStart:"#ffe6f2", bgEnd:"transparent", ios:"#ff6fb5", android:"#6fffb0", web:"#ffd166", be:"#f28482", qa:"#a0c4ff" } }
    };

    const DEFAULT_DATA = {
      meta: { version: 20, startDate: "2025-08-13", efficiency: 0.8, theme: "Dark", rtl: false, defaultPxPerDay: 18, effortTypes: DEFAULT_EFFORT_TYPES.map(e=> ({...e})) },
      projects: [{ id: "proj-sample", name: "Sample Project", description: "Generic project" }],
      teamMembers: [
        { id: "member-1", name: "John Doe", specialty: "BE" },
        { id: "member-2", name: "Jane Smith", specialty: "BE" },
        { id: "member-3", name: "Bob Johnson", specialty: "BE" },
        { id: "member-4", name: "Alice Brown", specialty: "iOS" },
        { id: "member-5", name: "Charlie Wilson", specialty: "iOS" },
        { id: "member-6", name: "Diana Davis", specialty: "Android" },
        { id: "member-7", name: "Eve Evans", specialty: "Android" },
        { id: "member-8", name: "Frank Foster", specialty: "Online" },
        { id: "member-9", name: "Grace Green", specialty: "Online" },
        { id: "member-10", name: "Henry Hill", specialty: "QA" },
        { id: "member-11", name: "Ivy Irving", specialty: "QA" },
        { id: "member-12", name: "Jack Jackson", specialty: "QA" },
        { id: "member-13", name: "Kate King", specialty: "BE" },
        { id: "member-14", name: "Liam Lee", specialty: "BE" },
        { id: "member-15", name: "Mia Miller", specialty: "BE" },
        { id: "member-16", name: "Noah Nelson", specialty: "iOS" },
        { id: "member-17", name: "Olivia Olson", specialty: "iOS" },
        { id: "member-18", name: "Paul Parker", specialty: "iOS" },
        { id: "member-19", name: "Quinn Quinn", specialty: "iOS" },
        { id: "member-20", name: "Ruby Rose", specialty: "Android" },
        { id: "member-21", name: "Sam Smith", specialty: "Android" },
        { id: "member-22", name: "Tom Taylor", specialty: "Android" },
        { id: "member-23", name: "Uma Underwood", specialty: "Android" },
        { id: "member-24", name: "Victor Vega", specialty: "Online" },
        { id: "member-25", name: "Wendy White", specialty: "Online" },
        { id: "member-26", name: "Xander Xavier", specialty: "Online" },
        { id: "member-27", name: "Yara Young", specialty: "Online" },
        { id: "member-28", name: "Zoe Zimmerman", specialty: "QA" },
        { id: "member-29", name: "Adam Adams", specialty: "QA" },
        { id: "member-30", name: "Betty Baker", specialty: "QA" },
        { id: "member-31", name: "Carl Carter", specialty: "QA" }
      ],
      teams: [
        { 
          id:"team-base", 
          name:"Base Squad", 
          memberAssignments: [
            { id: "assign-1", memberId: "member-1", startDate: "2025-08-13", endDate: null },
            { id: "assign-2", memberId: "member-2", startDate: "2025-08-13", endDate: null },
            { id: "assign-3", memberId: "member-3", startDate: "2025-08-13", endDate: null },
            { id: "assign-4", memberId: "member-4", startDate: "2025-08-13", endDate: null },
            { id: "assign-5", memberId: "member-5", startDate: "2025-08-13", endDate: null },
            { id: "assign-6", memberId: "member-6", startDate: "2025-08-13", endDate: null },
            { id: "assign-7", memberId: "member-7", startDate: "2025-08-13", endDate: null },
            { id: "assign-8", memberId: "member-8", startDate: "2025-08-13", endDate: null },
            { id: "assign-9", memberId: "member-9", startDate: "2025-08-13", endDate: null },
            { id: "assign-10", memberId: "member-10", startDate: "2025-08-13", endDate: null },
            { id: "assign-11", memberId: "member-11", startDate: "2025-08-13", endDate: null },
            { id: "assign-12", memberId: "member-12", startDate: "2025-08-13", endDate: null },
            // Add some capacity changes for testing
            { id: "assign-13", memberId: "member-13", startDate: "2025-09-15", endDate: null },
            { id: "assign-14", memberId: "member-14", startDate: "2025-09-20", endDate: null },
            { id: "assign-15", memberId: "member-15", startDate: "2025-08-25", endDate: "2025-10-15" }
          ]
        },
        { 
          id:"team-scaled", 
          name:"Scaled Squad", 
          memberAssignments: [
            { id: "assign-16", memberId: "member-13", startDate: "2025-08-13", endDate: null },
            { id: "assign-17", memberId: "member-14", startDate: "2025-08-13", endDate: null },
            { id: "assign-18", memberId: "member-15", startDate: "2025-08-13", endDate: null },
            { id: "assign-19", memberId: "member-16", startDate: "2025-08-13", endDate: null },
            { id: "assign-20", memberId: "member-17", startDate: "2025-08-13", endDate: null },
            { id: "assign-21", memberId: "member-18", startDate: "2025-08-13", endDate: null },
            { id: "assign-22", memberId: "member-19", startDate: "2025-08-13", endDate: null },
            { id: "assign-23", memberId: "member-20", startDate: "2025-08-13", endDate: null },
            { id: "assign-24", memberId: "member-21", startDate: "2025-08-13", endDate: null },
            { id: "assign-25", memberId: "member-22", startDate: "2025-08-13", endDate: null },
            { id: "assign-26", memberId: "member-23", startDate: "2025-08-13", endDate: null },
            { id: "assign-27", memberId: "member-24", startDate: "2025-08-13", endDate: null },
            { id: "assign-28", memberId: "member-25", startDate: "2025-08-13", endDate: null },
            { id: "assign-29", memberId: "member-26", startDate: "2025-08-13", endDate: null },
            { id: "assign-30", memberId: "member-27", startDate: "2025-08-13", endDate: null },
            { id: "assign-31", memberId: "member-28", startDate: "2025-08-13", endDate: null },
            { id: "assign-32", memberId: "member-29", startDate: "2025-08-13", endDate: null },
            { id: "assign-33", memberId: "member-30", startDate: "2025-08-13", endDate: null },
            { id: "assign-34", memberId: "member-31", startDate: "2025-08-13", endDate: null }
          ]
        }
      ],
      phases: [
        { id:"P1", name:"Phase 1", description:"Entry points + Survey/Registration + Dashboard core", order:1, color:"#0d6efd" },
        { id:"P2", name:"Phase 2", description:"Content widgets and partner integration", order:2, color:"#6610f2" },
        { id:"ALL", name:"One-shot", description:"All scope in a single release", order:1, color:"#198754" }
      ],
      proposals: [
        { id:"prop1", projectId:"proj-sample", title:"Two Phases (Base Squad)", description:"Two-phase rollout with base team", teamId:"team-base", bufferPct:12, phaseIds:["P1","P2"], pxPerDay:18, overrides:{} },
        { id:"prop2a", projectId:"proj-sample", title:"Two Phases (Scaled Squad)", description:"Two-phase rollout with scaled team", teamId:"team-scaled", bufferPct:12, phaseIds:["P1","P2"], pxPerDay:18, overrides:{} },
        { id:"prop2b", projectId:"proj-sample", title:"One‑Shot (Scaled Squad)", description:"All scope in one release, scaled team", teamId:"team-scaled", bufferPct:12, phaseIds:["ALL"], pxPerDay:18, overrides:{} }
      ],
      tasks: []
    };

    const seedTasks = [
      "EP1|Dashboard entry tile/banner", "EP2|Accounts/Transactions CTA", "EP3|Notifications/Inbox CTA", "EP4|Settings: feature toggle & consent",
      "SR1|Consent soft-enable & opt-out","SR2|Registration stepper","SR3|Survey engine (CMS-driven)","SR4|Submit survey to BE & success",
      "DB1|Dashboard shell & skeleton","DB2|Monthly CO₂ summary","DB3|Category breakdown chart (CMS colors)","DB4|Trend period switcher (3/6/9/12m)",
      "DB5|Txn badges & details view","DB6|Empty/error/offline states","DB7|i18n/RTL & a11y polish","DB8|Analytics + feature flags",
      "CT1|Recommendations module","CT2|Tips module","CT3|Articles module","CT4|Journal module","CT5|Deals module (if enabled)",
      "LX1|Partner theming & layout adaptation","LX2|Partner release & monitoring",
      "AT1|Cucumber repo & smoke","AT2|Nightly & regression growth"
    ];
    DEFAULT_DATA.tasks = seedTasks.map(s=>{
      const [id, title] = s.split("|");
      const phase = id.startsWith("CT")||id.startsWith("LX")||id==="AT2"?"P2":"P1";
      return {id, title, projectId:"proj-sample", startDate:"", efforts:[], phaseIds:[phase], assignments:[{proposalId:"prop1",phaseId: phase}, {proposalId:"prop2a",phaseId: phase}, {proposalId:"prop2b",phaseId:"ALL"}]};
    });
    DEFAULT_DATA.tasks.push({id:"TBE1", title:"BE: APIs & integration (Phase 1)", projectId:"proj-sample", startDate:"", efforts:[{platform:"BE",manDays:74}], phaseIds:["P1"], assignments:[{proposalId:"prop1",phaseId:"P1"},{proposalId:"prop2a",phaseId:"P1"}]});
    DEFAULT_DATA.tasks.push({id:"TBE2", title:"BE: APIs & integration (Phase 2)", projectId:"proj-sample", startDate:"", efforts:[{platform:"BE",manDays:24}], phaseIds:["P2"], assignments:[{proposalId:"prop1",phaseId:"P2"},{proposalId:"prop2a",phaseId:"P2"}]});
    DEFAULT_DATA.tasks.push({id:"TBE3", title:"BE: APIs & integration (One-shot)", projectId:"proj-sample", startDate:"", efforts:[{platform:"BE",manDays:98}], phaseIds:["ALL"], assignments:[{proposalId:"prop2b",phaseId:"ALL"}]});

    const BASELINE = {
      "prop1": {"P1":{"iOS":70,"Android":57,"Online":52,"QA":30,"BE":0},"P2":{"iOS":37,"Android":30,"Online":28,"QA":30,"BE":0}},
      "prop2a":{"P1":{"iOS":70,"Android":57,"Online":52,"QA":30,"BE":0},"P2":{"iOS":37,"Android":30,"Online":28,"QA":30,"BE":0}},
      "prop2b":{"ALL":{"iOS":107,"Android":87,"Online":80,"QA":60,"BE":0}}
    };
      const FE_IDS = new Set(seedTasks.map(s=> s.split("|")[0]));

      if(!state.projects.length){
        replaceState(structuredClone(DEFAULT_DATA));
        save();
      }

  function seedEffortsFromBaselineGlobal(){
  try{
    const seen = new Set();
    (state.proposals||[]).forEach(plan=>{
      (plan.phaseIds||[]).forEach(phId=>{
        const base = (BASELINE[plan.id]||{})[phId];
        if(!base) return;
        const tasks = getTasksByPhase(plan.projectId, phId);
        if (!tasks || !Array.isArray(tasks)) return;
        const filteredTasks = tasks.filter(t=> FE_IDS.has(t.id));
        const feCount = Math.max(1, filteredTasks.length);
        filteredTasks.forEach(t=>{
          if((t.efforts||[]).length) return;
          if(seen.has(t.id)) return;
          const perType = {};
          effortTypes().forEach(plat=>{
            const val = +(((+base[plat]||0)/feCount).toFixed(1));
            if(val>0) perType[plat]=val;
          });
          t.efforts = Object.entries(perType).map(([platform, manDays])=>({platform, manDays}));
          seen.add(t.id);
        });
      });
    });
  }catch(e){ console.warn('seedEffortsFromBaselineGlobal failed', e); }
}



    /* ---------- State ---------- */
    function toast(msg){ const el=document.getElementById('appToast'); document.getElementById('toastBody').textContent=msg; const t=new bootstrap.Toast(el,{delay:1400}); t.show(); }
    function byId(id){ return document.getElementById(id); }
    function daysBetween(a,b){
      let count = 0;
      const d = new Date(a.getTime());
      while(d < b){
        d.setDate(d.getDate()+1);
        const day = d.getDay();
        if(day !== 0 && day !== 6) count++;
      }
      return count;
    }
    function fmt(d){ return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); }
    function addBusinessDays(d,n){
      const x = new Date(d.getTime());
      if(n >= 0){
        let added = 0;
        while(added < n){
          x.setDate(x.getDate()+1);
          const day = x.getDay();
          if(day !== 0 && day !== 6) added++;
        }
      }else{
        let added = 0;
        while(added > n){
          x.setDate(x.getDate()-1);
          const day = x.getDay();
          if(day !== 0 && day !== 6) added--;
        }
      }
      return x;
    }
    function iso(d){ return d.toISOString().slice(0,10); }
    function escapeHtml(s){
      return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }
    function getProposal(id){ return (state.proposals||[]).find(p=> p.id===id); }
    function slug(s){ return (s||"").replace(/[^A-Za-z0-9]+/g,'_').slice(0,28) || 'Sheet'; }


        // Excel worksheet names must be <= 31 chars. Compose safely.
        function sheetName(base, suffix=""){
          const suf = suffix || "";
          const MAX = 31;
          const safe = String(base||"").replace(/[^A-Za-z0-9]+/g, "_");
          const avail = Math.max(1, MAX - suf.length);
          return (safe.slice(0, avail) + suf) || "Sheet";
        }
        /* ---------- Theme ---------- */
    function fillThemes(){
      const sel1 = byId('themeSelect'), sel2 = byId('gen-theme');
      sel1.innerHTML = sel2.innerHTML = Object.keys(THEMES).map(n=> `<option>${n}</option>`).join('');
      sel1.value = state.meta.theme || "Dark";
      sel2.value = state.meta.theme || "Dark";
    }
    function applyTheme(name){
      const t = THEMES[name] || THEMES.Dark;
      document.documentElement.setAttribute('data-bs-theme', t.bs);
      document.documentElement.style.setProperty('--bg-grad-start', t.vars.bgStart);
      document.documentElement.style.setProperty('--bg-grad-end', t.vars.bgEnd);
      document.documentElement.style.setProperty('--ios', t.vars.ios);
      document.documentElement.style.setProperty('--android', t.vars.android);
      document.documentElement.style.setProperty('--web', t.vars.web);
      document.documentElement.style.setProperty('--be', t.vars.be);
      document.documentElement.style.setProperty('--qa', t.vars.qa);
      byId('themeSelect').value = name;
      byId('gen-theme').value = name;
    }

    /* ---------- Aggregation & Schedule ---------- */

    // Populate per-assignment efforts from BASELINE so calculations come from tasks directly.


    /* ---------- UI: Dashboard ---------- */
    function buildProjects(){
      byId('projectsLayer').innerHTML='';
      byId('plansLayer').style.display='none';
      byId('detail').style.display='none';
      state.projects.forEach(pr=>{
        const plans = state.proposals.filter(p=>p.projectId===pr.id);
        const details = plans.map(pl=>{
          const aggr = aggregate(pl, state.tasks, getTeam);
          const sched = computeSchedule(pl, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
          return `<li>${pl.title}: ${fmt(sched.chartStart)} → ${fmt(sched.chartEnd)}</li>`;
        }).join('');
        const col = document.createElement('div'); col.className='col-12 col-md-6 col-xl-4';
        col.innerHTML = `<div class="card card-hover h-100"><div class="card-body d-flex flex-column gap-2">
          <h5 class="card-title mb-0">${pr.name}</h5>
          <div class="text-secondary small">${pr.description||''}</div>
          ${details ? `<ul class="small mb-0 ps-3">${details}</ul>` : ''}
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="small text-secondary">Plans: <b>${plans.length}</b></div>
            <div class="btn-group">
              <button class="btn btn-outline-primary btn-sm" data-act="open">Open</button>
              <button class="btn btn-outline-secondary btn-sm" data-act="dup"><i class="bi bi-files"></i></button>
            </div>
          </div>
        </div></div>`;
        col.querySelector('[data-act=open]').onclick = ()=> openProject(pr.id);
        col.querySelector('[data-act=dup]').onclick = (e)=>{ e.stopPropagation(); duplicateEntity('project', pr.id); };
        byId('projectsLayer').appendChild(col);
      });
    }
    function openProject(projectId){
      const pr = getProject(projectId); if(!pr) return;
      byId('projectsLayer').innerHTML='';
      byId('plansLayer').style.display='block';
      byId('detail').style.display='none';
      byId('plans-title').textContent = pr.name + " — Delivery Plans";
      const grid = byId('plansGrid'); grid.innerHTML='';
      const plans = state.proposals.filter(p=>p.projectId===projectId);
      plans.forEach(p=> grid.appendChild(planCard(p)));
      byId('btn-back-projects').onclick = ()=> { try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); };
      byId('btn-export-project-pdf').onclick = ()=> exportProjectPDF(projectId);
      byId('btn-export-project-xlsx-basic').onclick = ()=> exportProjectExcel(projectId);
      if(byId('btn-open-efforts')){ byId('btn-open-efforts').onclick = ()=>{ const mm=new bootstrap.Modal(byId('manageModal')); mm.show(); byId('tab-efforts').click(); byId('eff-proj').value = projectId; byId('eff-proj').dispatchEvent(new Event('change')); }; }
    }
    function planCard(p){
      const aggr = aggregate(p, state.tasks, getTeam);
      const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      const keys = effortTypes();
      sched.lanes.forEach(l=>{ if(!l.name) l.name = effortTypeTitle(l.key); if(!l.color) l.color = effortTypeColor(l.key); });
      const totals = Object.fromEntries(keys.map(k=>[k,0]));
      Object.values(aggr.phaseTotals).forEach(pt=>{ keys.forEach(k=>{ totals[k]+=(pt[k]||0); }); });
      keys.forEach(k=> totals[k] = +totals[k].toFixed(1));
      const sumEff = keys.reduce((s,k)=> s+totals[k],0) || 1;
      const seg = Object.fromEntries(keys.map(k=>[k, totals[k]]));
      const startStr = fmt(sched.chartStart), endStr = fmt(sched.chartEnd);
      const phases = p.phaseIds.map(id=> getPhase(id)?.name||id).join(' · ');
      const col = document.createElement('div'); col.className='col-12 col-md-6';
      col.innerHTML = `<div class="card card-hover h-100" data-plan="${p.id}"><div class="card-body d-flex flex-column gap-2">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div><h5 class="card-title mb-0">${p.title}</h5><div class="text-secondary small">${p.description||''}</div></div>
          <div class="text-end">
            <div class="small text-secondary">${startStr} → ${endStr}</div>
            <div class="small">Team: <b>${getTeam(p.teamId)?.name||'—'}</b></div>
            <div class="small">Phases: ${phases}</div>
          </div>
        </div>
        <div class="mini-timeline">
          <div class="mini-phase">
            ${p.phaseIds.map((phId, i)=>`<div class="position-absolute top-0" style="left:${Math.round((i/p.phaseIds.length)*100)}%;height:8px;border-left:1px solid rgba(255,255,255,.35)"><span class="position-absolute top-100 start-0 translate-middle-x" style="font-size:.65rem">${getPhase(phId)?.name||phId}</span></div>`).join('')}
          </div>
          <div class="mini-platforms">
            ${keys.map(k=>`<div class="seg" style="background:${effortTypeColor(k)};flex:${seg[k]}"></div>`).join('')}
          </div>
        </div>
        <div class="row row-cols-${keys.length} g-2 text-center">
            ${keys.map(k=> `<div class="col"><div class="border rounded p-2"><div class="small text-secondary">${effortTypeTitle(k)}</div><div class="fw-bold">${totals[k]}</div><div class="small text-secondary">md</div></div></div>`).join('')}
        </div>
        <div class="d-flex justify-content-end gap-2 mt-2">
          <button class="btn btn-sm btn-outline-secondary" data-act="phase"><i class="bi bi-kanban"></i></button>
          <button class="btn btn-sm btn-outline-secondary" data-act="dup"><i class="bi bi-files"></i></button>
        </div>
        </div></div>`;
        const card = col.querySelector('.card');
        card.onclick = ()=> openDetail(p.id);
        col.querySelector('[data-act=dup]').onclick = (e)=>{ e.stopPropagation(); duplicateEntity('plan', p.id); };
        col.querySelector('[data-act=phase]').onclick = (e)=>{ e.stopPropagation(); const mm=new bootstrap.Modal(byId('manageModal')); mm.show(); byId('tab-phase-tasks').click(); byId('pt-proj').value = p.projectId; byId('pt-proj').dispatchEvent(new Event('change')); };
        return col;
      }

    /* ---------- Detail ---------- */
    let currentPlanId = null;
      function openDetail(planId){
        const p = state.proposals.find(x=>x.id===planId); if(!p) return;
        currentPlanId = planId;
        byId('plansLayer').style.display='none';
        byId('detail').style.display='block';
        
        // Get team for date-aware capacity calculation
        const team = getTeam(p.teamId);
        
        // Create a date-aware team getter function
        const getTeamWithDate = (teamId, targetDate = null) => {
          if (targetDate) {
            return { ...team, sizes: getTeamSizesForDate(team, targetDate) };
          }
          return team;
        };
        
        const aggr = aggregateWithTeamMembers(p, state.tasks, getTeamWithDate);
        const visLanes = (p.lanes||[]).filter(l=> !(p.hiddenLanes||[]).includes(l.key));
        const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate, {lanes:visLanes});
      byId('detail-title').textContent = p.title;
      byId('detail-team').textContent = getTeam(p.teamId)?.name || '—';
      byId('detail-buffer').textContent = p.bufferPct||0;
      const totalDays = Math.max(1, daysBetween(sched.chartStart, addBusinessDays(sched.chartEnd,1)));
      byId('detail-span').textContent = `${fmt(sched.chartStart)} → ${fmt(sched.chartEnd)} • ${totalDays} days`;
      const th = `<tr><th>Phase</th>${effortTypes().map(k=>`<th>${effortTypeTitle(k)}</th>`).join('')}</tr>`;
      byId('effTable').querySelector('thead').innerHTML = th;
      const tb = byId('effTable').querySelector('tbody'); tb.innerHTML = '';
      p.phaseIds.forEach(pid=>{
        const t = aggr.phaseTotals[pid] || {};
        const tr = document.createElement('tr');
        const cells = effortTypes().map(k=>`<td>${(t[k]||0).toFixed(1)}</td>`).join('');
        tr.innerHTML = `<td>${getPhase(pid)?.name||pid}</td>${cells}`;
        tb.appendChild(tr);
      });
      const teamSizes = getTeamSizes(team);
      const tbTeam = byId('teamTable').querySelector('tbody'); tbTeam.innerHTML = '';
      
      // Add team member details
      if (team && team.memberAssignments && team.memberAssignments.length > 0) {
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `<th colspan="4" class="table-info">Team Members (${team.memberAssignments.length})</th>`;
        tbTeam.appendChild(headerRow);
        
        const subHeaderRow = document.createElement('tr');
        subHeaderRow.innerHTML = `
          <th>Member</th>
          <th>Specialty</th>
          <th>Start Date</th>
          <th>End Date</th>
        `;
        tbTeam.appendChild(subHeaderRow);
        
        team.memberAssignments.forEach(assignment => {
          const member = getTeamMember(assignment.memberId);
          if (member) {
            const tr = document.createElement('tr');
            const endDateText = assignment.endDate ? assignment.endDate : 'Ongoing';
            const specialtyColor = effortTypeColor(member.specialty) || '#6c757d';
            tr.innerHTML = `
              <td><i class="bi bi-person-circle"></i> ${escapeHtml(member.name)}</td>
              <td><span class="badge" style="background-color: ${specialtyColor}; color: white;">${member.specialty}</span></td>
              <td><small class="text-muted">${assignment.startDate}</small></td>
              <td><small class="text-muted">${endDateText}</small></td>
            `;
            tbTeam.appendChild(tr);
          }
        });
        
        const separatorRow = document.createElement('tr');
        separatorRow.innerHTML = `<td colspan="4" class="table-light"><hr class="my-1"></td>`;
        tbTeam.appendChild(separatorRow);
      }
      
      // Add capacity summary
      const summaryRow = document.createElement('tr');
      summaryRow.innerHTML = `<th colspan="4" class="table-info">Current Capacity</th>`;
      tbTeam.appendChild(summaryRow);
      
      effortTypes().forEach(k=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${effortTypeTitle(k)}</td><td>${teamSizes[k]||0}</td><td><small class="text-muted">engineers</small></td><td></td>`;
        tbTeam.appendChild(tr);
      });
      
      // Add capacity trend chart
      if (team && team.memberAssignments && team.memberAssignments.length > 0) {
        const chartContainer = document.createElement('div');
        chartContainer.className = 'mt-3';
        chartContainer.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-graph-up"></i> Capacity Trend Over Time</h6>
            </div>
            <div class="card-body">
              <div id="capacity-chart" style="height: 200px; position: relative;"></div>
            </div>
          </div>
        `;
        
        // Insert chart after the table
        const teamTableContainer = byId('teamTable').closest('.table-responsive');
        teamTableContainer.parentNode.insertBefore(chartContainer, teamTableContainer.nextSibling);
        
        // Generate capacity trend data and render chart
        renderCapacityTrendChart(team, sched.chartStart, sched.chartEnd);
      }
      const lf = byId('lane-menu');
      lf.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" id="chkReleases"><label class="form-check-label" for="chkReleases"><span class="badge-lane"><span class="dot" style="background:#6f42c1"></span>Releases</span></label></div>`+
        `<div class="form-check"><input class="form-check-input" type="checkbox" id="chkSprints"><label class="form-check-label" for="chkSprints"><span class="badge-lane"><span class="dot" style="background:#dc3545"></span>Sprints</span></label></div>`+
        (p.lanes||[]).map(l=>
        `<div class="form-check"><input class="form-check-input lane-filter" type="checkbox" value="${l.key}" id="chk${l.key}"><label class="form-check-label" for="chk${l.key}"><span class="badge-lane"><span class="dot" style="background:${l.color||effortTypeColor(l.key)}"></span>${l.name||effortTypeTitle(l.key)}</span></label></div>`
      ).join('');
      lf.querySelectorAll('.lane-filter').forEach(chk=>{
        chk.checked = !(p.hiddenLanes||[]).includes(chk.value);
        chk.onchange = ()=>{
          p.hiddenLanes = Array.from(document.querySelectorAll('#lane-menu .lane-filter'))
            .filter(x=>!x.checked).map(x=>x.value);
          save();
          const vis = (p.lanes||[]).filter(l=> !(p.hiddenLanes||[]).includes(l.key));
          const sched = computeSchedule(p, aggregateWithTeamMembers(p, state.tasks, getTeamWithDate), state.meta.efficiency, getPhase, state.meta.startDate, {lanes:vis});
          drawGantt(p, sched);
          renderPhaseDatesTable(sched);
        };
      });
      const chkRel = byId('chkReleases');
      chkRel.checked = state.meta.showReleaseLane !== false;
      chkRel.onchange = ()=>{
        state.meta.showReleaseLane = chkRel.checked;
        save();
        const vis = (p.lanes||[]).filter(l=> !(p.hiddenLanes||[]).includes(l.key));
        const sched = computeSchedule(p, aggregateWithTeamMembers(p, state.tasks, getTeamWithDate), state.meta.efficiency, getPhase, state.meta.startDate, {lanes:vis});
        drawGantt(p, sched);
        renderPhaseDatesTable(sched);
      };
      const chkSpr = byId('chkSprints');
      chkSpr.checked = state.meta.showSprintLane !== false;
      chkSpr.onchange = ()=>{
        state.meta.showSprintLane = chkSpr.checked;
        save();
        const vis = (p.lanes||[]).filter(l=> !(p.hiddenLanes||[]).includes(l.key));
        const sched = computeSchedule(p, aggregateWithTeamMembers(p, state.tasks, getTeamWithDate), state.meta.efficiency, getPhase, state.meta.startDate, {lanes:vis});
        drawGantt(p, sched);
        renderPhaseDatesTable(sched);
      };
      drawGantt(p, sched);
      renderPhaseDatesTable(sched);
      renderPhaseBreakdownTables(p);
      
      // Initialize collapsible sections
      initializeCollapsibles();
      
      byId('zoomRange').value = p.pxPerDay || state.meta.defaultPxPerDay || 18;
      byId('fontRange').value = p.fontScale || 1;
      byId('btn-back-plans').onclick = ()=> { openProject(p.projectId); };
      byId('btn-export-plan-pdf').onclick = ()=> exportPlanImage(p.id);
      byId('btn-export-plan-xlsx-basic').onclick = ()=> exportPlanExcel(p.id);
    }
    function drawGantt(p, sched){
      const container = byId('ganttContent');
      const scroll = byId('ganttScroll');
      container.innerHTML = '';
      const pxPerDay = p.pxPerDay || state.meta.defaultPxPerDay || 18;
      const totalDays = Math.max(1, daysBetween(sched.chartStart, addBusinessDays(sched.chartEnd,1)));
      function applyFont(){
        const baseFont = Math.max(8, Math.min(16, Math.round(pxPerDay*0.75)));
        scroll.style.fontSize = (baseFont * (p.fontScale||1)) + 'px';
      }
      applyFont();
      const labelPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--label-pad'));
      const width = totalDays * pxPerDay + labelPad;
      const lanesOn = Array.from(document.querySelectorAll('#lane-menu .lane-filter')).filter(x=>x.checked).map(x=>x.value);
      if(state.meta.showReleaseLane !== false && (state.releases||[]).length){
        const lane = document.createElement('div'); lane.className='lane'; lane.style.width = width+'px'; lane.dataset.lane='releases';
        const label = document.createElement('div'); label.className='lane-label'; label.textContent='Releases'; lane.appendChild(label);
        const bars = [];
        (state.releases||[]).forEach(r=>{
          const start = new Date(r.codeFreeze); const end = new Date(r.releaseDate);
          if(end < sched.chartStart || start > sched.chartEnd) return;
          const d0 = Math.max(0, daysBetween(sched.chartStart, start));
          const d1 = daysBetween(sched.chartStart, addBusinessDays(end,1));
          bars.push({start:start.getTime(), end:end.getTime(), d0, d1, rel:r});
        });
        bars.sort((a,b)=>a.start-b.start);
        const trackEnd=[];
        bars.forEach(b=>{ let t=0; while(t<trackEnd.length && b.start<trackEnd[t]) t++; b.track=t; trackEnd[t]=b.end; });
        const trackCount=trackEnd.length||1; const lanePad=4, barHeight=36, step=barHeight*0.5;
        lane.style.height = (lanePad*2 + barHeight + (trackCount-1)*step)+'px';
        bars.forEach(b=>{
          const bar = document.createElement('div'); bar.className='bar release-bar'; bar.textContent = b.rel.version || '';
          bar.style.left = (labelPad + b.d0*pxPerDay)+'px';
          bar.style.width = (Math.max(1, b.d1 - b.d0)*pxPerDay)+'px';
          bar.style.top = (lanePad + b.track*step)+'px';
          bar.style.height = barHeight+'px';
          lane.appendChild(bar);
        });
        container.appendChild(lane);
      }
      if(state.meta.showSprintLane !== false && (state.sprints||[]).length){
        const lane = document.createElement('div'); lane.className='lane'; lane.style.width = width+'px'; lane.dataset.lane='sprints';
        const label = document.createElement('div'); label.className='lane-label'; label.textContent='Sprints'; lane.appendChild(label);
        const bars = [];
        (state.sprints||[]).forEach(s=>{
          const start = new Date(s.start); const end = new Date(s.end);
          if(end < sched.chartStart || start > sched.chartEnd) return;
          const d0 = Math.max(0, daysBetween(sched.chartStart, start));
          const d1 = daysBetween(sched.chartStart, addBusinessDays(end,1));
          bars.push({start:start.getTime(), end:end.getTime(), d0, d1, spr:s});
        });
        bars.sort((a,b)=>a.start-b.start);
        const trackEnd=[];
        bars.forEach(b=>{ let t=0; while(t<trackEnd.length && b.start<trackEnd[t]) t++; b.track=t; trackEnd[t]=b.end; });
        const trackCount=trackEnd.length||1; const lanePad=4, barHeight=36, step=barHeight*0.5;
        lane.style.height = (lanePad*2 + barHeight + (trackCount-1)*step)+'px';
        bars.forEach(b=>{
          const bar = document.createElement('div'); bar.className='bar sprint-bar'; bar.textContent = b.spr.name || '';
          bar.style.left = (labelPad + b.d0*pxPerDay) + 'px';
          bar.style.width = (Math.max(1, b.d1 - b.d0)*pxPerDay) + 'px';
          bar.style.top = (lanePad + b.track*step)+'px';
          bar.style.height = barHeight+'px';
          lane.appendChild(bar);
        });
        container.appendChild(lane);
      }
      {
        const lane = document.createElement('div'); lane.className='lane'; lane.style.width = width+'px'; lane.dataset.lane='phases';
        const label = document.createElement('div'); label.className='lane-label'; label.textContent='Phases'; lane.appendChild(label);
        const bars = [];
        sched.phaseWindows.forEach(w=>{
          const d0 = daysBetween(sched.chartStart, w.start);
          const d1 = daysBetween(sched.chartStart, addBusinessDays(w.end,1));
          bars.push({start:w.start.getTime(), end:w.end.getTime(), d0, d1, ph:w.ph});
        });
        bars.sort((a,b)=>a.start-b.start);
        const trackEnd=[];
        bars.forEach(b=>{ let t=0; while(t<trackEnd.length && b.start<trackEnd[t]) t++; b.track=t; trackEnd[t]=b.end; });
        const trackCount=trackEnd.length||1; const lanePad=4, barHeight=36, step=barHeight*0.5;
        lane.style.height = (lanePad*2 + barHeight + (trackCount-1)*step)+'px';
        bars.forEach(b=>{
          const bar = document.createElement('div'); bar.className='bar phase-bar'; bar.textContent = getPhase(b.ph)?.name || b.ph;
          bar.style.left = (labelPad + b.d0*pxPerDay)+'px';
          // width uses exclusive offset difference so phase bar ends at last effort
          bar.style.width = (Math.max(1, b.d1 - b.d0)*pxPerDay)+'px';
          bar.style.top = (lanePad + b.track*step)+'px';
          bar.style.height = barHeight+'px';
          lane.appendChild(bar);
        });
        container.appendChild(lane);
      }
      sched.lanes.filter(l=> lanesOn.includes(l.key)).forEach(l=>{
        const lane = document.createElement('div'); lane.className='lane'; lane.style.width = width+'px'; lane.dataset.lane=l.key;
        const label = document.createElement('div'); label.className='lane-label'; label.textContent = l.name; lane.appendChild(label);

        const bars = [];
        sched.phaseWindows.forEach(w=>{
          const li = w.lanes.find(x=>x.key===l.key);
          if(!li) return;
          bars.push({ phase: w.ph, info: li });
        });

        const trackEnd = [];
        bars.forEach(b=>{
          const startMs = b.info.start.getTime();
          let t = 0;
          while(t < trackEnd.length && startMs < trackEnd[t]) t++;
          b.track = t;
          trackEnd[t] = addBusinessDays(b.info.start, b.info.days).getTime();
        });

        const lanePad = 4;
        const barHeight = 36;
        const step = barHeight*0.5;
        const trackCount = trackEnd.length || 1;
        lane.style.height = (lanePad*2 + barHeight + (trackCount-1)*step)+'px';

        bars.forEach(b=>{
          const offset = labelPad + daysBetween(sched.chartStart, b.info.start) * pxPerDay;
          const bar = document.createElement('div');
          bar.className = 'bar';
          bar.style.left = offset+'px';
          bar.style.width = (Math.max(1, b.info.days)*pxPerDay)+'px';
          bar.style.background = l.color || effortTypeColor(l.key);
          bar.style.top = (lanePad + b.track*step)+'px';
          bar.textContent = b.phase;
          bar.title = `${l.name} • ${b.phase} • ${fmt(b.info.start)} (${b.info.days}d)`;
          bar.dataset.lane = l.key;
          bar.dataset.phase = b.phase;
          makeDraggableBar(bar, p, sched, b.info.days);
          bar.addEventListener('click', (ev)=>{ ev.stopPropagation(); openBreakdown(p, b.phase, l.key); });
          lane.appendChild(bar);
        });

        container.appendChild(lane);
      });
      drawRulerAndGrid(scroll, sched.chartStart, totalDays, pxPerDay, container.scrollHeight || 0);
      
      // Capacity change indicators on top of affected lanes
      try {
        // Remove any previous capacity indicators
        scroll.querySelectorAll('.capacity-indicator,.capacity-tooltip').forEach(n => n.remove());
        
        // Get the current team from the plan
        const currentTeam = getTeam(p.teamId);
        if (!currentTeam || !currentTeam.memberAssignments) return;
        
        // Find all unique change dates from team member assignments
        const changeDates = new Set();
        currentTeam.memberAssignments.forEach(assignment => {
          if (assignment.startDate) changeDates.add(assignment.startDate);
          if (assignment.endDate) changeDates.add(assignment.endDate);
        });
        
        if (changeDates.size === 0) return;
        
        // Sort dates and filter to only include dates within chart range
        const sortedDates = Array.from(changeDates)
          .map(date => new Date(date))
          .filter(date => date >= sched.chartStart && date <= sched.chartEnd)
          .sort((a, b) => a - b);
        
        if (sortedDates.length === 0) return;
        
        function getCapacityForDate(team, targetDate) {
          if (!team || !team.memberAssignments) return {};
          
          const capacities = {};
          const date = new Date(targetDate);
          
          team.memberAssignments.forEach(assignment => {
            if (assignment.startDate) {
              const member = state.teamMembers.find(m => m.id === assignment.memberId);
              if (member && member.specialty) {
                const startDate = new Date(assignment.startDate);
                const endDate = assignment.endDate ? new Date(assignment.endDate) : null;
                
                // Only count members who are active on the target date
                if (startDate <= date && (!endDate || date < endDate)) {
                  capacities[member.specialty] = (capacities[member.specialty] || 0) + 1;
                }
              }
            }
          });
          
          return capacities;
        }
        
        function describeChange(prev, curr) {
          const keys = new Set([...Object.keys(prev || {}), ...Object.keys(curr || {})]);
          const adds = []; const removes = [];
          keys.forEach(k => {
            const d = (curr[k] || 0) - (prev[k] || 0);
            if (d > 0) adds.push(`${d} ${k} ${d > 1 ? 'Engineers' : 'Engineer'} joining`);
            else if (d < 0) removes.push(`${Math.abs(d)} ${k} ${Math.abs(d) > 1 ? 'Engineers' : 'Engineer'} leaving`);
          });
          const parts = [];
          if (adds.length) parts.push(adds.join(', '));
          if (removes.length) parts.push(removes.join(', '));
          return parts.length ? parts.join(' and ') : 'No net change';
        }
        
        // Create tooltip container
        const tooltip = document.createElement('div');
        tooltip.className = 'capacity-tooltip';
        tooltip.style.position = 'absolute';
        tooltip.style.background = '#1f2937';
        tooltip.style.color = '#fff';
        tooltip.style.border = '1px solid #111827';
        tooltip.style.borderRadius = '.35rem';
        tooltip.style.boxShadow = '0 8px 24px rgba(0,0,0,.25)';
        tooltip.style.padding = '.4rem .6rem';
        tooltip.style.fontSize = '0.78rem';
        tooltip.style.lineHeight = '1.2';
        tooltip.style.zIndex = '10';
        tooltip.style.display = 'none';
        tooltip.style.maxWidth = '300px';
        tooltip.style.whiteSpace = 'nowrap';
        scroll.appendChild(tooltip);
        
        // For each change date, create indicators per affected specialty
        sortedDates.forEach(changeDate => {
          // Get capacity before and after the change
          const dayBefore = addBusinessDays(changeDate, -1);
          const prevCap = getCapacityForDate(currentTeam, dayBefore);
          const currCap = getCapacityForDate(currentTeam, changeDate);
          
          const keys = new Set([...Object.keys(prevCap || {}), ...Object.keys(currCap || {})]);
          const sOff = Math.max(0, daysBetween(sched.chartStart, changeDate));
          const leftPx = labelPad + sOff * pxPerDay;
          
          keys.forEach(k => {
            const d = (currCap[k] || 0) - (prevCap[k] || 0);
            if (d === 0) return; // No change for this specialty
            
            // Find the lane for this specialty
            const laneEl = Array.from(container.querySelectorAll('.lane')).find(el => 
              (el.dataset.lane || '') === k || 
              el.querySelector('.lane-label')?.textContent === k || 
              false
            );
            
            if (!laneEl) return;
            
            // Get lane position and place indicator in the middle of the lane
            const containerRectTop = container.getBoundingClientRect().top;
            const laneRect = laneEl.getBoundingClientRect();
            const laneTop = laneRect.top - containerRectTop;
            const laneHeight = laneRect.height;
            const laneMiddle = laneTop + (laneHeight / 2);
            
            // Create indicator positioned in the middle of the lane
            const indicator = document.createElement('div');
            indicator.className = 'capacity-indicator';
            indicator.style.position = 'absolute';
            indicator.style.left = (leftPx - 6) + 'px';
            indicator.style.top = (laneMiddle - 6) + 'px';
            indicator.style.width = '12px';
            indicator.style.height = '12px';
            indicator.style.borderRadius = '50%';
            indicator.style.background = d > 0 ? '#28a745' : '#dc3545';
            indicator.style.border = '2px solid #fff';
            indicator.style.boxShadow = '0 2px 4px rgba(0,0,0,.3)';
            indicator.style.cursor = 'pointer';
            indicator.style.zIndex = '5';
            indicator.title = `${Math.abs(d)} ${k} ${Math.abs(d) > 1 ? 'Engineers' : 'Engineer'} ${d > 0 ? 'joining' : 'leaving'}`;
            
            // Add click event for tooltip
            indicator.addEventListener('click', (e) => {
              e.stopPropagation();
              const changeDesc = describeChange(prevCap, currCap);
              tooltip.textContent = changeDesc;
              
              // Position tooltip above the indicator, ensuring it's visible
              const tooltipWidth = 300; // Approximate tooltip width
              const scrollWidth = scroll.scrollWidth || container.scrollWidth || 0;
              let tooltipLeft = leftPx + 8;
              
              // Adjust if tooltip would go off the right edge
              if (tooltipLeft + tooltipWidth > scrollWidth) {
                tooltipLeft = Math.max(8, leftPx - tooltipWidth - 8);
              }
              
              tooltip.style.left = tooltipLeft + 'px';
              tooltip.style.top = (laneMiddle - 40) + 'px';
              tooltip.style.display = 'block';
            });
            
            scroll.appendChild(indicator);
          });
        });
        
        // Hide tooltip on background click
        scroll.addEventListener('click', () => { tooltip.style.display = 'none'; });
      } catch (e) { /* non-fatal */ }
      
      const zr = byId('zoomRange'), zm = byId('zoomMinus'), zp = byId('zoomPlus'), zf = byId('zoomFit');
      const fr = byId('fontRange'), fm = byId('fontMinus'), fp = byId('fontPlus');
      zr.oninput = (e)=>{ p.pxPerDay = +e.target.value; save(); openDetail(p.id); };
      zm.onclick = ()=>{ p.pxPerDay = Math.max(6, (p.pxPerDay||pxPerDay)-2); save(); openDetail(p.id); };
      zp.onclick = ()=>{ p.pxPerDay = Math.min(44, (p.pxPerDay||pxPerDay)+2); save(); openDetail(p.id); };
      zf.onclick = ()=>{
        const visible = byId('ganttScroll').clientWidth - labelPad - 20;
        const fit = Math.max(6, Math.min(44, Math.floor(visible/totalDays)));
        p.pxPerDay = fit; save(); openDetail(p.id);
      };
      fr.oninput = (e)=>{ p.fontScale = +e.target.value; save(); applyFont(); };
      fm.onclick = ()=>{ fr.value = Math.max(0.5, (+fr.value - 0.1)).toFixed(1); fr.dispatchEvent(new Event('input')); };
      fp.onclick = ()=>{ fr.value = Math.min(2, (+fr.value + 0.1)).toFixed(1); fr.dispatchEvent(new Event('input')); };
      let isDown=false, startX=0, scrollLeft=0;
      scroll.addEventListener('mousedown', e=>{ if(e.target.classList.contains('bar')) return; isDown=true; startX=e.pageX - scroll.offsetLeft; scrollLeft=scroll.scrollLeft; });
      window.addEventListener('mouseup', ()=> isDown=false);
      scroll.addEventListener('mousemove', e=>{ if(!isDown) return; e.preventDefault(); const x=e.pageX - scroll.offsetLeft; const walk=(x-startX)*1.2; scroll.scrollLeft = scrollLeft - walk; });
    }
    function drawRulerAndGrid(scroll, chartStart, totalDays, pxPerDay, contentHeight){
      scroll.querySelectorAll('.ruler,.grid,.hover-line,.hover-label').forEach(n=> n.remove());
      const labelPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--label-pad'));
      const ruler = document.createElement('div'); ruler.className='ruler'; ruler.style.width = (totalDays*pxPerDay) + 'px';
      scroll.appendChild(ruler);
      const minLabelPx = 15;
      const dayStep = Math.max(1, Math.ceil(minLabelPx/pxPerDay));
      for(let d=0; d<=totalDays; d++){
        const x = d*pxPerDay;
        const tick = document.createElement('div'); tick.className='tick'; tick.style.left = x+'px'; ruler.appendChild(tick);
        if(d % dayStep === 0){
          const label = document.createElement('div'); label.className='label'; label.style.left = x+'px';
          const dt = addBusinessDays(chartStart, d); label.textContent = dt.getDate();
          ruler.appendChild(label);
        }
      }
      const monthRanges = [];
      let rangeStart = 0;
      let rangeDate = new Date(chartStart);
      for(let d=0; d<=totalDays; d++){
        const dt = addBusinessDays(chartStart, d);
        if(dt.getMonth() !== rangeDate.getMonth() || dt.getFullYear() !== rangeDate.getFullYear()){
          monthRanges.push({start:rangeStart, end:d-1, label:rangeDate.toLocaleDateString('en-GB',{month:'short', year:'numeric'})});
          rangeStart = d;
          rangeDate = dt;
        }
      }
      monthRanges.push({start:rangeStart, end:totalDays, label:rangeDate.toLocaleDateString('en-GB',{month:'short', year:'numeric'})});
      monthRanges.forEach(r=>{
        const ms = document.createElement('div');
        ms.className='month-section';
        ms.style.left = (r.start*pxPerDay)+'px';
        ms.style.width = ((r.end - r.start + 1)*pxPerDay)+'px';
        ms.textContent = r.label;
        ruler.appendChild(ms);
      });
      const grid = document.createElement('div'); grid.className='grid'; grid.style.width = (totalDays*pxPerDay + labelPad) + 'px'; grid.style.height = (contentHeight - 60) + 'px'; scroll.appendChild(grid);
      for(let d=0; d<=totalDays; d++){
        const x = labelPad + d*pxPerDay;
        const gl = document.createElement('div'); gl.className='gridline';
        const dt = addBusinessDays(chartStart, d);
        if(dt.getDay() === 1) gl.classList.add('week');
        gl.style.left = x+'px';
        grid.appendChild(gl);
      }
      monthRanges.slice(1).forEach(r=>{
        const x = labelPad + r.start*pxPerDay;
        const gl = document.createElement('div'); gl.className='gridline major'; gl.style.left = x+'px'; grid.appendChild(gl);
      });
      const hoverLine = document.createElement('div'); hoverLine.className='hover-line'; scroll.appendChild(hoverLine);
      const hoverLabel = document.createElement('div'); hoverLabel.className='hover-label'; ruler.appendChild(hoverLabel);
      function handleHover(e){
        const rect = scroll.getBoundingClientRect();
        const x = e.clientX - rect.left + scroll.scrollLeft;
        if(x < labelPad || x > labelPad + totalDays*pxPerDay){ hoverLine.style.display='none'; hoverLabel.style.display='none'; return; }
        hoverLine.style.display='block'; hoverLabel.style.display='block';
        hoverLine.style.left = x+'px'; hoverLabel.style.left = (x - labelPad)+'px';
        const d = Math.floor((x - labelPad)/pxPerDay);
        const dt = addBusinessDays(chartStart, d);
        hoverLabel.textContent = dt.toLocaleDateString('en-GB',{day:'2-digit', month:'short', year:'numeric'});
      }
      function hideHover(){ hoverLine.style.display='none'; hoverLabel.style.display='none'; }
      if(scroll._hoverHandler){ scroll.removeEventListener('mousemove', scroll._hoverHandler); scroll.removeEventListener('mouseleave', scroll._hoverLeave); }
      scroll._hoverHandler = handleHover; scroll._hoverLeave = hideHover;
      scroll.addEventListener('mousemove', handleHover);
      scroll.addEventListener('mouseleave', hideHover);
    }
          function makeDraggableBar(bar, plan, sched, daysLen){
        let startX=0, origLeft=0, dragging=false;
        bar.addEventListener('mousedown', (e)=>{ dragging=true; startX=e.pageX; origLeft=parseInt(bar.style.left); document.body.style.userSelect='none'; });
        window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx = e.pageX - startX; bar.style.left = (origLeft + dx) + 'px'; });
        window.addEventListener('mouseup', ()=>{
          if(!dragging) return; dragging=false; document.body.style.userSelect='';
          const labelPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--label-pad'));
          const left = parseInt(bar.style.left);
          const offsetPx = left - labelPad;
          const days = Math.round(offsetPx / (plan.pxPerDay||state.meta.defaultPxPerDay||18));
          const newDate = addBusinessDays(sched.chartStart, days);
          
          // Update plan overrides
          plan.overrides ||= {}; 
          plan.overrides[bar.dataset.phase] ||= {}; 
          plan.overrides[bar.dataset.phase][bar.dataset.lane] = iso(newDate);
          
          // Save and recalculate with capacity-aware scheduling
          save();
          
          // Recalculate the schedule considering capacity changes
          const aggr = aggregateWithTeamMembers(plan, state.tasks, getTeamWithDate);
          const newSched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
          
          // Redraw the chart with the new schedule
          drawGantt(plan, newSched);
          
          // Update related tables
          renderPhaseDatesTable(newSched);
          renderPhaseBreakdownTables(plan);
          
          // Show toast notification
          const specialty = bar.dataset.lane;
          const phaseName = getPhase(bar.dataset.phase)?.name || bar.dataset.phase;
          const oldStartDate = sched.phaseWindows.find(w => w.ph === bar.dataset.phase)?.lanes.find(l => l.key === specialty)?.start;
          const oldDateText = oldStartDate ? oldStartDate.toLocaleDateString() : 'original date';
          
          showToast(
            `${specialty} work in ${phaseName} rescheduled from ${oldDateText} to ${newDate.toLocaleDateString()}`,
            'success'
          );
        });
      }
    function renderPhaseDatesTable(sched){
      const lanes = sched.lanes;
      const thead = byId('phaseDatesTable').querySelector('thead');
      const tbody = byId('phaseDatesTable').querySelector('tbody');
      thead.innerHTML =
        `<tr><th rowspan="2">Phase</th><th colspan="2">Phase</th>${lanes.map(l=>`<th colspan="2">${l.name||l.key}</th>`).join('')}</tr>`+
        `<tr><th>Start</th><th>End</th>${lanes.map(()=>'<th>Start</th><th>End</th>').join('')}</tr>`;
      tbody.innerHTML = '';
      sched.phaseWindows.forEach(w=>{
        let row = `<th scope="row">${getPhase(w.ph)?.name||w.ph}</th><td>${fmt(w.start)}</td><td>${fmt(w.end)}</td>`;
        lanes.forEach(l=>{
          const li = w.lanes.find(x=> x.key===l.key);
          if(li){
            const le = addBusinessDays(li.start, Math.max(1, li.days) - 1);
            row += `<td>${fmt(li.start)}</td><td>${fmt(le)}</td>`;
          }else{
            row += '<td></td><td></td>';
          }
        });
        const tr = document.createElement('tr');
        tr.innerHTML = row;
        tbody.appendChild(tr);
      });
    }

    /* ---------- Breakdown ---------- */


    function computeTaskEffortsForPhase(plan, phaseId){
      const tasks = getTasksByPhase(plan.projectId, phaseId);
      if (!tasks || !Array.isArray(tasks)) return {rows: [], totals: Object.fromEntries(effortTypes().map(k=>[k,0]))};
      const rows = [];
      const totals = Object.fromEntries(effortTypes().map(k=>[k,0])); totals.total=0;
      tasks.forEach(t=>{
        const eff = Object.fromEntries(effortTypes().map(k=>[k,0]));
        (t.efforts||[]).forEach(e=>{ if(e.platform in eff){ eff[e.platform] += (+e.manDays||0); } });
        const sum = effortTypes().reduce((s,k)=> s+eff[k],0);
        const row = { id:t.id, title:t.title };
        effortTypes().forEach(k=> row[k] = +eff[k].toFixed(1));
        row.total = +sum.toFixed(1);
        rows.push(row);
        effortTypes().forEach(k=> totals[k] += eff[k]);
        totals.total += sum;
      });
      effortTypes().forEach(k=> totals[k] = +totals[k].toFixed(1));
      totals.total = +totals.total.toFixed(1);
      return {rows, totals};
    }

    function renderPhaseBreakdownTables(plan){
      const acc = byId('phaseBreakdown'); acc.innerHTML='';
      plan.phaseIds.forEach((phId, idx)=>{
        const ph = getPhase(phId);
        const aggr = aggregate(plan, state.tasks, getTeam);
        const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
        const win = sched.phaseWindows.find(w=> w.ph===phId);
        const span = win ? `${fmt(win.start)} → ${fmt(win.end)} (${daysBetween(win.start, win.end)+1} days)` : '';
        const data = computeTaskEffortsForPhase(plan, phId);
        const item = document.createElement('div'); item.className='accordion-item';
        item.innerHTML = `
          <h2 class="accordion-header">
            <button class="accordion-button ${idx>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${phId}">
              ${ph?.name||phId} — <span class="ms-1 text-secondary small">${span}</span>
            </button>
          </h2>
          <div id="collapse-${phId}" class="accordion-collapse collapse ${idx===0?'show':''}">
            <div class="accordion-body">
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                  <thead class="table-dark">
                    <tr><th style="width:10%">Task</th><th>Title</th>${effortTypes().map(t=>`<th style=\"width:10%;text-align:right\">${effortTypeTitle(t)}</th>`).join('')}<th style="width:10%;text-align:right">Total</th></tr>
                  </thead>
                  <tbody>
                    ${data.rows.map(r=> `<tr><td><code>${r.id}</code></td><td>${escapeHtml(r.title)}</td>${effortTypes().map(t=>`<td style=\"text-align:right\">${r[t].toFixed(1)}</td>`).join('')}<td style="text-align:right">${r.total.toFixed(1)}</td></tr>`).join('')}
                  </tbody>
                  <tfoot>
                    <tr class="table-secondary"><th colspan="2" class="text-end">Phase totals</th>${effortTypes().map(t=>`<th style=\"text-align:right\">${data.totals[t].toFixed(1)}</th>`).join('')}<th style="text-align:right">${data.totals.total.toFixed(1)}</th></tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>`;

        // Deliverable Scope (Viable Product)
        const scopeCard = document.createElement('div'); scopeCard.className='pdf-card mt-3';
        const sHead = document.createElement('div'); sHead.className='pdf-h3'; sHead.textContent = 'Deliverable Scope (Viable Product)';
        scopeCard.appendChild(sHead);
        const sTable = document.createElement('table'); sTable.className='table table-sm table-bordered'; sTable.style.width='100%';
        sTable.innerHTML = `<thead class="table-light"><tr><th style="width:12%">Task</th><th>Title</th></tr></thead><tbody></tbody>`;
        const sBody = sTable.querySelector('tbody');
          const tasks = getTasksByPhase(plan.projectId, phId);
          if (tasks && Array.isArray(tasks)) {
            tasks.filter(t=> t.viableProduct).forEach(t=>{
              const tr=document.createElement('tr'); tr.innerHTML = `<td><code>${t.id}</code></td><td>${escapeHtml(t.title)}</td>`; sBody.appendChild(tr);
            });
          }
        scopeCard.appendChild(sTable);
        item.querySelector('.accordion-body').appendChild(scopeCard);

        acc.appendChild(item);
      });
    }

    /* ---------- Chart capture helpers ---------- */

    async function capturePlanChartImage(plan){
      const aggr = aggregate(plan, state.tasks, getTeam);
      const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      // A4 landscape content width ~1100px; respect padding used in .pdf-sheet (24px)
      const pageWidth = 1100 - 2*24;
      const labelPad = 140;
      const totalDays = Math.max(1, daysBetween(sched.chartStart, addBusinessDays(sched.chartEnd,1)));
      const pxPerDay = Math.max(3, Math.floor((pageWidth - labelPad) / totalDays));
      const width = totalDays * pxPerDay + labelPad;
      const wrap = document.createElement('div');
      wrap.style.position='relative'; wrap.style.width = width+'px';
      wrap.style.border='1px solid #333';
      wrap.style.padding='0'; wrap.style.height = (plan.phaseIds.length*28 + 36)+'px';
      // vertical lines at week boundaries (Mondays)
      for(let d=0; d<totalDays; d++){
        const dt = addBusinessDays(sched.chartStart, d);
        if(dt.getDay() === 1){
          const x = labelPad + d*pxPerDay;
          const v = document.createElement('div'); v.style.position='absolute'; v.style.left=x+'px'; v.style.top='0'; v.style.bottom='0'; v.style.width='0'; v.style.borderLeft='1px dashed rgba(127,127,127,.5)';
          wrap.appendChild(v);
        }
      }
      // y rows
      plan.phaseIds.forEach((phId)=>{
        const row = document.createElement('div'); row.style.position='relative'; row.style.height='28px'; row.style.borderTop='1px solid #333';
        const label = document.createElement('div'); label.textContent = getPhase(phId)?.name||phId; label.style.position='absolute'; label.style.left='8px'; label.style.top='4px'; label.style.width=(labelPad-16)+'px'; label.style.whiteSpace='nowrap'; label.style.overflow='hidden'; label.style.textOverflow='ellipsis';
        row.appendChild(label);
        const seg = (sched.phaseWindows||[]).find(w => w.ph === phId);
        if(seg){
          const left = daysBetween(sched.chartStart, seg.start) * pxPerDay;
          const segDays = Math.max(1, daysBetween(seg.start, addBusinessDays(seg.end,1)));
          const w = segDays * pxPerDay;
          const bar = document.createElement('div');
          bar.style.position='absolute'; bar.style.left = (labelPad + left)+'px'; bar.style.top='3px'; bar.style.height='22px'; bar.style.width = w+'px';
          bar.style.background='#4f46e5';
          wrap.appendChild(bar);
        }
        wrap.appendChild(row);
      });
      // place chart off-screen so it doesn't flash but remains renderable
      wrap.style.position='fixed';
      wrap.style.left='-10000px';
      wrap.style.top='0';
      document.body.appendChild(wrap);
      let dataUrl;
      try{
        dataUrl = await htmlToImage.toPng(wrap, {pixelRatio:2});
      }catch(e){
        console.warn('html-to-image failed', e);
      }
      document.body.removeChild(wrap);
      return dataUrl;
    }

    async function buildStaticTimelineNode(plan){
      const dataUrl = await capturePlanChartImage(plan);
      const card = document.createElement('div'); card.className='pdf-card';
      const head = document.createElement('div'); head.className='pdf-h3'; head.textContent='Mini Gantt'; card.appendChild(head);
      const img = document.createElement('img'); img.src = dataUrl || ''; img.style.width='100%'; card.appendChild(img);
      return card;
    }

    async function buildPlanBreakdownNode(plan){
      const node = document.createElement('div');
      const title = document.createElement('div'); title.className='pdf-h2'; title.textContent = plan.title;
      const meta = document.createElement('div'); meta.className='pdf-meta';
      const aggr = aggregate(plan, state.tasks, getTeam); const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      meta.textContent = `Team: ${getTeam(plan.teamId)?.name||'—'} • Buffer ${plan.bufferPct||0}% • ${fmt(sched.chartStart)} → ${fmt(sched.chartEnd)}`;
      node.appendChild(title); node.appendChild(meta);
      node.appendChild(await buildStaticTimelineNode(plan));
      plan.phaseIds.forEach(phId=>{
        const ph = getPhase(phId);
        const data = computeTaskEffortsForPhase(plan, phId);
        const card = document.createElement('div'); card.className='pdf-card';
        const head = document.createElement('div'); head.className='pdf-h3'; head.textContent = `Phase: ${ph?.name||phId}`; card.appendChild(head);
        const tbl = document.createElement('table'); tbl.style.width='100%'; tbl.className='table table-sm table-bordered';
        const ths = effortTypes().map(t=>`<th style=\"width:10%;text-align:right\">${effortTypeTitle(t)}</th>`).join('');
        tbl.innerHTML = `<thead class=\"table-light\"><tr><th style=\"width:10%\">Task</th><th>Title</th>${ths}<th style=\"width:10%;text-align:right\">Total</th></tr></thead><tbody></tbody>`;
        const tb = tbl.querySelector('tbody');
        data.rows.forEach(r=>{
          const cells = effortTypes().map(t=>`<td style=\"text-align:right\">${r[t].toFixed(1)}</td>`).join('');
          const tr=document.createElement('tr');
          tr.innerHTML = `<td><code>${escapeHtml(r.id)}</code></td><td>${escapeHtml(r.title)}</td>${cells}<td style=\"text-align:right\">${r.total.toFixed(1)}</td>`;
          tb.appendChild(tr);
        });
        const totalsCells = effortTypes().map(t=>`<th style=\"text-align:right\">${data.totals[t].toFixed(1)}</th>`).join('');
        const tf = document.createElement('tfoot'); tf.innerHTML = `<tr class=\"table-secondary\"><th colspan=\"2\" class=\"text-end\">Phase totals</th>${totalsCells}<th style=\"text-align:right\">${data.totals.total.toFixed(1)}</th></tr>`;
        tbl.appendChild(tf);
        card.appendChild(tbl);
        node.appendChild(card);
      });
      return node;
    }
    async function exportProjectPDF(projectId){
      const pr = getProject(projectId); if(!pr) return;
      const container = document.createElement('div'); container.className='pdf-sheet';
      const h1 = document.createElement('div'); h1.className='pdf-h1'; h1.textContent = `Project: ${pr.name}`;
      const meta = document.createElement('div'); meta.className='pdf-meta'; meta.textContent = `${new Date().toLocaleString()} • Start ${state.meta.startDate} • Efficiency ${state.meta.efficiency} md/eng/day`;
      container.appendChild(h1); container.appendChild(meta);
      for(const p of state.proposals.filter(p=>p.projectId===projectId)){
        const block = await buildPlanBreakdownNode(p);
        container.appendChild(block);
      }
      const opt = { margin: 10, filename: `${pr.name.replace(/\s+/g,'_')}.pdf`, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['css','legacy'] } };
      await html2pdf().from(container).set(opt).save();
    }

    async function exportPlanPDF(planId){
      const p = state.proposals.find(x=>x.id===planId); if(!p) return;
      const container = document.createElement('div'); container.className='pdf-sheet';
      const h1 = document.createElement('div'); h1.className='pdf-h1'; h1.textContent = `Delivery Plan: ${p.title}`;
      const pr = getProject(p.projectId);
      const meta = document.createElement('div'); meta.className='pdf-meta'; meta.textContent = `Project: ${pr?.name||'—'} • Team: ${getTeam(p.teamId)?.name||'—'} • Phases: ${p.phaseIds.map(id=> getPhase(id)?.name||id).join(' · ')}`;
      container.appendChild(h1); container.appendChild(meta);
      container.appendChild(await buildPlanBreakdownNode(p));
      try{
        if(typeof html2pdf === 'function'){
          const opt = { margin: 10, filename: `Plan_${slug(p.title)}.pdf`, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['css','legacy'] } };
          await html2pdf().from(container).set(opt).save();
          return;
        }
      }catch(e){ console.warn('html2pdf failed, falling back to print', e); }
      // Fallback: open print window
      const w = window.open('', '_blank');
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Plan PDF</title>
        <style>
          @page { size: A4 landscape; margin: 10mm; }
          body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;color:#111;background:#fff;}
          .pdf-sheet{padding:0; margin:0;}
        </style></head><body></body></html>`);
      w.document.body.appendChild(container);
      setTimeout(()=>{ w.focus(); w.print(); }, 250);
    }

    async function exportPlanImage(planId){
      const p = state.proposals.find(x=>x.id===planId); if(!p) return;
      const dataUrl = await capturePlanChartImage(p);
      if(!dataUrl){ console.warn('capture failed'); return; }
      window.open(dataUrl, '_blank');
    }


    /* ---------- Basic Excel Export (SheetJS) ---------- */
    async function exportProjectExcel(projectId){
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const wb = XLSX.utils.book_new();
      const pr = getProject(projectId);
      const sheet = [["Project", pr?.name||"—"], ["Generated", new Date().toLocaleString()], [""], ["Plan","Team","Phases","Buffer%","Start","End", ...effortTypes().map(k=>effortTypeTitle(k))]];
      state.proposals.filter(p=>p.projectId===projectId).forEach(p=>{
        // Get team for date-aware capacity calculation
        const team = getTeam(p.teamId);
        const getTeamWithDate = (teamId, targetDate = null) => {
          if (targetDate) {
            return { ...team, sizes: getTeamSizesForDate(team, targetDate) };
          }
          return team;
        };
        
        const aggr = aggregateWithTeamMembers(p, state.tasks, getTeamWithDate);
        const visLanes = (p.lanes||[]).filter(l=> !(p.hiddenLanes||[]).includes(l.key));
        const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate, {lanes:visLanes});
        const totals = Object.fromEntries(effortTypes().map(k=>[k,0]));
        Object.values(aggr.phaseTotals).forEach(pt=>{ effortTypes().forEach(k=> totals[k]+= (pt[k]||0)); });
        sheet.push([p.title, getTeam(p.teamId)?.name||"—", p.phaseIds.map(id=>getPhase(id)?.name||id).join(" / "), p.bufferPct||0, sched.chartStart.toISOString().slice(0,10), sched.chartEnd.toISOString().slice(0,10), ...effortTypes().map(k=> totals[k])]);
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet), "Summary");
      state.proposals.filter(p=>p.projectId===projectId).forEach(p=> buildPlanSheetsForExcelBasic(wb,p));
      XLSX.writeFile(wb, (pr?.name||"Project")+"_Delivery.xlsx");
    }
    async function exportPlanExcel(planId){
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const wb = XLSX.utils.book_new();
      const p = state.proposals.find(x=>x.id===planId);
      buildPlanSheetsForExcelBasic(wb, p);
      XLSX.writeFile(wb, (p?.title||"Plan")+"_Delivery.xlsx");
    }
    function buildPlanSheetsForExcelBasic(wb, plan){
      // Get team for date-aware capacity calculation
      const team = getTeam(plan.teamId);
      const getTeamWithDate = (teamId, targetDate = null) => {
        if (targetDate) {
          return { ...team, sizes: getTeamSizesForDate(team, targetDate) };
        }
        return team;
      };
      
      const aggr = aggregateWithTeamMembers(plan, state.tasks, getTeamWithDate);
      const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      const overview = [
        ["Delivery Plan", plan.title],
        ["Project", getProject(plan.projectId)?.name||"—"],
        ["Team", getTeam(plan.teamId)?.name||"—"],
        ["Buffer %", plan.bufferPct||0],
        ["Schedule", fmt(sched.chartStart)+" → "+fmt(sched.chartEnd)],
        [""],
        ["Phase", ...effortTypes().map(k=>effortTypeTitle(k))]
      ];
      plan.phaseIds.forEach(pid=>{
        const t = aggr.phaseTotals[pid]||{};
        overview.push([getPhase(pid)?.name||pid, ...effortTypes().map(k=> t[k]||0)]);
      });
      const sh_over = XLSX.utils.aoa_to_sheet(overview);
      XLSX.utils.book_append_sheet(wb, sh_over, sheetName(plan.title,"_Overview"));
      const rows = [["Phase","Task ID","Title", ...effortTypes().map(k=>effortTypeTitle(k)), "Total"]];
      plan.phaseIds.forEach(pid=>{
        const data = computeTaskEffortsForPhase(plan, pid);
        data.rows.forEach(r=> rows.push([getPhase(pid)?.name||pid, r.id, r.title, ...effortTypes().map(k=> r[k]), r.total]));
        rows.push(["Phase totals","","", ...effortTypes().map(k=> data.totals[k]), data.totals.total]);
        rows.push([""]);
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), sheetName(plan.title,"_Tasks"));
      const totalDays = Math.max(1, daysBetween(sched.chartStart, addBusinessDays(sched.chartEnd,1)));
      const header = ["Lane","Phase","Start","Days"];
      for(let d=0; d<totalDays; d++){
        const dt = addBusinessDays(sched.chartStart, d);
        header.push(dt.toISOString().slice(0,10));
      }
      const ganttRows = [header];
      sched.phaseWindows.forEach(w=>{
        w.lanes.forEach(li=>{
          const row = [li.key, w.ph, li.start.toISOString().slice(0,10), li.days];
          const startIdx = Math.max(0, daysBetween(sched.chartStart, li.start));
          for(let i=0;i<totalDays;i++){
            row.push(i>=startIdx && i<startIdx+li.days ? "■" : "");
          }
          ganttRows.push(row);
        });
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ganttRows), sheetName(plan.title,"_Gantt"));
    }

    /* ---------- Styled Excel Export (XlsxPopulate + Chart.js) ---------- */
    function platColorHex(role){
      const c = effortTypeColor(role) || '#888';
      return c.startsWith('#') ? c : ('#'+c);
    }
    async function exportProjectExcelStyled(projectId){
      if(!await ensureXPOP()){ alert("Could not load XlsxPopulate."); return; }
      const pr = getProject(projectId); const plans = state.proposals.filter(p=>p.projectId===projectId);
      const wb = await XlsxPopulate.fromBlankAsync();
      const sum = wb.sheet(0); sum.name("Summary");
      // Header
      sum.cell("A1").value("Project").style({bold:true, fill:"FFE699"});
      sum.cell("B1").value(pr?.name||"—").style({bold:true});
      sum.cell("A2").value("Generated").style({bold:true, fill:"FFE699"});
      sum.cell("B2").value(new Date()).style({numberFormat:"yyyy-mm-dd hh:mm"});
      sum.range("A1:B2").style({border:true});
      // Table header
      const header = ["Plan","Team","Phases","Buffer%","Start","End", ...effortTypes().map(k=>effortTypeTitle(k)), "Total"];
      sum.cell("A4").value([header]).style({bold:true, fill:"FFD966", border:true});
      let r=5;
      const totalsAll = Object.fromEntries(effortTypes().map(k=>[k,0]));
      for(const p of plans){
        const aggr = aggregate(p, state.tasks, getTeam);
        const visLanes = (p.lanes||[]).filter(l=> !(p.hiddenLanes||[]).includes(l.key));
        const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate, {lanes:visLanes});
        const totals = Object.fromEntries(effortTypes().map(k=>[k,0]));
        Object.values(aggr.phaseTotals).forEach(pt=>{ effortTypes().forEach(k=> totals[k]+=(pt[k]||0)); });
        effortTypes().forEach(k=> totalsAll[k]+=totals[k]);
        const row = [p.title, getTeam(p.teamId)?.name||"—", p.phaseIds.map(id=>getPhase(id)?.name||id).join(" / "), p.bufferPct||0, sched.chartStart, sched.chartEnd, ...effortTypes().map(k=> totals[k]), effortTypes().reduce((s,k)=> s+totals[k],0)];
        sum.cell("A"+r).value([row]).style({border:true});
        sum.cell("E"+r).style({numberFormat:"yyyy-mm-dd"});
        sum.cell("F"+r).style({numberFormat:"yyyy-mm-dd"});
        r++;
      }
      sum.column("A").width(32); sum.column("B").width(20); sum.column("C").width(30);
      for(let i=0;i<header.length-3;i++){ const col=String.fromCharCode('D'.charCodeAt(0)+i); sum.column(col).width(14); }
      // Add a simple summary chart as image (optional)
      try{
        if(await ensureCHART()){
          const canvas = document.createElement('canvas'); canvas.width=900; canvas.height=360;
          const ctx = canvas.getContext('2d');
          const keys = effortTypes();
          const labels = keys.map(k=> effortTypeTitle(k));
          const data = keys.map(k=> totalsAll[k]);
          const colors = keys.map(k=> effortTypeColor(k));
          new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Man-days', data, backgroundColor: colors }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#222'}}, y:{ticks:{color:'#222'}}} } });
          const png = canvas.toDataURL("image/png");
          const imgId = wb.addImage({ base64: png });
          sum.addImage(imgId, { tl: { col: 0, row: 0 }, ext: { width: 880, height: 280 }, br: { col: 8, row: 15 } });
        }
      }catch(e){ /* ignore if chart embedding not supported */ }
      // Per-plan sheets
      for(const p of plans){ await buildPlanSheetsStyled(wb, p); }
      const blob = await wb.outputAsync();
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(pr?.name||"Project")+"_Delivery_Styled.xlsx"; a.click(); URL.revokeObjectURL(a.href);
    }
    async function exportPlanExcelStyled(planId){
      if(!await ensureXPOP()){ alert("Could not load XlsxPopulate."); return; }
      const p = state.proposals.find(x=>x.id===planId); const wb = await XlsxPopulate.fromBlankAsync();
      await buildPlanSheetsStyled(wb, p);
      const blob = await wb.outputAsync();
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(p?.title||"Plan")+"_Delivery_Styled.xlsx"; a.click(); URL.revokeObjectURL(a.href);
    }
    async function buildPlanSheetsStyled(wb, plan){
      const aggr = aggregate(plan, state.tasks, getTeam);
      const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      // Overview
      const shO = wb.addSheet(sheetName(plan.title,"_Overview"));
      shO.cell("A1").value("Delivery Plan").style({bold:true, fill:"FFE699"});
      shO.cell("B1").value(plan.title).style({bold:true});
      shO.cell("A2").value("Project").style({bold:true, fill:"FFE699"});
      shO.cell("B2").value(getProject(plan.projectId)?.name||"—");
      shO.cell("A3").value("Team").style({bold:true, fill:"FFE699"});
      shO.cell("B3").value(getTeam(plan.teamId)?.name||"—");
      shO.cell("A4").value("Buffer %").style({bold:true, fill:"FFE699"});
      shO.cell("B4").value(plan.bufferPct||0);
      shO.cell("A5").value("Schedule").style({bold:true, fill:"FFE699"});
      shO.cell("B5").value(fmt(sched.chartStart)+" → "+fmt(sched.chartEnd));
      shO.range("A1:B5").style({border:true});
      shO.cell("A7").value([["Phase", ...effortTypes().map(k=>effortTypeTitle(k)), "Total"]]).style({bold:true, fill:"FFD966", border:true});
      let rr=8;
      plan.phaseIds.forEach(pid=>{
        const t = aggr.phaseTotals[pid]||{};
        shO.cell("A"+rr).value([[getPhase(pid)?.name||pid, ...effortTypes().map(k=> t[k]||0), effortTypes().reduce((s,k)=>s+(t[k]||0),0)]]).style({border:true});
        rr++;
      });
      shO.column("A").width(26); for(let i=0;i<effortTypes().length+1;i++){ const col=String.fromCharCode('B'.charCodeAt(0)+i); shO.column(col).width(14); }

      // Tasks
      const shT = wb.addSheet(sheetName(plan.title,"_Tasks"));
      shT.cell("A1").value([["Phase","Task ID","Title", ...effortTypes().map(k=>effortTypeTitle(k)), "Total"]]).style({bold:true, fill:"C6E0B4", border:true});
      let tr=2;
      plan.phaseIds.forEach(pid=>{
        const data = computeTaskEffortsForPhase(plan, pid);
        data.rows.forEach(r=>{
          shT.cell("A"+tr).value([[getPhase(pid)?.name||pid, r.id, r.title, ...effortTypes().map(k=> r[k]), r.total]]).style({border:true});
          tr++;
        });
        shT.cell("A"+tr).value([["Phase totals","","", ...effortTypes().map(k=> data.totals[k]), data.totals.total]]).style({bold:true, fill:"FCE4D6", border:true}); tr++;
        tr++;
      });
      shT.column("A").width(18); shT.column("B").width(12); shT.column("C").width(48);
      for(let i=0;i<effortTypes().length+1;i++){ const col=String.fromCharCode('D'.charCodeAt(0)+i); shT.column(col).width(12); }

      // Gantt (colored cells)
      const shG = wb.addSheet(sheetName(plan.title,"_Gantt"));
      const totalDays = Math.max(1, daysBetween(sched.chartStart, addBusinessDays(sched.chartEnd,1)));
      const header = ["Lane","Phase","Start","Days"];
      for(let d=0; d<totalDays; d++){ const dt = addBusinessDays(sched.chartStart, d); header.push(dt.toISOString().slice(0,10)); }
      shG.cell("A1").value([header]).style({bold:true, fill:"9BC2E6", border:true});
      let gr=2;
      sched.phaseWindows.forEach(w=>{
        w.lanes.forEach(li=>{
          const row = [li.key, w.ph, li.start.toISOString().slice(0,10), li.days];
          shG.cell("A"+gr).value([row]).style({border:true});
          const startIdx = Math.max(0, daysBetween(sched.chartStart, li.start));
          for(let i=0;i<totalDays;i++){
            const cell = shG.cell(4 + i + 1, gr); // (col,row) is 1-based; col 5 = first date column
          }
          // Fill colored cells for the bar
          const laneColor = platColorHex(li.key);
          for(let i=startIdx;i<startIdx+li.days;i++){
            const col = 5 + i; // A=1 -> 5 is first date column
            shG.cell(gr, col).style({ fill: laneColor, border:true });
          }
          gr++;
        });
      });
      shG.column(1).width(12); shG.column(2).width(10); shG.column(3).width(12); shG.column(4).width(8);
      for(let c=5;c<5+totalDays;c++) shG.column(c).width(3);
      try{ shG.freezePanes(2,5); }catch(e){ /* some versions of XlsxPopulate may lack freezePanes */ }
    }

    /* ---------- Tasks CSV/XLSX Import/Export ---------- */
    function tasksToRows(){
      const header = ["id","title","description","startDate", ...effortTypes().flatMap(k=>[k.toLowerCase()+"_md", k.toLowerCase()+"_start"]), "assignments"];
      const rows = [header];
      state.tasks.forEach(t=>{
        const eff = Object.fromEntries(effortTypes().map(k=>[k,{}]));
        (t.efforts||[]).forEach(e=>{ eff[e.platform]={ md:e.manDays||"", start:e.startDate||"" }; });
        const asg = (t.assignments||[]).map(a=> `${a.proposalId}:${a.phaseId}`).join(";");
        const cells = effortTypes().flatMap(k=>[eff[k].md||"", eff[k].start||""]);
        rows.push([t.id, t.title, t.description||"", t.startDate||"", ...cells, asg]);
      });
      return rows;
    }
    function exportTasksCSV(){
      const rows = tasksToRows();
      const csv = rows.map(r=> r.map(v=> {
        const s = (v==null?"":String(v)); if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"'; return s;
      }).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tasks_export.csv'; a.click(); URL.revokeObjectURL(a.href);
    }
    async function exportTasksXLSX(){
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(tasksToRows()), "Tasks");
      XLSX.writeFile(wb, "tasks_export.xlsx");
    }
    async function importTasksFile(file){
      const name = (file?.name||"").toLowerCase();
      if(name.endsWith(".csv")){
        const text = await file.text();
        const rows = text.split(/\r?\n/).map(line=>{
          const out=[]; let cur=""; let q=false;
          for(let i=0;i<line.length;i++){
            const ch=line[i];
            if(ch=='"'){ if(q && line[i+1]=='"'){ cur+='"'; i++; } else { q=!q; } }
            else if(ch==',' && !q){ out.push(cur); cur=""; }
            else cur+=ch;
          }
          out.push(cur); return out;
        });
        const headers = rows.shift().map(h=>h.trim().toLowerCase());
        try{
          validateColumns(Object.fromEntries(headers.map(h=>[h,true])), ['id','title','assignments']);
        }catch(err){
          alert(err.message);
          return;
        }
        const idx = (k)=> headers.indexOf(k);
        rows.forEach(cols=>{
          if(!cols.length) return;
          const get = (k)=> cols[idx(k)]||"";
          const id = get("id"); if(!id) return;
          const t = { id, title:get("title"), description:get("description"), startDate:get("startdate"), efforts:[], assignments:[] };
          effortTypes().forEach(plat=>{
            const key = plat.toLowerCase();
            const md = parseFloat(get(key+"_md")); const sd = get(key+"_start");
            if(!isNaN(md) && md>0) t.efforts.push({platform:plat, manDays:md, startDate:sd});
          });
          const asg = get("assignments").split(";").map(s=>s.trim()).filter(Boolean).map(tok=>{ const [proposalId,phaseId]=tok.split(":"); return (proposalId&&phaseId)?{proposalId,phaseId}:null; }).filter(Boolean);
          t.assignments = asg;
          const at = state.tasks.findIndex(x=>x.id===id);
          if(at>=0) state.tasks[at]=t; else state.tasks.push(t);
        });
        save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); toast("Tasks imported (CSV)");
        return;
      }
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const data = new Uint8Array(await file.arrayBuffer());
      const wb = XLSX.read(data, {type:"array"});
      const first = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(first, {defval:""});
      const norm = n=> String(n||"").trim().toLowerCase();
      json.forEach(row=>{
        const map = {}; Object.keys(row).forEach(k=> map[norm(k)] = row[k]);
        const id = map["id"]; if(!id) return;
        const t = {
          id,
          title: map["title"]||"",
          description: map["description"]||"",
          startDate: map["startdate"]||"",
          efforts: [],
          assignments: (map["assignments"]||"").split(";").map(s=>s.trim()).filter(Boolean).map(tok=>{ const [proposalId, phaseId] = tok.split(":"); return (proposalId&&phaseId)?{proposalId, phaseId}:null; }).filter(Boolean)
        };
        effortTypes().forEach(plat=>{
          const key = plat.toLowerCase();
          const md = parseFloat(map[key+"_md"]); const sd = map[key+"_start"]||"";
          if(!isNaN(md) && md>0){ t.efforts.push({ platform:plat, manDays: md, startDate: sd }); }
        });
        const idx = state.tasks.findIndex(x=> x.id===id);
        if(idx>=0) state.tasks[idx] = t; else state.tasks.push(t);
      });
      save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); toast("Tasks imported (Excel)");
    }

    /* ---------- CRUD (Manage) with ID rules ---------- */
    const manageModal = new bootstrap.Modal('#manageModal');
    const editModal = new bootstrap.Modal('#editModal');
    byId('btn-manage').onclick = ()=>{ refreshManage(); manageModal.show(); };
    byId('btn-save-manage').onclick = ()=>{ save(); refreshManage(); manageModal.hide(); };

    // Modal helper functions
    function openEditModal() {
      editModal.show();
    }

    function closeEditModal() {
      editModal.hide();
    }

    function refreshManage(){
      const filterP = (byId('search-projects').value||'').toLowerCase();
      const tbP = byId('tbl-projects').querySelector('tbody'); tbP.innerHTML='';
      state.projects.filter(p=> (p.name+' '+p.id).toLowerCase().includes(filterP)).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.description||'')}</td><td><code>${escapeHtml(p.id)}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-secondary ms-1">Duplicate</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('project', p.id);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('project', p.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete project?')){
          state.proposals.forEach(pr=>{ if(pr.projectId===p.id) pr.projectId = state.projects[0]?.id || ''; });
          state.projects = state.projects.filter(x=>x.id!==p.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbP.appendChild(tr);
      });
      const filterPl = (byId('search-plans').value||'').toLowerCase();
      const tbPl = byId('tbl-plans').querySelector('tbody'); tbPl.innerHTML='';
      state.proposals.filter(p=> (p.title+' '+p.id).toLowerCase().includes(filterPl)).forEach(p=>{
        const aggr = aggregate(p, state.tasks, getTeam);
        const keys = effortTypes();
        const totals = Object.fromEntries(keys.map(k=>[k,0]));
        Object.values(aggr.phaseTotals).forEach(pt=>{ keys.forEach(k=>{ totals[k]+=(pt[k]||0); }); });
        const sumEff = keys.reduce((s,k)=>s+totals[k],0) || 1;
        const seg = Object.fromEntries(keys.map(k=>[k, totals[k]]));
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(p.title)}</td><td>${escapeHtml(getProject(p.projectId)?.name||'—')}</td><td>${escapeHtml(getTeam(p.teamId)?.name||'—')}</td>
          <td>${p.phaseIds.map(id=> escapeHtml(getPhase(id)?.name||id)).join(' · ')}</td>
          <td>${p.bufferPct||0}</td>
          <td><div class="mini-timeline"><div class="mini-phase">
            ${p.phaseIds.map((phId, i)=>`<div class="position-absolute top-0" style="left:${Math.round((i/p.phaseIds.length)*100)}%;height:8px;border-left:1px solid rgba(127,127,127,.6)"></div>`).join('')}
          </div>
          <div class="mini-platforms">
            ${keys.map(k=>`<div class="seg" style="background:${effortTypeColor(k)};flex:${seg[k]}"></div>`).join('')}
          </div></div></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-secondary ms-1">Duplicate</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('plan', p.id);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('plan', p.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete plan?')){
          state.tasks.forEach(t=> t.assignments = (t.assignments||[]).filter(a=>a.proposalId!==p.id));
          state.proposals = state.proposals.filter(x=>x.id!==p.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbPl.appendChild(tr);
      });
      const filterPh = (byId('search-phases').value||'').toLowerCase();
      const tbPh = byId('tbl-phases').querySelector('tbody'); tbPh.innerHTML='';
      state.phases.slice().sort((a,b)=>(a.order||0)-(b.order||0)).filter(p=> (p.name+' '+p.id).toLowerCase().includes(filterPh)).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.description||'')}</td><td>${p.order||1}</td><td><code>${escapeHtml(p.id)}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-secondary ms-1">Duplicate</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('phase', p.id);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('phase', p.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete phase?')){
          state.proposals.forEach(pr=> pr.phaseIds = (pr.phaseIds||[]).filter(id=>id!==p.id));
          state.tasks.forEach(t=> t.assignments = (t.assignments||[]).filter(a=>a.phaseId!==p.id));
          state.phases = state.phases.filter(x=>x.id!==p.id);
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbPh.appendChild(tr);
      });
      const filterTm = (byId('search-teams').value||'').toLowerCase();
      const tbTm = byId('tbl-teams').querySelector('tbody'); tbTm.innerHTML='';
      const headTm = byId('teams-head');
      headTm.innerHTML = '<th>Name</th>' + effortTypes().map(t=>`<th>${effortTypeTitle(t)}</th>`).join('') + '<th style="width:15%">ID</th><th style="width:160px">Actions</th>';
      state.teams.filter(t=> (t.name+' '+t.id).toLowerCase().includes(filterTm)).forEach(t=>{
        const tr = document.createElement('tr');
        // Calculate current team sizes from member assignments
        const teamSizes = getTeamSizes(t);
        const cells = effortTypes().map(k=>`<td>${teamSizes[k]||0}</td>`).join('');
        tr.innerHTML = `<td>${t.name}</td>${cells}<td><code>${t.id}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-secondary ms-1">Duplicate</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('team', t.id);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('team', t.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete team?')){
          state.proposals.forEach(p=>{ if(p.teamId===t.id) p.teamId = state.teams[0]?.id || ''; });
          state.teams = state.teams.filter(x=>x.id!==t.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbTm.appendChild(tr);
      });
      const filterSp = (byId('search-sprints').value||'').toLowerCase();
      const tbSp = byId('tbl-sprints').querySelector('tbody'); tbSp.innerHTML='';
      state.sprints.filter(s=> (s.name+' '+s.id).toLowerCase().includes(filterSp)).forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${s.start}</td><td>${s.end}</td><td><code>${s.id}</code></td>`+
          `<td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-secondary ms-1">Duplicate</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('sprint', s.id);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('sprint', s.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete sprint?')){ state.sprints = state.sprints.filter(x=>x.id!==s.id); save(); refreshManage(); } };
        tbSp.appendChild(tr);
      });
      const filterRl = (byId('search-releases').value||'').toLowerCase();
      const tbRl = byId('tbl-releases').querySelector('tbody'); tbRl.innerHTML='';
      (state.releases||[]).filter(r=> (r.version+' '+r.id).toLowerCase().includes(filterRl)).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.version)}</td><td>${r.codeFreeze||''}</td><td>${r.releaseDate||''}</td><td><code>${r.id}</code></td>`+
          `<td class="text-end"><button class=\"btn btn-sm btn-outline-primary\">Edit</button><button class=\"btn btn-sm btn-outline-secondary ms-1\">Duplicate</button><button class=\"btn btn-sm btn-outline-danger ms-1\">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('release', r.id);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('release', r.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete release?')){ state.releases = state.releases.filter(x=>x.id!==r.id); save(); refreshManage(); } };
        tbRl.appendChild(tr);
      });
      const filterTk = (byId('search-tasks').value||'').toLowerCase();
      const tbTk = byId('tbl-tasks').querySelector('tbody'); tbTk.innerHTML='';
      state.tasks.filter(t=> (t.title+' '+t.id).toLowerCase().includes(filterTk)).forEach(t=>{
        const eff = (t.efforts||[]).map(e=> `${e.platform}:${e.manDays}${e.startDate? ' ('+e.startDate+')':''}`).join(', ');
        const asg = (t.assignments||[]).map(a=> `${a.proposalId}/${a.phaseId}`).join(', ');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.title}</td><td>${t.startDate||''}</td><td>${getProject(t.projectId)?.name||'—'}</td><td>${t.viableProduct?'Yes':'No'}</td><td>${eff||'-'}</td><td><code>${t.id}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-secondary ms-1">Duplicate</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('task', t.id);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('task', t.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete task?')){ state.tasks = state.tasks.filter(x=>x.id!==t.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); } };
        tbTk.appendChild(tr);
      });

      const filterEt = (byId('search-effort-types').value||'').toLowerCase();
      const tbEt = byId('tbl-effort-types').querySelector('tbody'); tbEt.innerHTML='';
      (state.meta.effortTypes||[]).filter(e=> (e.title+' '+e.key).toLowerCase().includes(filterEt)).forEach(et=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(et.title)}</td>`+
          `<td><div class="d-flex align-items-center gap-2"><span class="badge" style="background:${et.color}">&nbsp;</span><code>${et.color}</code></div></td>`+
          `<td><code>${et.key}</code></td>`+
          `<td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-secondary ms-1">Duplicate</button>${et.locked?'' : '<button class="btn btn-sm btn-outline-danger ms-1">Delete</button>'}</td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('effortType', et.key);
        tr.querySelector('.btn-outline-secondary').onclick = ()=> duplicateEntity('effortType', et.key);
        if(!et.locked){ tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete effort type?')){ removeEffortType(et.key); save(); refreshManage(); } }; }
        tbEt.appendChild(tr);
      });

      byId('btn-add-project').onclick = ()=> openEditor('project', null);
      byId('btn-add-plan').onclick = ()=> openEditor('plan', null);
      byId('btn-add-phase').onclick = ()=> openEditor('phase', null);
      byId('btn-add-team').onclick = ()=> openEditor('team', null);
      byId('btn-reset-sprints').onclick = ()=>{
        if(confirm('Reset all sprints?')){
          const start = prompt('Start date for first sprint (YYYY-MM-DD)', state.sprints[0]?.start || new Date().toISOString().slice(0,10));
          if(start){
            resetSprints(start);
            refreshManage();
            buildProjects();
          }
        }
      };
      byId('btn-add-sprint').onclick = ()=> openEditor('sprint', null);
      byId('btn-add-release').onclick = ()=> openEditor('release', null);
      byId('btn-add-task').onclick = ()=> openEditor('task', null);
      byId('btn-add-effort-type').onclick = ()=> openEditor('effortType', null);
      byId('btn-add-team-member').onclick = ()=> openTeamMemberEditor();
      byId('search-projects').oninput = refreshManage;
      byId('search-plans').oninput = refreshManage;
      byId('search-phases').oninput = refreshManage;
      byId('search-teams').oninput = refreshManage;
      byId('search-sprints').oninput = refreshManage;
      byId('search-releases').oninput = refreshManage;
      byId('search-tasks').oninput = refreshManage;
      byId('search-effort-types').oninput = refreshManage;
      
      // Render team members table
      renderTeamMembersTable();
      
      byId('search-team-members').oninput = renderTeamMembersTable;
      // Phase Tasks tab wiring
      const ptProjSel = byId('pt-proj');
      const ptBoard = byId('phaseTaskContainers');
      const ptLegend = byId('phaseLegend');
      const ptBoardBtn = byId('pt-view-board');
      const ptMatrixBtn = byId('pt-view-matrix');
      const ptSearch = byId('pt-search');
      let ptView = 'board';
      let dragEl = null; let dragSet = [];
      if(ptBoard){
        function renderPhaseLegend(){
          if(!ptLegend) return;
          ptLegend.innerHTML='';
          state.phases.forEach(ph=>{
            const span=document.createElement('span');
            span.className='badge phase-badge';
            span.textContent=ph.name;
            if(ph.color) span.style.backgroundColor = ph.color;
            ptLegend.appendChild(span);
          });
        }
        function debounce(fn, delay=200){
          let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
        }
        ptProjSel.innerHTML = (state.projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        if(!ptProjSel.value && state.projects[0]) ptProjSel.value = state.projects[0].id;
        function createTaskElem(id, title, isPool){
          const div=document.createElement('div');
          div.className='pt-task';
          div.draggable=true;
          div.dataset.tid=id;
          div.dataset.origin=isPool?'pool':'phase';
          div.dataset.title=title;
          const label=document.createElement('span');
          label.textContent=title;
          if(isPool){
            const tags=document.createElement('span');
            tags.className='pt-tags';
            div.appendChild(tags);
            div.appendChild(label);
            div.addEventListener('click',e=>{ if(e.target===div||e.target===label) div.classList.toggle('selected'); });
          }else{
            div.appendChild(label);
            const x=document.createElement('span');
            x.className='pt-remove text-danger ms-auto';
            x.innerHTML='&times;';
            div.appendChild(x);
          }
          div.addEventListener('dragstart',()=>{
            dragEl=div;
            if(div.dataset.origin==='pool'){
              const selected=Array.from(byId('pt-pool').querySelectorAll('.pt-task.selected'));
              dragSet= selected.length? selected : [div];
            }else{
              dragSet=[div];
            }
          });
          return div;
        }
        function updatePoolTags(){
          const pool=byId('pt-pool');
          if(!pool) return;
          Array.from(pool.querySelectorAll('.pt-task')).forEach(el=>{
            const tid=el.dataset.tid;
            const tagBox=el.querySelector('.pt-tags');
            tagBox.innerHTML='';
            ptBoard.querySelectorAll('[data-ph]').forEach(zone=>{
              if(zone.querySelector(`[data-tid="${tid}"]`)){
                const phId=zone.dataset.ph;
                const phase=getPhase(phId);
                const tag=document.createElement('span');
                tag.className='badge phase-badge me-1';
                tag.textContent=phase?.name||phId;
                if(phase?.color) tag.style.backgroundColor = phase.color;
                tagBox.appendChild(tag);
              }
            });
          });
        }
        function updateCounts(){
          ptBoard.querySelectorAll('.pt-drop').forEach(zone=>{
            const header=zone.closest('.card').querySelector('.pt-header');
            if(!header) return;
            const title=header.dataset.title||'';
            let count;
            if(zone.id==='pt-pool'){
              count=Array.from(zone.querySelectorAll('.pt-task')).filter(t=>{
                return !ptBoard.querySelector(`[data-ph] [data-tid="${t.dataset.tid}"]`);
              }).length;
            }else{
              count=zone.querySelectorAll('.pt-task').length;
            }
            header.innerHTML=`${title} (<span class="badge bg-secondary">${count}</span>)`;
          });
        }
        function initDropZone(zone){
          zone.addEventListener('dragover',e=>e.preventDefault());
          zone.addEventListener('drop',e=>{
            e.preventDefault();
            if(!dragSet.length) return;
            if(zone.id==='pt-pool'){
              dragSet.forEach(el=>{ if(el.dataset.origin==='phase') el.remove(); el.classList.remove('selected'); });
            }else{
              dragSet.forEach(el=>{
                const tid=el.dataset.tid;
                if(zone.querySelector(`[data-tid="${tid}"]`)) return;
                if(el.dataset.origin==='pool'){
                  zone.appendChild(createTaskElem(tid, el.dataset.title, false));
                }else{
                  zone.appendChild(el);
                }
                el.classList.remove('selected');
              });
            }
            dragSet=[]; dragEl=null;
            updatePoolTags();
            updateCounts();
          });
          zone.addEventListener('click',e=>{
            if(e.target.classList.contains('pt-remove')){
              e.stopPropagation();
              const task=e.target.closest('.pt-task');
              task.remove();
              updatePoolTags();
              updateCounts();
            }
          });
        }
        function renderPhaseTasks(){
          renderPhaseLegend();
          const pid = ptProjSel.value;
          const q = (ptSearch?.value || '').toLowerCase();
          const tasks = getTasksByProject(pid).filter(t => (t.title + ' ' + t.id).toLowerCase().includes(q));
          ptBoard.className='d-flex flex-wrap gap-3 align-items-stretch';
          ptBoard.innerHTML = '';
          const poolBox=document.createElement('div');
          poolBox.className='pt-box pt-pool-box card shadow-sm';
          poolBox.innerHTML='<div class="card-header d-flex align-items-center justify-content-between"><span class="pt-header" data-title="Tasks">Tasks (<span class="badge bg-secondary">0</span>)</span><button class="btn btn-sm btn-outline-secondary" id="pt-select-all">Select All</button></div><div class="card-body pt-drop vstack gap-1" id="pt-pool"></div>';
          ptBoard.appendChild(poolBox);
          const pool=byId('pt-pool');
          tasks.forEach(t=>{ pool.appendChild(createTaskElem(t.id, t.title, true)); });
          poolBox.querySelector('#pt-select-all').onclick=()=>{
            const tasks=Array.from(pool.querySelectorAll('.pt-task'));
            const allSel=tasks.every(el=> el.classList.contains('selected'));
            tasks.forEach(el=> el.classList.toggle('selected', !allSel));
            poolBox.querySelector('#pt-select-all').textContent= allSel? 'Select All' : 'Clear';
          };
          state.phases.forEach(ph=>{
            const box=document.createElement('div');
            box.className='pt-box card shadow-sm';
            box.innerHTML=`<div class="card-header"><span class="pt-header" data-title="${ph.name}">${ph.name} (<span class="badge bg-secondary">0</span>)</span></div><div class="card-body pt-drop vstack gap-1" data-ph="${ph.id}"></div>`;
            ptBoard.appendChild(box);
          });
          tasks.forEach(t=>{
            getTaskPhaseIds(t).forEach(phId=>{
              const dest=ptBoard.querySelector(`[data-ph="${phId}"]`);
              if(dest) dest.appendChild(createTaskElem(t.id, t.title, false));
            });
          });
          ptBoard.querySelectorAll('.pt-drop').forEach(initDropZone);
          updateCounts();
          updatePoolTags();
        }
        function renderPhaseTaskMatrix(){
          renderPhaseLegend();
          const pid = ptProjSel.value;
          const q = (ptSearch?.value || '').toLowerCase();
          ptBoard.className='table-responsive pt-matrix-wrapper';
          ptBoard.innerHTML='';
          const tbl=document.createElement('table');
          tbl.id='phaseTaskMatrix';
          tbl.className='table table-sm table-bordered mb-0 align-middle';
          const thead=document.createElement('thead');
          thead.className='table-dark';
          const headRow=document.createElement('tr');
          headRow.innerHTML='<th>Task</th>' + state.phases.map(ph=>`<th>${ph.name}</th>`).join('');
          thead.appendChild(headRow);
          tbl.appendChild(thead);
          const tbody=document.createElement('tbody');
          const tasks=getTasksByProject(pid).filter(t => (t.title + ' ' + t.id).toLowerCase().includes(q));
          tasks.forEach(t=>{
            const tr=document.createElement('tr');
            const tdTitle=document.createElement('td');
            tdTitle.textContent=t.title;
            tr.appendChild(tdTitle);
            state.phases.forEach(ph=>{
              const td=document.createElement('td');
              td.className='text-center';
              const cb=document.createElement('input');
              cb.type='checkbox';
              cb.className='form-check-input';
              cb.dataset.tid=t.id;
              cb.dataset.ph=ph.id;
              if(getTaskPhaseIds(t).includes(String(ph.id))) cb.checked=true;
              td.appendChild(cb);
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          tbl.appendChild(tbody);
          ptBoard.appendChild(tbl);
        }
        ptProjSel.onchange = ()=>{ ptView==='board'? renderPhaseTasks() : renderPhaseTaskMatrix(); };
        ptBoardBtn.onclick = ()=>{ ptView='board'; ptBoardBtn.classList.add('active'); ptMatrixBtn.classList.remove('active'); renderPhaseTasks(); };
        ptMatrixBtn.onclick = ()=>{ ptView='matrix'; ptMatrixBtn.classList.add('active'); ptBoardBtn.classList.remove('active'); renderPhaseTaskMatrix(); };
        if(ptSearch){
          ptSearch.addEventListener('input', debounce(()=>{ ptView==='board'? renderPhaseTasks() : renderPhaseTaskMatrix(); }, 200));
        }
        renderPhaseTasks();
        const saveBtn = byId('pt-save');
        if(saveBtn) saveBtn.onclick = ()=>{
          const pid=ptProjSel.value;
          const projPropIds = state.proposals.filter(p=>String(p.projectId??'')===String(pid)).map(p=>p.id);
          getTasksByProject(pid).forEach(t=>{
            t.phaseIds=[];
            t.assignments = (t.assignments||[]).filter(a=> !projPropIds.includes(a.proposalId));
          });
          if(ptView==='board'){
            ptBoard.querySelectorAll('[data-ph]').forEach(zone=>{
              const phId=zone.dataset.ph;
              zone.querySelectorAll('.pt-task').forEach(el=> assignTaskToPhase(el.dataset.tid, phId));
            });
          }else{
            ptBoard.querySelectorAll('input[type="checkbox"][data-tid][data-ph]:checked').forEach(cb=>{
              assignTaskToPhase(cb.dataset.tid, cb.dataset.ph);
            });
          }
          save(); toast('Phase tasks updated');
        };
      }
      // Efforts tab wiring
      const effProjSel = byId('eff-proj');
      const effSearch = byId('eff-search');
      const effBody = byId('tbl-eff')?.querySelector('tbody');
      const effHead = byId('eff-head');
      if(effBody){
        effProjSel.innerHTML = (state.projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        if(!effProjSel.value && state.projects[0]) effProjSel.value = state.projects[0].id;
        function renderEffTbl(){
          const pid = effProjSel.value; const q=(effSearch.value||'').toLowerCase();
          effHead.innerHTML = '<th style="width:15%">Task ID</th><th>Title</th>' + effortTypes().map(k=>`<th style="width:10%">${effortTypeTitle(k)}</th>`).join('');
          effBody.innerHTML='';
          getTasksByProject(pid).filter(t=> (t.title+' '+t.id).toLowerCase().includes(q)).forEach(t=>{
            const m = Object.fromEntries((t.efforts||[]).map(e=> [e.platform, e.manDays]));
            const tr=document.createElement('tr');
            const inputs = effortTypes().map(k=>`<td><input type="number" step="0.1" min="0" class="form-control form-control-sm" data-tid="${t.id}" data-k="${k}" value="${m[k]??''}"></td>`).join('');
            tr.innerHTML = `<td><code>${t.id}</code></td><td>${t.title}</td>${inputs}`;
            effBody.appendChild(tr);
          });
        }
        effProjSel.onchange = renderEffTbl; effSearch.oninput = renderEffTbl; renderEffTbl();
        window.renderEffTbl = renderEffTbl;
        byId('eff-save').onclick = ()=>{
          const inputs = Array.from(effBody.querySelectorAll('input'));
          const byTask = new Map();
          inputs.forEach(inp=>{ const tid=inp.dataset.tid; if(!byTask.has(tid)) byTask.set(tid, []); byTask.get(tid).push(inp); });
          byTask.forEach((arr, tid)=>{
            const t = state.tasks.find(x=> x.id===tid); if(!t) return; const map={};
            arr.forEach(inp=>{ const k=inp.dataset.k; const v= inp.value===''? null : Math.max(0, +inp.value); if(v!=null) map[k]=+v.toFixed(1); });
            t.efforts = Object.entries(map).map(([platform, manDays])=>({platform, manDays}));
          });
          save(); toast('Efforts updated'); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        };
        /* Effort type management moved to separate CRUD */
      }

      byId('gen-start').value = state.meta.startDate;
      byId('gen-eff').value = state.meta.efficiency;
      byId('gen-px').value = state.meta.defaultPxPerDay||18;
      byId('gen-rtl').checked = !!state.meta.rtl;
      fillThemes();
      byId('gen-theme').value = state.meta.theme || "Dark";
      byId('gen-save').onclick = ()=>{
        state.meta.startDate = byId('gen-start').value || state.meta.startDate;
        state.meta.efficiency = Math.max(0.2, Math.min(1.2, +byId('gen-eff').value || state.meta.efficiency));
        state.meta.defaultPxPerDay = Math.max(6, Math.min(44, +byId('gen-px').value || state.meta.defaultPxPerDay || 18));
        state.meta.rtl = !!byId('gen-rtl').checked;
        state.meta.theme = byId('gen-theme').value || "Dark";
        document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr');
        applyTheme(state.meta.theme);
        save(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
      };
      byId('gen-apply-px').onclick = ()=>{
        const px = Math.max(6, Math.min(44, +byId('gen-px').value || 18));
        state.proposals.forEach(p=> p.pxPerDay = px);
        state.meta.defaultPxPerDay = px;
        save(); toast('Applied zoom to all plans'); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
      };
    }
    function openEditor(kind, id, prefill={}){
      const form = byId('editForm'); const title = byId('editTitle'); const del = byId('editDelete');
      form.innerHTML=''; del.classList.toggle('d-none', !id);
      function field(label, inner){ return `<div><label class="form-label">${label}</label>${inner}</div>`; }
      function val(id){ return byId(id).value.trim(); }
      function idInputHtml(value, isEdit){ return `<input id="f-id" class="form-control" value="${escapeHtml(value)}" ${isEdit?'readonly disabled':''}>`; }
      function ensureUniqueId(collection, idVal){ return !collection.some(x=> x.id===idVal); }

      if(kind==='project'){
        const isEdit = !!id;
        const data = isEdit ? state.projects.find(x=>x.id===id) : Object.assign({ id:'proj-'+Math.random().toString(36).slice(2,6), name:'', description:'' }, structuredClone(prefill));
        title.textContent = isEdit? 'Edit Project' : 'Add Project';
        form.innerHTML = [
          field('Name', `<input id="f-name" class="form-control" value="${escapeHtml(data.name)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.projects, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, name:val('f-name'), description:val('f-desc') };
          if(isEdit){ Object.assign(state.projects.find(x=>x.id===id), obj); } else { state.projects.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete project?')){ state.proposals.forEach(p=>{ if(p.projectId===id) p.projectId = state.projects[0]?.id || ''; }); state.projects = state.projects.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
      if(kind==='plan'){
        const isEdit = !!id;
        const data = isEdit ? state.proposals.find(x=>x.id===id) : Object.assign({ id:'prop'+Math.random().toString(36).slice(2,7), projectId:state.projects[0]?.id||'', title:'', description:'', teamId:state.teams[0]?.id||'', bufferPct:12, phaseIds:[], pxPerDay:state.meta.defaultPxPerDay||18, overrides:{}, lanes:defaultPlanLanes() }, structuredClone(prefill));
        data.lanes = data.lanes && data.lanes.length ? structuredClone(data.lanes) : defaultPlanLanes();
        title.textContent = isEdit? 'Edit Delivery Plan' : 'Add Delivery Plan';
        form.innerHTML = [
          field('Project', `<select id="f-project" class="form-select">${state.projects.map(p=> `<option value="${p.id}" ${p.id===data.projectId?'selected':''}>${escapeHtml(p.name)}</option>`).join('')}</select>`),
          field('Title', `<input id="f-title" class="form-control" value="${escapeHtml(data.title)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('Team', `<select id="f-team" class="form-select">${state.teams.map(t=> `<option value="${t.id}" ${t.id===data.teamId?'selected':''}>${escapeHtml(t.name)}</option>`).join('')}</select>`),
          field('Buffer %', `<input id="f-buffer" class="form-control" type="number" min="0" step="1" value="${data.bufferPct||0}">`),
          field('Phases (multi-select)', `<select id="f-phases" class="form-select" multiple size="6">${state.phases.map(ph=> `<option value="${ph.id}" ${data.phaseIds.includes(ph.id)?'selected':''}>${escapeHtml(ph.name)}</option>`).join('')}</select>`),
          `<hr><h6>Lanes</h6>
           <div id="lane-list" class="mb-2"></div>
           <div class="row g-2 align-items-end">
             <div class="col-3"><input id="f-lane-key" class="form-control" placeholder="Key"></div>
             <div class="col-5"><input id="f-lane-name" class="form-control" placeholder="Name"></div>
             <div class="col-3"><input id="f-lane-color" type="color" class="form-control form-control-color" value="#888888"></div>
             <div class="col-1"><button type="button" class="btn btn-outline-secondary w-100" id="btn-lane-add"><i class="bi bi-plus-lg"></i></button></div>
           </div>`,
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        const lanes = data.lanes;
        const laneList = byId('lane-list');
        function renderLanes(){
          laneList.innerHTML = lanes.map((l,i)=>
            `<div class="d-flex align-items-center gap-2 mb-1">
               <input class="form-control form-control-sm lane-key" data-i="${i}" style="width:25%" value="${escapeHtml(l.key)}">
               <input class="form-control form-control-sm lane-name" data-i="${i}" style="width:45%" value="${escapeHtml(l.name||'')}">
               <input type="color" class="form-control form-control-color lane-color" data-i="${i}" style="width:20%" value="${escapeHtml(l.color||'#888888')}">
               <button class="btn btn-sm btn-outline-danger" data-i="${i}">Delete</button>
             </div>`).join('') || '<div class="text-secondary">No lanes</div>';
          laneList.querySelectorAll('.lane-key').forEach(inp=> inp.oninput = ()=>{ lanes[inp.dataset.i].key = inp.value.trim(); });
          laneList.querySelectorAll('.lane-name').forEach(inp=> inp.oninput = ()=>{ lanes[inp.dataset.i].name = inp.value.trim(); });
          laneList.querySelectorAll('.lane-color').forEach(inp=> inp.oninput = ()=>{ lanes[inp.dataset.i].color = inp.value; });
          laneList.querySelectorAll('button[data-i]').forEach(btn=> btn.onclick = ()=>{ lanes.splice(btn.dataset.i,1); renderLanes(); });
        }
        renderLanes();
        byId('btn-lane-add').onclick = ()=>{
          const key = val('f-lane-key'); if(!key) return;
          lanes.push({key, name: val('f-lane-name')||key, color: byId('f-lane-color').value||'#888888'});
          byId('f-lane-key').value=''; byId('f-lane-name').value='';
          renderLanes();
        };
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.proposals, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, projectId:val('f-project'), title:val('f-title'), description:val('f-desc'), teamId:val('f-team'), bufferPct:+val('f-buffer')||0, phaseIds: Array.from(byId('f-phases').selectedOptions).map(o=>o.value), pxPerDay:data.pxPerDay||state.meta.defaultPxPerDay||18, overrides:data.overrides||{}, lanes };
          if(isEdit){ Object.assign(state.proposals.find(x=>x.id===id), obj); } else { state.proposals.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete plan?')){ state.tasks.forEach(t=> t.assignments = (t.assignments||[]).filter(a=>a.proposalId!==id)); state.proposals = state.proposals.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
      if(kind==='phase'){
        const isEdit = !!id;
        const data = isEdit ? state.phases.find(x=>x.id===id) : Object.assign({ id:'PH'+Math.random().toString(36).slice(2,6), name:'', description:'', order:1, color:'#6c757d' }, structuredClone(prefill));
        title.textContent = isEdit? 'Edit Phase' : 'Add Phase';
        form.innerHTML = [
          field('Title', `<input id="f-name" class="form-control" value="${escapeHtml(data.name)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('Color', `<input id="f-color" type="color" class="form-control form-control-color" value="${escapeHtml(data.color||'#6c757d')}">`),
          field('Order', `<input id="f-order" class="form-control" type="number" min="1" step="1" value="${data.order||1}">`),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.phases, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, name:val('f-name'), description:val('f-desc'), order:+val('f-order')||1, color:byId('f-color').value };
          if(isEdit){ Object.assign(state.phases.find(x=>x.id===id), obj); } else { state.phases.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete phase?')){ state.proposals.forEach(p=> p.phaseIds=(p.phaseIds||[]).filter(x=>x!==id)); state.tasks.forEach(t=> t.assignments=(t.assignments||[]).filter(a=>a.phaseId!==id)); state.phases = state.phases.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
      if(kind==='team'){
        const isEdit = !!id;
        const data = isEdit ? state.teams.find(x=>x.id===id) : Object.assign({ id:'team-'+Math.random().toString(36).slice(2,6), name:'', memberAssignments:[] }, structuredClone(prefill));
        
        // Ensure memberAssignments array exists and handle legacy teams
        if (!data.memberAssignments) {
          data.memberAssignments = [];
          // If this is an existing team with members, convert it to memberAssignments
          if (data.members && Array.isArray(data.members)) {
            data.members.forEach(member => {
              data.memberAssignments.push({
                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                memberId: member.id,
                startDate: member.startDate,
                endDate: member.endDate
              });
            });
          }
          // If this is an existing team with sizes, convert it to memberAssignments
          else if (data.sizes && typeof data.sizes === 'object') {
            Object.entries(data.sizes).forEach(([specialty, count]) => {
              for (let i = 0; i < count; i++) {
                // Create a placeholder team member
                const placeholderMember = {
                  id: `legacy-${specialty}-${i}-${Date.now()}`,
                  name: `${specialty} Developer ${i + 1}`,
                  specialty: specialty
                };
                state.teamMembers.push(placeholderMember);
                
                data.memberAssignments.push({
                  id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                  memberId: placeholderMember.id,
                  startDate: new Date().toISOString().slice(0, 10),
                  endDate: null
                });
              }
            });
          }
        }
        
        title.textContent = isEdit? 'Edit Team' : 'Add Team';
        
        // Build member assignments list HTML
        const assignmentsList = data.memberAssignments.map((assignment, index) => {
          const member = getTeamMember(assignment.memberId);
          const memberName = member ? member.name : 'Unknown Member';
          const specialtyText = member ? member.specialty : 'N/A';
          return `
            <div class="member-assignment-row border rounded p-2 mb-2" data-index="${index}">
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label small text-muted mb-1">Team Member</label>
                  <select class="form-select form-select-sm" onchange="updateAssignmentField(${index}, 'memberId', this.value)">
                    <option value="">Select Member</option>
                    ${getAllTeamMembers().map(m => `<option value="${m.id}" ${assignment.memberId === m.id ? 'selected' : ''}>${m.name} (${m.specialty})</option>`).join('')}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted mb-1">Specialty</label>
                  <input class="form-control form-control-sm" type="text" value="${specialtyText}" readonly style="background-color: #f8f9fa; color: #6c757d;">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted mb-1">Start Date</label>
                  <input class="form-control form-control-sm" type="date" value="${assignment.startDate || ''}" onchange="updateAssignmentField(${index}, 'startDate', this.value)">
                </div>
                <div class="col-md-2">
                  <label class="form-label small text-muted mb-1">End Date</label>
                  <input class="form-control form-control-sm" type="date" value="${assignment.endDate || ''}" onchange="updateAssignmentField(${index}, 'endDate', this.value)">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                  <label class="form-label small text-muted mb-1">&nbsp;</label>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${index})" style="margin-top: 24px;">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        form.innerHTML = [
          field('Name', `<input id="f-name" class="form-control" value="${escapeHtml(data.name)}">`),
          field('Member Assignments', `
            <div id="assignments-container">
              ${assignmentsList}
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addAssignment()">
              <i class="bi bi-plus"></i> Add Member Assignment
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2 ms-2" onclick="addAllAvailableMembers()">
              <i class="bi bi-people"></i> Add All Available Members
            </button>
            <div class="small text-muted mt-2">
              <i class="bi bi-info-circle"></i> 
              Add team members first in the "Team Members" tab, then assign them to this team with start/end dates.
            </div>
          `),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        
        // Store the current team data for assignment operations
        window.currentTeamData = data;
        
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.teams, newId)) return alert('ID already exists.');
          
          // Ensure memberAssignments array exists and validate all assignments before saving
          if (!window.currentTeamData.memberAssignments) {
            window.currentTeamData.memberAssignments = [];
          }
          
          const assignments = window.currentTeamData.memberAssignments;
          for (let i = 0; i < assignments.length; i++) {
            if (!window.validateAssignment(assignments[i])) {
              return; // Stop if validation fails
            }
          }
          
          const obj = { id: isEdit? data.id : newId, name:val('f-name'), memberAssignments: assignments };
          if(isEdit){ Object.assign(state.teams.find(x=>x.id===id), obj); } else { state.teams.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete team?')){ state.proposals.forEach(p=>{ if(p.teamId===id) p.teamId = state.teams[0]?.id || ''; }); state.teams = state.teams.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }

      if(kind==='sprint'){
        const isEdit = !!id;
        const data = isEdit ? state.sprints.find(x=>x.id===id) : Object.assign({ id:'SPR'+Math.random().toString(36).slice(2,6), name:'', start:'', end:'' }, structuredClone(prefill));
        title.textContent = isEdit? 'Edit Sprint' : 'Add Sprint';
        form.innerHTML = [
          field('Name', `<input id="f-name" class="form-control" value="${escapeHtml(data.name)}">`),
          field('Start', `<input id="f-start" type="date" class="form-control" value="${escapeHtml(data.start||'')}">`),
          field('End', `<input id="f-end" type="date" class="form-control" value="${escapeHtml(data.end||'')}">`),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.sprints, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, name: val('f-name'), start: val('f-start'), end: val('f-end') };
          if(isEdit){ Object.assign(state.sprints.find(x=>x.id===id), obj); } else { state.sprints.push(obj); }
          save(); refreshManage(); buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete sprint?')){ state.sprints = state.sprints.filter(x=>x.id!==id); save(); refreshManage(); buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }

      if(kind==='release'){
        const isEdit = !!id;
        const data = isEdit ? state.releases.find(x=>x.id===id) : Object.assign({ id:'REL'+Math.random().toString(36).slice(2,6), version:'', codeFreeze:'', releaseDate:'' }, structuredClone(prefill));
        title.textContent = isEdit ? 'Edit Release' : 'Add Release';
        form.innerHTML = [
          field('Version', `<input id="f-version" class="form-control" value="${escapeHtml(data.version||'')}">`),
          field('Code Freeze', `<input id="f-freeze" type="date" class="form-control" value="${escapeHtml(data.codeFreeze||'')}">`),
          field('Release', `<input id="f-release" type="date" class="form-control" value="${escapeHtml(data.releaseDate||'')}">`),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.releases, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, version: val('f-version'), codeFreeze: val('f-freeze'), releaseDate: val('f-release') };
          if(isEdit){ Object.assign(state.releases.find(x=>x.id===id), obj); } else { state.releases.push(obj); }
          save(); refreshManage(); buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete release?')){ state.releases = state.releases.filter(x=>x.id!==id); save(); refreshManage(); buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }

      if(kind==='effortType'){
        const isEdit = !!id;
        const data = isEdit ? state.meta.effortTypes.find(e=>e.key===id) : Object.assign({ key:'', title:'', color:'#888', locked:false }, structuredClone(prefill));
        title.textContent = isEdit ? 'Edit Effort Type' : 'Add Effort Type';
        form.innerHTML = [
          field('Title', `<input id="f-title" class="form-control" value="${escapeHtml(data.title)}">`),
          field('Color', `<input id="f-color" type="color" class="form-control form-control-color" value="${escapeHtml(data.color)}">`),
          field('Key', idInputHtml(data.key, isEdit))
        ].join('');
        byId('editSave').onclick = ()=>{
          const key = isEdit ? data.key : val('f-id');
          if(!key) return alert('Key required');
          if(!isEdit && (state.meta.effortTypes||[]).some(e=>e.key===key)) return alert('Key already exists.');
          const obj = { key, title: val('f-title')||key, color: byId('f-color').value, locked:data.locked };
          if(isEdit){ Object.assign(data, obj); }
          else {
            (state.meta.effortTypes||(state.meta.effortTypes=[])).push(obj);
            // Legacy support for old teams with sizes
            state.teams.forEach(tm=>{ 
              if(tm.sizes) tm.sizes[key]=tm.sizes[key]||0; 
            });
          }
          save(); refreshManage(); buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.classList.toggle('d-none', !isEdit || data.locked);
        del.onclick = ()=>{ if(confirm('Delete effort type?')){ removeEffortType(data.key); save(); refreshManage(); buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }

      if(kind==='task'){
        const isEdit = !!id;
        const data = isEdit ? state.tasks.find(x=>x.id===id) : Object.assign({ id: Math.random().toString(36).slice(2,6), title:'', description:'', startDate:'', projectId: (state.projects[0]?.id||''), viableProduct:false, efforts:[], assignments:[], phaseIds:[] }, structuredClone(prefill));
        data.phaseIds = Array.from(new Set([...(data.phaseIds||[]).map(String), ...((data.assignments||[]).map(a=>String(a.phaseId)))]));
        title.textContent = isEdit? 'Edit Task' : 'Add Task';
        form.innerHTML = [
          field('Title', `<input id="f-title" class="form-control" value="${escapeHtml(data.title)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('Project', `<select id="f-project" class="form-select">${state.projects.map(p=>`<option value="${p.id}" ${p.id===(data.projectId||state.projects[0]?.id)?'selected':''}>${escapeHtml(p.name)}</option>`).join('')}</select>`),
          field('Task start (optional)', `<input id="f-start" type="date" class="form-control" value="${escapeHtml(data.startDate||'')}">`),
          field('Phases (multi-select)', `<select id="f-phases" class="form-select" multiple size="6">${state.phases.map(ph=>`<option value="${ph.id}" ${(data.phaseIds||[]).includes(ph.id)?'selected':''}>${escapeHtml(ph.name)}</option>`).join('')}</select>`),
          `<div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="f-vp" ${data.viableProduct?'checked':''}><label class="form-check-label" for="f-vp">Viable Product</label></div>`,
          `<hr><h6>Assignments</h6>
           <div class="row g-2 align-items-end">
             <div class="col-5">${field('Delivery Plan', `<select id="f-asg-plan" class="form-select">${state.proposals.map(p=>`<option value="${p.id}">${escapeHtml(p.title)}</option>`).join('')}</select>`)}</div>
             <div class="col-5">${field('Phase', `<select id="f-asg-phase" class="form-select">${state.phases.map(ph=>`<option value="${ph.id}">${escapeHtml(ph.name)}</option>`).join('')}</select>`)}</div>
             <div class="col-2"><button type="button" class="btn btn-outline-secondary w-100" id="btn-asg-add"><i class="bi bi-plus-lg"></i> Add</button></div>
           </div>
           <div id="asg-list" class="small text-secondary"></div>`,
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        const asgList = byId('asg-list');
        function renderAsg(){
          asgList.innerHTML = (data.assignments||[]).map((a,i)=>`<div class="d-flex justify-content-between align-items-center border rounded px-2 py-1 my-1">
            <div>${getProposal(a.proposalId)?.title||a.proposalId} • ${getPhase(a.phaseId)?.name||a.phaseId}</div>
            <button class="btn btn-sm btn-outline-danger" data-i="${i}">Delete</button>
          </div>`).join('') || '<div class="text-secondary">No assignments</div>';
          Array.from(asgList.querySelectorAll('button[data-i]')).forEach(btn=> btn.onclick = ()=>{ const i=+btn.dataset.i; data.assignments.splice(i,1); renderAsg(); });
        }
        renderAsg();
        byId('btn-asg-add').onclick = ()=>{
          const a={ proposalId: val('f-asg-plan'), phaseId: val('f-asg-phase') };
          data.assignments = data.assignments||[]; data.assignments.push(a); renderAsg();
        };
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && state.tasks.some(x=>x.id===newId)) return alert('ID already exists.');
          const selPh = Array.from(byId('f-phases').selectedOptions).map(o=>o.value);
          const asgPh = (data.assignments||[]).map(a=> String(a.phaseId));
          const phaseIds = Array.from(new Set([...selPh, ...asgPh]));
          const obj = { id: isEdit? data.id : newId, title:val('f-title'), description:val('f-desc'), startDate:byId('f-start').value, projectId: byId('f-project').value, viableProduct: !!byId('f-vp').checked, phaseIds, efforts:data.efforts||[], assignments:data.assignments||[] };
          if(isEdit){ Object.assign(state.tasks.find(x=>x.id===id), obj); } else { state.tasks.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete task?')){ state.tasks = state.tasks.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }

      new bootstrap.Modal('#editModal').show();
    }

    function duplicateEntity(kind, id){
      let src=null;
      if(kind==='project'){
        const it=state.projects.find(x=>x.id===id); if(it) src=Object.assign(structuredClone(it), {id:'proj-'+Math.random().toString(36).slice(2,6), name:it.name+' Copy'});
      }else if(kind==='plan'){
        const it=state.proposals.find(x=>x.id===id); if(it) src=Object.assign(structuredClone(it), {id:'prop'+Math.random().toString(36).slice(2,7), title:it.title+' Copy'});
      }else if(kind==='phase'){
        const it=state.phases.find(x=>x.id===id); if(it) src=Object.assign(structuredClone(it), {id:'PH'+Math.random().toString(36).slice(2,6), name:it.name+' Copy'});
      }else if(kind==='team'){
        const it=state.teams.find(x=>x.id===id); if(it) src=Object.assign(structuredClone(it), {id:'team-'+Math.random().toString(36).slice(2,6), name:it.name+' Copy'});
      }else if(kind==='sprint'){
        const it=state.sprints.find(x=>x.id===id); if(it) src=Object.assign(structuredClone(it), {id:'SPR'+Math.random().toString(36).slice(2,6), name:(it.name||'')+' Copy'});
      }else if(kind==='release'){
        const it=state.releases.find(x=>x.id===id); if(it) src=Object.assign(structuredClone(it), {id:'REL'+Math.random().toString(36).slice(2,6), version:(it.version||'')+' Copy'});
      }else if(kind==='task'){
        const it=state.tasks.find(x=>x.id===id); if(it) src=Object.assign(structuredClone(it), {id:Math.random().toString(36).slice(2,6), title:it.title+' Copy'});
      }else if(kind==='effortType'){
        const it=(state.meta.effortTypes||[]).find(e=>e.key===id); if(it) src=Object.assign(structuredClone(it), {key:it.key+Math.random().toString(36).slice(2,4)});
      }
      if(src) openEditor(kind, null, src);
    }

    /* ---------- Export/Import/Reset ---------- */
    byId('btn-export').onclick = ()=>{
      let data;
      if(currentPlanId){
        const plan = state.proposals.find(p=>p.id===currentPlanId);
        data = exportPlanJSON(plan);
      }else{
        data = JSON.stringify(state,null,2);
      }
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='project_planner_v20.json';
      a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    };
      byId('file-import').onchange = (e)=>{
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{
            const obj = JSON.parse(r.result);
            if(obj.phaseIds){
              state.proposals.push(importPlanJSON(r.result));
            }else if(obj.projects){
              mergeState(obj);
            }else{
              replaceState(obj);
            }
            save();
            applyTheme(state.meta.theme||"Dark");
            document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr');
            try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
            buildProjects();
          }catch(err){
            alert('Invalid JSON: '+err);
          }
        };
        r.readAsText(f);
      };
      byId('btn-reset').onclick = ()=>{ if(confirm('Reset to defaults?')){ replaceState(structuredClone(DEFAULT_DATA)); save(); applyTheme(state.meta.theme||"Dark"); document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr'); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
        buildProjects(); } };
    byId('themeSelect').onchange = (e)=>{ state.meta.theme = e.target.value; applyTheme(state.meta.theme); save(); };
    // Data menu
    byId('exportTasksCSV').onclick = exportTasksCSV;
    byId('exportTasksXLSX').onclick = exportTasksXLSX;
    byId('importTasks').onchange = (e)=>{ const f=e.target.files[0]; if(f) importTasksFile(f); };
    // Styled Excel menu
    byId('btn-export-project-xlsx-styled').onclick = ()=>{
      const pr = state.projects[0]; if(pr) exportProjectExcelStyled(pr.id); else alert('No project found.');
    };
    byId('btn-export-plan-xlsx-styled').onclick = ()=>{
      if(!currentPlanId){ alert('Open a plan first (Details view).'); return; }
      exportPlanExcelStyled(currentPlanId);
    };
    // Basic Excel menu (header dropdown already present)
    byId('btn-export-project-xlsx').onclick = ()=>{
      const pr = state.projects[0]; if(pr) exportProjectExcel(pr.id); else alert('No project found.');
    };
    byId('btn-export-plan-xlsx').onclick = ()=>{
      if(!currentPlanId){ alert('Open a plan first (Details view).'); return; }
      exportPlanExcel(currentPlanId);
    };

    // Collapsible Table Functions
    window.toggleCollapsible = function(sectionId) {
      const content = document.getElementById(sectionId + '-content');
      const icon = document.getElementById(sectionId + '-icon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-down';
        localStorage.setItem('collapsible_' + sectionId, 'expanded');
      } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-right';
        localStorage.setItem('collapsible_' + sectionId, 'collapsed');
      }
    };

    // Initialize collapsible sections
    window.initializeCollapsibles = function() {
      const sections = ['phaseSchedule', 'effortBreakdown', 'teamCapacity'];
      sections.forEach(sectionId => {
        const content = document.getElementById(sectionId + '-content');
        const icon = document.getElementById(sectionId + '-icon');
        const state = localStorage.getItem('collapsible_' + sectionId) || 'collapsed';
        
        if (state === 'collapsed') {
          content.style.display = 'none';
          icon.className = 'bi bi-chevron-right';
        } else {
          content.style.display = 'block';
          icon.className = 'bi bi-chevron-down';
        }
      });
    };

    // Team Member CRUD Functions
    window.openTeamMemberEditor = function(memberId = null) {
      const member = memberId ? getTeamMember(memberId) : createDefaultTeamMember();
      const isEdit = !!memberId;
      
      byId('editTitle').textContent = isEdit ? 'Edit Team Member' : 'Add Team Member';
      byId('editForm').innerHTML = `
        <div class="mb-3">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" id="member-name" value="${escapeHtml(member.name)}" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Specialty</label>
          <select class="form-select" id="member-specialty" required>
            ${window.effortTypes().map(et => `<option value="${et}" ${member.specialty === et ? 'selected' : ''}>${window.effortTypeTitle(et)}</option>`).join('')}
          </select>
        </div>
      `;
      
      byId('editDelete').classList.toggle('d-none', !isEdit);
      byId('editDelete').onclick = () => {
        if (confirm('Are you sure you want to delete this team member?')) {
          deleteTeamMember(memberId);
          save();
          renderTeamMembersTable();
          closeEditModal();
        }
      };
      
      byId('editSave').onclick = () => {
        const name = byId('member-name').value.trim();
        const specialty = byId('member-specialty').value;
        
        if (!name) {
          alert('Please enter a name');
          return;
        }
        
        // Check for duplicate names (excluding current member if editing)
        const existingMembers = getAllTeamMembers();
        const duplicateMember = existingMembers.find(m => 
          m.name.toLowerCase() === name.toLowerCase() && 
          (!isEdit || m.id !== memberId)
        );
        
        if (duplicateMember) {
          alert('A team member with this name already exists. Please choose a different name.');
          return;
        }
        
        if (isEdit) {
          updateTeamMember(memberId, { name, specialty });
        } else {
          const newMember = createDefaultTeamMember();
          newMember.name = name;
          newMember.specialty = specialty;
          addTeamMember(newMember);
        }
        
        save();
        renderTeamMembersTable();
        closeEditModal();
      };
      
      openEditModal();
    };

    window.duplicateTeamMember = function(memberId) {
      const originalMember = getTeamMember(memberId);
      if (!originalMember) return;
      
      const newMember = createDefaultTeamMember();
      newMember.name = originalMember.name + ' (Copy)';
      newMember.specialty = originalMember.specialty;
      
      // Check if name already exists and make it unique
      let counter = 1;
      while (getAllTeamMembers().some(m => m.name === newMember.name)) {
        newMember.name = originalMember.name + ` (Copy ${counter})`;
        counter++;
      }
      
      addTeamMember(newMember);
      save();
      renderTeamMembersTable();
    };

    window.renderTeamMembersTable = function() {
      const tbody = byId('tbl-team-members').querySelector('tbody');
      tbody.innerHTML = '';
      
      const members = getAllTeamMembers();
      const searchTerm = byId('search-team-members').value.toLowerCase();
      const filteredMembers = members.filter(m => 
        m.name.toLowerCase().includes(searchTerm) || 
        m.specialty.toLowerCase().includes(searchTerm)
      );
      
      filteredMembers.forEach(member => {
        const tr = document.createElement('tr');
        const specialtyColor = window.effortTypeColor(member.specialty) || '#6c757d';
        tr.innerHTML = `
          <td>${escapeHtml(member.name)}</td>
          <td><span class="badge" style="background-color: ${specialtyColor}; color: white;">${member.specialty}</span></td>
          <td><small class="text-muted">${member.id}</small></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary" onclick="openTeamMemberEditor('${member.id}')">Edit</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="duplicateTeamMember('${member.id}')">Duplicate</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTeamMember('${member.id}'); save(); renderTeamMembersTable();">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    };

    // Team Member Assignment Functions
    window.addAllAvailableMembers = function() {
      if (!window.currentTeamData.memberAssignments) {
        window.currentTeamData.memberAssignments = [];
      }
      
      const allMembers = getAllTeamMembers();
      const existingMemberIds = window.currentTeamData.memberAssignments.map(a => a.memberId);
      const availableMembers = allMembers.filter(m => !existingMemberIds.includes(m.id));
      
      if (availableMembers.length === 0) {
        alert('All available team members are already assigned to this team.');
        return;
      }
      
      const today = new Date().toISOString().slice(0, 10);
      
      availableMembers.forEach(member => {
        const newAssignment = {
          id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
          memberId: member.id,
          startDate: today,
          endDate: null
        };
        
        window.currentTeamData.memberAssignments.push(newAssignment);
      });
      
      refreshAssignmentsList();
    };

    window.addAssignment = function() {
      if (!window.currentTeamData.memberAssignments) {
        window.currentTeamData.memberAssignments = [];
      }
      
      const newAssignment = {
        id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
        memberId: '',
        startDate: new Date().toISOString().slice(0, 10),
        endDate: null
      };
      
      window.currentTeamData.memberAssignments.push(newAssignment);
      refreshAssignmentsList();
    };

    window.removeAssignment = function(index) {
      if (!window.currentTeamData.memberAssignments) return;
      window.currentTeamData.memberAssignments.splice(index, 1);
      refreshAssignmentsList();
    };

    window.updateAssignmentField = function(index, field, value) {
      if (!window.currentTeamData.memberAssignments || !window.currentTeamData.memberAssignments[index]) return;
      window.currentTeamData.memberAssignments[index][field] = value;
    };

    window.validateAssignment = function(assignment) {
      if (!assignment.memberId) {
        alert('Please select a team member for all assignments');
        return false;
      }
      if (!assignment.startDate) {
        alert('Please set a start date for all assignments');
        return false;
      }
      if (assignment.endDate && assignment.endDate <= assignment.startDate) {
        alert('End date must be after start date');
        return false;
      }
      return true;
    };

    window.refreshAssignmentsList = function() {
      const container = byId('assignments-container');
      if (!container) return;
      
      const assignments = window.currentTeamData.memberAssignments || [];
      const assignmentsList = assignments.map((assignment, index) => {
        const member = getTeamMember(assignment.memberId);
        const memberName = member ? member.name : 'Unknown Member';
        const specialtyText = member ? member.specialty : 'N/A';
        return `
          <div class="member-assignment-row border rounded p-2 mb-2" data-index="${index}">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1">Team Member</label>
                <select class="form-select form-select-sm" onchange="updateAssignmentField(${index}, 'memberId', this.value)">
                  <option value="">Select Member</option>
                  ${getAllTeamMembers().map(m => `<option value="${m.id}" ${assignment.memberId === m.id ? 'selected' : ''}>${m.name} (${m.specialty})</option>`).join('')}
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Specialty</label>
                <input class="form-control form-control-sm" type="text" value="${specialtyText}" readonly style="background-color: #f8f9fa; color: #6c757d;">
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Start Date</label>
                <input class="form-control form-control-sm" type="date" value="${assignment.startDate || ''}" onchange="updateAssignmentField(${index}, 'startDate', this.value)">
              </div>
              <div class="col-md-2">
                <label class="form-label small text-muted mb-1">End Date</label>
                <input class="form-control form-control-sm" type="date" value="${assignment.endDate || ''}" onchange="updateAssignmentField(${index}, 'endDate', this.value)">
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <label class="form-label small text-muted mb-1">&nbsp;</label>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${index})" style="margin-top: 24px;">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = assignmentsList;
    };

    // Team Member Management Functions - Make them globally accessible
    window.addMember = function() {
      if (!window.currentTeamData) return;
      
      // Ensure members array exists
      if (!window.currentTeamData.members) {
        window.currentTeamData.members = [];
      }
      
      const newMember = {
        id: 'member-' + Math.random().toString(36).slice(2, 8),
        name: '',
        specialty: effortTypes()[0] || 'BE',
        startDate: new Date().toISOString().slice(0, 10),
        endDate: ''
      };
      
      window.currentTeamData.members.push(newMember);
      window.refreshMembersList();
    }
    
    window.validateMember = function(member) {
      if (!member.name || member.name.trim() === '') {
        alert('Member name is required');
        return false;
      }
      
      if (!member.specialty) {
        alert('Member specialty is required');
        return false;
      }
      
      if (!member.startDate) {
        alert('Member start date is required');
        return false;
      }
      
      if (member.endDate && member.endDate < member.startDate) {
        alert('End date must be after start date');
        return false;
      }
      
      return true;
    }
    
    window.removeMember = function(index) {
      if (!window.currentTeamData) return;
      
      // Ensure members array exists
      if (!window.currentTeamData.members) {
        window.currentTeamData.members = [];
      }
      
      if (index >= 0 && index < window.currentTeamData.members.length) {
        window.currentTeamData.members.splice(index, 1);
        window.refreshMembersList();
      }
    }
    
    window.updateMemberField = function(index, field, value) {
      if (!window.currentTeamData) return;
      
      // Ensure members array exists
      if (!window.currentTeamData.members) {
        window.currentTeamData.members = [];
      }
      
      if (index >= 0 && index < window.currentTeamData.members.length) {
        window.currentTeamData.members[index][field] = value;
      }
    }
    
    window.refreshMembersList = function() {
      const container = document.getElementById('members-container');
      if (!container || !window.currentTeamData) return;
      
      // Ensure members array exists
      if (!window.currentTeamData.members) {
        window.currentTeamData.members = [];
      }
      
      const membersList = window.currentTeamData.members.map((member, index) => `
        <div class="member-row border rounded p-2 mb-2" data-index="${index}">
          <div class="row g-2">
            <div class="col-md-3">
              <input class="form-control form-control-sm" placeholder="Name" value="${escapeHtml(member.name || '')}" onchange="updateMemberField(${index}, 'name', this.value)">
            </div>
            <div class="col-md-3">
              <select class="form-control form-control-sm" onchange="updateMemberField(${index}, 'specialty', this.value)">
                ${effortTypes().map(k => `<option value="${k}" ${member.specialty === k ? 'selected' : ''}>${effortTypeTitle(k)}</option>`).join('')}
              </select>
            </div>
            <div class="col-md-2">
              <input class="form-control form-control-sm" type="date" value="${member.startDate || ''}" onchange="updateMemberField(${index}, 'startDate', this.value)">
            </div>
            <div class="col-md-2">
              <input class="form-control form-control-sm" type="date" value="${member.endDate || ''}" onchange="updateMemberField(${index}, 'endDate', this.value)">
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMember(${index})">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = membersList;
    }

    // Boot
    function initApp(){
      fillThemes();
      applyTheme(state.meta.theme||"Dark");
      document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr');
      byId('startLabel').textContent = state.meta.startDate;
      byId('effLabel').textContent = state.meta.efficiency;

      // Migration: ensure each task has a projectId
      try{
        const defaultProj = state.proposals[0]?.projectId || state.projects[0]?.id || '';
        state.tasks.forEach(t=>{ if(!t.projectId){ t.projectId = defaultProj; } });
        save();
      }catch(e){}
      try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();

      }
    initApp();

    // Capacity Trend Chart Function
    window.renderCapacityTrendChart = function(team, chartStart, chartEnd) {
      const chartContainer = byId('capacity-chart');
      if (!chartContainer || !team || !team.memberAssignments) return;
      
      // Calculate daily capacity for each specialty over the chart period
      const specialties = [...new Set(team.memberAssignments.map(a => {
        const member = state.teamMembers.find(m => m.id === a.memberId);
        return member ? member.specialty : null;
      }).filter(Boolean))];
      const chartDays = Math.max(1, daysBetween(chartStart, addBusinessDays(chartEnd, 1)));
      
      // Generate daily capacity data
      const capacityData = {};
      specialties.forEach(specialty => {
        capacityData[specialty] = [];
        for (let day = 0; day <= chartDays; day++) {
          const date = addBusinessDays(chartStart, day);
          const capacity = getTeamSizesForDate(team, date)[specialty] || 0;
          capacityData[specialty].push({
            day: day,
            date: date,
            capacity: capacity
          });
        }
      });
      
      // Create SVG chart
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');
      svg.style.position = 'absolute';
      svg.style.top = '0';
      svg.style.left = '0';
      
      const chartWidth = chartContainer.offsetWidth - 40; // Account for padding
      const chartHeight = 160;
      const margin = { top: 20, right: 20, bottom: 30, left: 40 };
      const width = chartWidth - margin.left - margin.right;
      const height = chartHeight - margin.top - margin.bottom;
      
      // Create chart group
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
      
      // Add chart background
      const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bg.setAttribute('width', width);
      bg.setAttribute('height', height);
      bg.setAttribute('fill', 'var(--bs-tertiary-bg)');
      bg.setAttribute('stroke', 'var(--bs-border-color)');
      bg.setAttribute('stroke-width', '1');
      g.appendChild(bg);
      
      // Add grid lines
      const maxCapacity = Math.max(...Object.values(capacityData).flatMap(data => data.map(d => d.capacity)));
      const gridLines = Math.min(5, maxCapacity + 1);
      
      for (let i = 0; i <= gridLines; i++) {
        const y = height - (i / gridLines) * height;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', '0');
        line.setAttribute('y1', y);
        line.setAttribute('x2', width);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', 'var(--bs-border-color)');
        line.setAttribute('stroke-width', '0.5');
        line.setAttribute('opacity', '0.3');
        g.appendChild(line);
        
        // Add Y-axis labels
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', '-5');
        label.setAttribute('y', y + 3);
        label.setAttribute('text-anchor', 'end');
        label.setAttribute('font-size', '10');
        label.setAttribute('fill', 'var(--bs-secondary-color)');
        label.textContent = i;
        g.appendChild(label);
      }
      
      // Add X-axis grid lines (weekly)
      for (let day = 0; day <= chartDays; day += 7) {
        const x = (day / chartDays) * width;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x);
        line.setAttribute('y1', '0');
        line.setAttribute('x2', x);
        line.setAttribute('y2', height);
        line.setAttribute('stroke', 'var(--bs-border-color)');
        line.setAttribute('stroke-width', '0.5');
        line.setAttribute('opacity', '0.3');
        g.appendChild(line);
        
        // Add X-axis labels
        const date = addBusinessDays(chartStart, day);
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', x);
        label.setAttribute('y', height + 15);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('font-size', '9');
        label.setAttribute('fill', 'var(--bs-secondary-color)');
        label.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        g.appendChild(label);
      }
      
      // Draw capacity lines for each specialty
      const colors = {
        'BE': '#9c755f',
        'iOS': '#4e79a7',
        'Android': '#59a14f',
        'Online': '#f28e2c',
        'QA': '#edc948'
      };
      
      specialties.forEach(specialty => {
        const data = capacityData[specialty];
        if (!data || data.length < 2) return;
        
        // Create path for the line
        let pathData = '';
        data.forEach((point, index) => {
          const x = (point.day / chartDays) * width;
          const y = height - (point.capacity / maxCapacity) * height;
          if (index === 0) {
            pathData += `M ${x} ${y}`;
          } else {
            pathData += ` L ${x} ${y}`;
          }
        });
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('stroke', colors[specialty] || '#6c757d');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        g.appendChild(path);
        
        // Add specialty label
        const lastPoint = data[data.length - 1];
        const labelX = (lastPoint.day / chartDays) * width + 5;
        const labelY = height - (lastPoint.capacity / maxCapacity) * height;
        
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', labelX);
        label.setAttribute('y', labelY + 3);
        label.setAttribute('font-size', '11');
        label.setAttribute('font-weight', '500');
        label.setAttribute('fill', colors[specialty] || '#6c757d');
        label.textContent = specialty;
        g.appendChild(label);
      });
      
      svg.appendChild(g);
      chartContainer.appendChild(svg);
    };

    // Toast notification function
    window.showToast = function(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toast-container');
      if (!container) return;
      
      const toastId = 'toast-' + Date.now();
      const toast = document.createElement('div');
      const bgClass = type === 'success' ? 'success' : 
                     type === 'error' ? 'danger' : 
                     type === 'warning' ? 'warning' : 
                     type === 'primary' ? 'primary' : 'info';
      
      toast.className = `toast align-items-center text-white bg-${bgClass} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.id = toastId;
      
      const iconClass = type === 'success' ? 'bi-check-circle' : 
                       type === 'error' ? 'bi-exclamation-triangle' : 
                       type === 'warning' ? 'bi-exclamation-triangle' : 
                       type === 'primary' ? 'bi-info-circle' : 'bi-info-circle';
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi ${iconClass} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      container.appendChild(toast);
      
      // Initialize Bootstrap toast
      try {
        const bsToast = new bootstrap.Toast(toast, {
          autohide: true,
          delay: duration
        });
        bsToast.show();
      } catch (e) {
        // Fallback if Bootstrap is not available
        toast.style.opacity = '1';
        setTimeout(() => {
          toast.style.transition = 'opacity 0.5s ease-out';
          toast.style.opacity = '0';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 500);
        }, duration);
      }
      
      // Auto-remove from DOM after hiding
      toast.addEventListener('hidden.bs.toast', () => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      });
    }
    
    // Utility toast functions for common scenarios
    window.showSuccessToast = function(message, duration = 4000) {
      showToast(message, 'success', duration);
    };
    
    window.showErrorToast = function(message, duration = 6000) {
      showToast(message, 'error', duration);
    };
    
    window.showWarningToast = function(message, duration = 5000) {
      showToast(message, 'warning', duration);
    };
    
    window.showInfoToast = function(message, duration = 4000) {
      showToast(message, 'info', duration);
    };
    
    // Global function to get team with date context for capacity calculations
    window.getTeamWithDate = function(teamId, targetDate = null) {
      const team = getTeam(teamId);
      if (!team) return null;
      
      // If no target date, return the team as-is
      if (!targetDate) return team;
      
      // Return a team object with capacity calculated for the specific date
      return {
        ...team,
        getCapacityForDate: function(date) {
          return getTeamSizesForDate(team, date);
        }
      };
    };
    
    // Helper function to call aggregate with team members data
    window.aggregateWithTeamMembers = function(plan, tasks, getTeam, targetDate = null) {
      return aggregate(plan, tasks, getTeam, targetDate, state.teamMembers);
    };
  </script>

</body>
</html>
