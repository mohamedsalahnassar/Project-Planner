<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Project Planner (v20)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --bg-grad-start:#0e1e45; --bg-grad-end:transparent;
      --ios:#4e79a7; --android:#59a14f; --web:#f28e2c; --be:#9c755f; --qa:#edc948;
      --label-pad: 180px;
    }
    body{background-image: radial-gradient(1200px 700px at 15% -10%, var(--bg-grad-start) 0%, var(--bg-grad-end) 60%); background-attachment: fixed;}
    .app-header{position:sticky;top:0;z-index:1030;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08);}
    .pointer{cursor:pointer}
    .card-hover{transition:box-shadow .2s, transform .1s; cursor:pointer}
    .card-hover:hover{box-shadow:0 8px 30px rgba(0,0,0,.25); transform:translateY(-2px)}
    .mini-timeline{border-radius:.5rem;border:1px solid var(--bs-border-color); overflow:hidden}
    .mini-phase{height:8px;background:var(--bs-border-color);opacity:.6; position:relative}
    .mini-platforms{height:8px;display:flex}
    .seg-ios{background:var(--ios)} .seg-android{background:var(--android)} .seg-web{background:var(--web)} .seg-be{background:var(--be)} .seg-qa{background:var(--qa)}
    .gantt-wrap{border:1px solid var(--bs-border-color); border-radius:.75rem; overflow:hidden}
    .gantt-toolbar{position:sticky;top:0;z-index:2;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color)}
    .gantt{position:relative; height:540px; overflow:auto; cursor:grab}
    .gantt:active{cursor:grabbing}
    .gantt .content{position:relative}
    .ruler{position:sticky; top:0; height:60px; background:linear-gradient(180deg, var(--bs-body-bg), var(--bs-body-bg) 62%, transparent); margin-left:var(--label-pad); border-bottom:1px solid var(--bs-border-color); z-index:1}
    .tick{position:absolute; bottom:0; width:1px; height:12px; background:rgba(127,127,127,.35)}
    .tick.major{height:24px; background:rgba(127,127,127,.6)}
    .label{position:absolute; bottom:24px; transform:translateX(-50%); font-size:.75rem; color:var(--bs-secondary-color)}
    .month{position:absolute; bottom:44px; transform:translateX(-50%); font-weight:600; color:var(--bs-body-color); font-size:.8rem}
    .grid{position:absolute; left:0; right:0; top:60px; bottom:0; pointer-events:none}
    .gridline{position:absolute; top:0; bottom:0; width:1px; background:rgba(127,127,127,.15)}
    .gridline.major{background:rgba(127,127,127,.28)}
    .lane{position:relative; height:64px; border-bottom:1px dashed var(--bs-border-color); display:flex; align-items:center}
    .lane-label{position:absolute; left:12px; top:18px; width:160px; font-weight:600}
    .bar{position:absolute; top:16px; height:32px; border-radius:.5rem; display:flex; align-items:center; padding:0 .6rem; color:#000; font-weight:700; border:1px solid rgba(0,0,0,.18); user-select:none}
    .bar.be{background:var(--be)} .bar.ios{background:var(--ios)} .bar.android{background:var(--android)} .bar.web{background:var(--web)} .bar.qa{background:var(--qa)}
    .phase-tag{position:absolute; top:66px; height:20px; padding:0 .5rem; border:1px dashed var(--bs-border-color); border-radius:.5rem; font-size:.75rem; display:flex; align-items:center; color:var(--bs-secondary-color)}
    .badge-lane{display:inline-flex;align-items:center;gap:.3rem}
    .badge-lane .dot{width:.7rem;height:.7rem;border-radius:50%}
    .detail-grid{grid-template-columns: 1.4fr 420px}
    @media (max-width: 1200px){ .detail-grid{grid-template-columns:1fr !important} }
    .pdf-sheet{width:1100px; margin:0 auto; padding:24px}
    .pdf-h1{font-size:24px; font-weight:700}
    .pdf-h2{font-size:20px; font-weight:700; margin-top:16px}
    .pdf-h3{font-size:16px; font-weight:700; margin-top:12px}
    .pdf-meta{color:#6c757d; font-size:.9rem}
    .pdf-card{border:1px solid #dee2e6; border-radius:12px; padding:16px; margin-top:12px}
  </style>
</head>
<body>
  <header class="app-header py-2 px-3">
    <div class="d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-3">
        <div>
          <h1 class="h5 mb-0">Project Planner <span class="text-secondary">(v20)</span></h1>

<div class="small text-secondary">Start: <b id="startLabel">2025-08-13</b> • Efficiency: <b id="effLabel">0.8</b> md/eng/day • Local JSON persistence</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="small text-secondary">Theme</span>
          <select id="themeSelect" class="form-select form-select-sm"></select>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group">
          <button id="btn-manage" class="btn btn-outline-primary"><i class="bi bi-sliders"></i> Configure</button>
          <div class="btn-group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-database"></i> Data</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" id="exportTasksCSV"><i class="bi bi-filetype-csv me-1"></i>Export Tasks (CSV)</a></li>
              <li><a class="dropdown-item" id="exportTasksXLSX"><i class="bi bi-filetype-xlsx me-1"></i>Export Tasks (Excel)</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><label class="dropdown-item pointer mb-0">
                <i class="bi bi-box-arrow-in-down me-1"></i>Import Tasks (CSV/Excel)
                <input id="importTasks" type="file" accept=".csv, .xlsx, .xls" hidden>
              </label></li>
            </ul>
          </div>
          <div class="btn-group">
            <button class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-filetype-xlsx"></i> Export Excel</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" id="btn-export-project-xlsx-styled"><i class="bi bi-palette me-1"></i>Project (Styled)</a></li>
              <li><a class="dropdown-item" id="btn-export-plan-xlsx-styled"><i class="bi bi-palette me-1"></i>Plan (Styled)</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" id="btn-export-project-xlsx"><i class="bi bi-table me-1"></i>Project (Basic)</a></li>
              <li><a class="dropdown-item" id="btn-export-plan-xlsx"><i class="bi bi-table me-1"></i>Plan (Basic)</a></li>
            </ul>
          </div>
          <button id="btn-export" class="btn btn-outline-secondary"><i class="bi bi-box-arrow-down"></i> Export JSON</button>
          <label class="btn btn-outline-secondary mb-0 pointer">
            <i class="bi bi-upload"></i> Import <input id="file-import" type="file" accept=".json" hidden>
          </label>
          <button id="btn-reset" class="btn btn-outline-danger"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container-xxl py-3">
    <div id="projectsLayer" class="row g-3"></div>

    <div id="plansLayer" style="display:none">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center gap-2">
          <button id="btn-back-projects" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Projects</button>
          <h2 id="plans-title" class="h6 mb-0"></h2>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="btn-export-project-pdf" class="btn btn-primary btn-sm"><i class="bi bi-filetype-pdf"></i> Export Project PDF</button>
          <button id="btn-open-efforts" class="btn btn-outline-secondary btn-sm"><i class="bi bi-sliders"></i> Edit Task Efforts</button>
          <button id="btn-export-project-xlsx-basic" class="btn btn-success btn-sm"><i class="bi bi-filetype-xlsx"></i> Export Project Excel (Basic)</button>
        </div>
      </div>
      <div id="plansGrid" class="row g-3"></div>
    </div>

    <div id="detail" class="mt-2" style="display:none">
      <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
        <div class="d-flex align-items-center gap-2">
          <button id="btn-back-plans" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Plans</button>
          <h2 id="detail-title" class="h6 mb-0"></h2>
          <span class="badge text-bg-secondary" id="detail-team"></span>
          <span class="badge text-bg-secondary">Buffer <span id="detail-buffer"></span>%</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="form-check form-check-inline"><input class="form-check-input lane-filter" type="checkbox" value="BE" id="chkBE" checked><label class="form-check-label" for="chkBE"><span class="badge-lane"><span class="dot" style="background:var(--be)"></span>BE</span></label></div>
          <div class="form-check form-check-inline"><input class="form-check-input lane-filter" type="checkbox" value="iOS" id="chkiOS" checked><label class="form-check-label" for="chkiOS"><span class="badge-lane"><span class="dot" style="background:var(--ios)"></span>iOS</span></label></div>
          <div class="form-check form-check-inline"><input class="form-check-input lane-filter" type="checkbox" value="Android" id="chkAndroid" checked><label class="form-check-label" for="chkAndroid"><span class="badge-lane"><span class="dot" style="background:var(--android)"></span>Android</span></label></div>
          <div class="form-check form-check-inline"><input class="form-check-input lane-filter" type="checkbox" value="Online" id="chkOnline" checked><label class="form-check-label" for="chkOnline"><span class="badge-lane"><span class="dot" style="background:var(--web)"></span>Web</span></label></div>
          <div class="form-check form-check-inline"><input class="form-check-input lane-filter" type="checkbox" value="QA" id="chkQA" checked><label class="form-check-label" for="chkQA"><span class="badge-lane"><span class="dot" style="background:var(--qa)"></span>QA</span></label></div>
          <button id="btn-export-plan-pdf" class="btn btn-primary btn-sm"><i class="bi bi-filetype-pdf"></i> Export Plan PDF</button>
          <button id="btn-export-plan-xlsx-basic" class="btn btn-success btn-sm"><i class="bi bi-filetype-xlsx"></i> Export Plan Excel (Basic)</button>
        </div>
      </div>

      <div class="detail-grid d-grid" style="gap:1rem">
        <div class="gantt-wrap">
          <div class="gantt-toolbar p-2 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <span class="small text-secondary">Zoom</span>
              <button class="btn btn-sm btn-outline-secondary" id="zoomMinus">−</button>
              <input type="range" id="zoomRange" min="6" max="44" step="2" value="18" style="width:240px">
              <button class="btn btn-sm btn-outline-secondary" id="zoomPlus">+</button>
              <button class="btn btn-sm btn-outline-secondary" id="zoomFit">Fit</button>
            </div>
            <div class="small text-secondary">Drag any bar to shift dates. Click a bar to view task breakdown.</div>
          </div>
          <div class="gantt" id="ganttScroll">
            <div class="content" id="ganttContent"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Effort breakdown (totals by phase)</div>
          <div class="card-body">
            <div class="small text-secondary mb-2" id="detail-span"></div>
            <div class="table-responsive">
              <table id="effTable" class="table table-sm table-bordered mb-0 align-middle">
                <thead class="table-dark">
                  <tr><th>Phase</th><th>BE</th><th>iOS</th><th>Android</th><th>Online</th><th>QA</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span>Detailed Phase → Task effort breakdown</span>
          <div class="small text-secondary">Explicit task efforts are honored; otherwise FE/QA efforts are distributed across FE tasks in a phase.</div>
        </div>
        <div class="card-body">
          <div class="accordion" id="phaseBreakdown"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Manage Modal (CRUD Console) -->
  <div class="modal fade" id="manageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-sliders"></i> Configure</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs" id="manageTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-projects" data-bs-toggle="tab" data-bs-target="#pane-projects" type="button" role="tab">Projects</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-plans" data-bs-toggle="tab" data-bs-target="#pane-plans" type="button" role="tab">Delivery Plans</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-phases" data-bs-toggle="tab" data-bs-target="#pane-phases" type="button" role="tab">Phases</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-teams" data-bs-toggle="tab" data-bs-target="#pane-teams" type="button" role="tab">Teams</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-tasks" data-bs-toggle="tab" data-bs-target="#pane-tasks" type="button" role="tab">Tasks</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-phase-tasks" data-bs-toggle="tab" data-bs-target="#pane-phase-tasks" type="button" role="tab">Phase Tasks</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-efforts" data-bs-toggle="tab" data-bs-target="#pane-efforts" type="button" role="tab">Efforts</button>
  </li>
  <li class="nav-item ms-auto" role="presentation">
    <button class="nav-link" id="tab-general" data-bs-toggle="tab" data-bs-target="#pane-general" type="button" role="tab"><i class="bi bi-gear"></i> General</button>
  </li>
</ul>
          <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="pane-projects" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-projects" class="form-control" placeholder="Search projects">
                </div>
                <button class="btn btn-primary" id="btn-add-project"><i class="bi bi-plus-lg"></i> Add Project</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-projects">
                  <thead><tr><th style="width:25%">Name</th><th>Description</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-plans" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-plans" class="form-control" placeholder="Search delivery plans">
                </div>
                <button class="btn btn-primary" id="btn-add-plan"><i class="bi bi-plus-lg"></i> Add Delivery Plan</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-plans">
                  <thead><tr><th>Title</th><th>Project</th><th>Team</th><th>Phases</th><th>Buffer%</th><th style="width:260px">Mini Timeline</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-phases" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-phases" class="form-control" placeholder="Search phases">
                </div>
                <button class="btn btn-primary" id="btn-add-phase"><i class="bi bi-plus-lg"></i> Add Phase</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-phases">
                  <thead><tr><th style="width:25%">Title</th><th>Description</th><th style="width:10%">Order</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-teams" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-teams" class="form-control" placeholder="Search teams">
                </div>
                <button class="btn btn-primary" id="btn-add-team"><i class="bi bi-plus-lg"></i> Add Team</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-teams">
                  <thead><tr><th>Name</th><th>BE</th><th>iOS</th><th>Android</th><th>Online</th><th>QA</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-tasks" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="input-group" style="max-width:360px">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="search-tasks" class="form-control" placeholder="Search tasks">
                </div>
                <button class="btn btn-primary" id="btn-add-task"><i class="bi bi-plus-lg"></i> Add Task</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-tasks">
                  <thead><tr><th style="width:28%">Title</th><th style="width:12%">Start</th><th style="width:18%">Project</th><th style="width:12%">Viable</th><th>Efforts</th><th style="width:15%">ID</th><th style="width:160px">Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="pane-phase-tasks" role="tabpanel">
              <div class="d-flex align-items-center gap-2 mb-2">
                <label class="form-label mb-0">Project</label>
                <select id="pt-proj" class="form-select" style="max-width:240px"></select>
                <button id="pt-save" class="btn btn-primary btn-sm"><i class="bi bi-check2"></i> Save</button>
              </div>
              <div id="phaseTaskContainers" class="d-flex flex-wrap gap-3"></div>
            </div>

            <div class="tab-pane fade" id="pane-efforts" role="tabpanel">
  <div class="d-flex align-items-center gap-2 mb-2">
    <label class="form-label mb-0">Project</label>
    <select id="eff-proj" class="form-select" style="max-width:240px"></select>
    <input id="eff-search" class="form-control" placeholder="Search tasks" style="max-width:260px">
    <button id="eff-save" class="btn btn-primary btn-sm"><i class="bi bi-check2"></i> Save</button>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="tbl-eff">
      <thead>
        <tr><th style="width:15%">Task ID</th><th>Title</th><th style="width:10%">BE</th><th style="width:10%">iOS</th><th style="width:10%">Android</th><th style="width:10%">Online</th><th style="width:10%">QA</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="tab-pane fade" id="pane-general" role="tabpanel">
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-header">Scheduling</div>
                    <div class="card-body vstack gap-3">
                      <div><label class="form-label">Global start date</label><input id="gen-start" type="date" class="form-control"></div>
                      <div><label class="form-label">Efficiency (md per engineer per day)</label><input id="gen-eff" type="number" step="0.05" min="0.2" max="1.2" class="form-control"></div>
                      <div><label class="form-label">Default zoom (px per day)</label><input id="gen-px" type="number" min="6" max="44" step="1" class="form-control"></div>
                      <div class="form-check form-switch"><input id="gen-rtl" class="form-check-input" type="checkbox"><label class="form-check-label" for="gen-rtl">Enable RTL layout</label></div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-lg-6">
                  <div class="card">
                    <div class="card-header">Appearance</div>
                    <div class="card-body vstack gap-3">
                      <div><label class="form-label">Theme</label>
                        <select id="gen-theme" class="form-select"></select>
                      </div>
                      <div class="small text-secondary">Themes adjust background and platform colors (BE/iOS/Android/Web/QA). Changes persist.</div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="gen-save"><i class="bi bi-check2"></i> Save Settings</button>
                    <button class="btn btn-outline-secondary" id="gen-apply-px"><i class="bi bi-arrows"></i> Apply default zoom to all plans</button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <div class="text-secondary small me-auto">Storage key: <code>project_planner_v20</code></div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" id="btn-save-manage">Save All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTitle">Edit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" class="vstack gap-3"></form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger me-auto d-none" id="editDelete"><i class="bi bi-trash"></i> Delete</button>
          <button class="btn btn-primary" id="editSave"><i class="bi bi-check2"></i> Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Breakdown Modal -->
  <div class="modal fade" id="breakdownModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="breakdownTitle">Task Breakdown</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3" id="bdTabs"></ul>
          <div id="bdContent"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="appToast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Saved</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- XLSX / XlsxPopulate / Chart.js resilient loaders -->
  <script>
    const XLSX_SOURCES = [
      "https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js",
      "https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"
    ];
    const XPOP_SOURCES = [
      "https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js",
      "https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"
    ];
    const CHART_SOURCES = [
      "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.3/chart.umd.min.js",
      "https://unpkg.com/chart.js@4.4.3/dist/chart.umd.min.js"
    ];
    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s=document.createElement('script');
        s.src=src; s.async=true; s.type='text/javascript'; s.crossOrigin='anonymous'; s.onload=()=>resolve(src); s.onerror=()=>reject(src);
        document.head.appendChild(s);
      });
    }
    async function ensureXLSX(){ if(window.XLSX) return true; for(const src of XLSX_SOURCES){ try{ await loadScript(src); if(window.XLSX) return true; }catch(e){} } return !!window.XLSX; }
    async function ensureXPOP(){ if(window.XlsxPopulate) return true; for(const src of XPOP_SOURCES){ try{ await loadScript(src); if(window.XlsxPopulate) return true; }catch(e){} } return !!window.XlsxPopulate; }
    async function ensureCHART(){ if(window.Chart) return true; for(const src of CHART_SOURCES){ try{ await loadScript(src); if(window.Chart) return true; }catch(e){} } return !!window.Chart; }
  </script>

  <script type="module">
      import { aggregate, computeSchedule } from './schedule.js';
      import { exportPlanJSON, importPlanJSON, validateColumns } from './export.js';
      import { state, load, save, getTeam, getPhase, getProject, replaceState } from './data.js';
      load();
    /* ===================== APP CODE (v20) ===================== */
    const STORAGE_KEY = "project_planner_v20";
    const dayMs = 86400000;

    const THEMES = {
      "Dark":     { bs:"dark", vars:{ bgStart:"#0e1e45", bgEnd:"transparent", ios:"#4e79a7", android:"#59a14f", web:"#f28e2c", be:"#9c755f", qa:"#edc948" } },
      "Light":    { bs:"light", vars:{ bgStart:"#e8eefc", bgEnd:"transparent", ios:"#356dab", android:"#2b8a3e", web:"#e3821b", be:"#7f5b4b", qa:"#bfa63a" } },
      "Midnight": { bs:"dark", vars:{ bgStart:"#090b1a", bgEnd:"transparent", ios:"#6ea8fe", android:"#63e6be", web:"#ffd43b", be:"#e599f7", qa:"#ffa8a8" } },
      "Emerald":  { bs:"dark", vars:{ bgStart:"#0a352e", bgEnd:"transparent", ios:"#77c3ff", android:"#4dd4ac", web:"#ffd08a", be:"#cfa8a1", qa:"#ffe066" } },
      "Royal":    { bs:"dark", vars:{ bgStart:"#1b2a4a", bgEnd:"transparent", ios:"#5ab0ff", android:"#78e08f", web:"#ffb347", be:"#b58e7c", qa:"#ffe066" } },
      "Ocean":    { bs:"dark", vars:{ bgStart:"#022c43", bgEnd:"transparent", ios:"#00a8cc", android:"#00c49a", web:"#f6b93b", be:"#ee5253", qa:"#48dbfb" } },
      "Sunset":   { bs:"light", vars:{ bgStart:"#fff3e0", bgEnd:"transparent", ios:"#ef5350", android:"#66bb6a", web:"#ffa726", be:"#8d6e63", qa:"#ffd54f" } },
      "Forest":   { bs:"dark", vars:{ bgStart:"#003311", bgEnd:"transparent", ios:"#66bb6a", android:"#43a047", web:"#c0ca33", be:"#8d6e63", qa:"#ffd54f" } },
      "Mono":     { bs:"light", vars:{ bgStart:"#f0f0f0", bgEnd:"transparent", ios:"#5c5c5c", android:"#787878", web:"#a0a0a0", be:"#3a3a3a", qa:"#c0c0c0" } },
      "High Contrast": { bs:"dark", vars:{ bgStart:"#000", bgEnd:"transparent", ios:"#00e5ff", android:"#00ff6a", web:"#ffea00", be:"#ff1744", qa:"#ffffff" } },
      "Solarized":{ bs:"light", vars:{ bgStart:"#fdf6e3", bgEnd:"transparent", ios:"#268bd2", android:"#2aa198", web:"#b58900", be:"#6c71c4", qa:"#859900" } },
      "Candy":    { bs:"light", vars:{ bgStart:"#ffe6f2", bgEnd:"transparent", ios:"#ff6fb5", android:"#6fffb0", web:"#ffd166", be:"#f28482", qa:"#a0c4ff" } }
    };

    const DEFAULT_DATA = {
      meta: { version: 20, startDate: "2025-08-13", efficiency: 0.8, theme: "Dark", rtl: false, defaultPxPerDay: 18 },
      projects: [{ id: "proj-sample", name: "Sample Project", description: "Generic project" }],
      teams: [
        { id:"team-base", name:"Base Squad", sizes:{BE:3,iOS:2,Android:2,Online:2,QA:3} },
        { id:"team-scaled", name:"Scaled Squad", sizes:{BE:3,iOS:4,Android:4,Online:4,QA:4} }
      ],
      phases: [
        { id:"P1", name:"Phase 1", description:"Entry points + Survey/Registration + Dashboard core", order:1 },
        { id:"P2", name:"Phase 2", description:"Content widgets and partner integration", order:2 },
        { id:"ALL", name:"One-shot", description:"All scope in a single release", order:1 }
      ],
      proposals: [
        { id:"prop1", projectId:"proj-sample", title:"Two Phases (Base Squad)", description:"Two-phase rollout with base team", teamId:"team-base", bufferPct:12, phaseIds:["P1","P2"], pxPerDay:18, overrides:{} },
        { id:"prop2a", projectId:"proj-sample", title:"Two Phases (Scaled Squad)", description:"Two-phase rollout with scaled team", teamId:"team-scaled", bufferPct:12, phaseIds:["P1","P2"], pxPerDay:18, overrides:{} },
        { id:"prop2b", projectId:"proj-sample", title:"One‑Shot (Scaled Squad)", description:"All scope in one release, scaled team", teamId:"team-scaled", bufferPct:12, phaseIds:["ALL"], pxPerDay:18, overrides:{} }
      ],
      tasks: []
    };

    const seedTasks = [
      "EP1|Dashboard entry tile/banner", "EP2|Accounts/Transactions CTA", "EP3|Notifications/Inbox CTA", "EP4|Settings: feature toggle & consent",
      "SR1|Consent soft-enable & opt-out","SR2|Registration stepper","SR3|Survey engine (CMS-driven)","SR4|Submit survey to BE & success",
      "DB1|Dashboard shell & skeleton","DB2|Monthly CO₂ summary","DB3|Category breakdown chart (CMS colors)","DB4|Trend period switcher (3/6/9/12m)",
      "DB5|Txn badges & details view","DB6|Empty/error/offline states","DB7|i18n/RTL & a11y polish","DB8|Analytics + feature flags",
      "CT1|Recommendations module","CT2|Tips module","CT3|Articles module","CT4|Journal module","CT5|Deals module (if enabled)",
      "LX1|Partner theming & layout adaptation","LX2|Partner release & monitoring",
      "AT1|Cucumber repo & smoke","AT2|Nightly & regression growth"
    ];
    DEFAULT_DATA.tasks = seedTasks.map(s=>{
      const [id, title] = s.split("|");
      return {id, title, projectId:"proj-sample", startDate:"", efforts:[], assignments:[{proposalId:"prop1",phaseId: id.startsWith("CT")||id.startsWith("LX")||id==="AT2"?"P2":"P1"}, {proposalId:"prop2a",phaseId: id.startsWith("CT")||id.startsWith("LX")||id==="AT2"?"P2":"P1"}, {proposalId:"prop2b",phaseId:"ALL"}]};
    });
    DEFAULT_DATA.tasks.push({id:"TBE1", title:"BE: APIs & integration (Phase 1)", projectId:"proj-sample", startDate:"", efforts:[{platform:"BE",manDays:74}], assignments:[{proposalId:"prop1",phaseId:"P1"},{proposalId:"prop2a",phaseId:"P1"}]});
    DEFAULT_DATA.tasks.push({id:"TBE2", title:"BE: APIs & integration (Phase 2)", projectId:"proj-sample", startDate:"", efforts:[{platform:"BE",manDays:24}], assignments:[{proposalId:"prop1",phaseId:"P2"},{proposalId:"prop2a",phaseId:"P2"}]});
    DEFAULT_DATA.tasks.push({id:"TBE3", title:"BE: APIs & integration (One-shot)", projectId:"proj-sample", startDate:"", efforts:[{platform:"BE",manDays:98}], assignments:[{proposalId:"prop2b",phaseId:"ALL"}]});

    const BASELINE = {
      "prop1": {"P1":{"iOS":70,"Android":57,"Online":52,"QA":30,"BE":0},"P2":{"iOS":37,"Android":30,"Online":28,"QA":30,"BE":0}},
      "prop2a":{"P1":{"iOS":70,"Android":57,"Online":52,"QA":30,"BE":0},"P2":{"iOS":37,"Android":30,"Online":28,"QA":30,"BE":0}},
      "prop2b":{"ALL":{"iOS":107,"Android":87,"Online":80,"QA":60,"BE":0}}
    };
      const FE_IDS = new Set(seedTasks.map(s=> s.split("|")[0]));

      if(!state.projects.length){
        replaceState(structuredClone(DEFAULT_DATA));
        save();
      }

  function seedEffortsFromBaselineGlobal(){
  try{
    const seen = new Set();
    (state.proposals||[]).forEach(plan=>{
      (plan.phaseIds||[]).forEach(phId=>{
        const base = (BASELINE[plan.id]||{})[phId];
        if(!base) return;
        const tasks = (state.tasks||[]).filter(t=> t.projectId===plan.projectId
          && (t.assignments||[]).some(a=> a.proposalId===plan.id && a.phaseId===phId)
          && FE_IDS.has(t.id));
        const feCount = Math.max(1, tasks.length);
        tasks.forEach(t=>{
          if((t.efforts||[]).length) return;
          if(seen.has(t.id)) return;
          const ios = +(((+base.iOS||0)/feCount).toFixed(1));
          const andr = +(((+base.Android||0)/feCount).toFixed(1));
          const onl = +(((+base.Online||0)/feCount).toFixed(1));
          const qa = +(((+base.QA||0)/feCount).toFixed(1));
          t.efforts = [];
          if(ios>0) t.efforts.push({platform:"iOS", manDays: ios});
          if(andr>0) t.efforts.push({platform:"Android", manDays: andr});
          if(onl>0) t.efforts.push({platform:"Online", manDays: onl});
          if(qa>0) t.efforts.push({platform:"QA", manDays: qa});
          seen.add(t.id);
        });
      });
    });
  }catch(e){ console.warn('seedEffortsFromBaselineGlobal failed', e); }
}



    /* ---------- State ---------- */
    function toast(msg){ const el=document.getElementById('appToast'); document.getElementById('toastBody').textContent=msg; const t=new bootstrap.Toast(el,{delay:1400}); t.show(); }
    function byId(id){ return document.getElementById(id); }
    function daysBetween(a,b){ return Math.ceil((b-a)/dayMs); }
    function fmt(d){ return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); }
    function iso(d){ return d.toISOString().slice(0,10); }
    function escapeHtml(s){
      return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }
    function getProposal(id){ return (state.proposals||[]).find(p=> p.id===id); }
    function slug(s){ return (s||"").replace(/[^A-Za-z0-9]+/g,'_').slice(0,28) || 'Sheet'; }

    
        // Excel worksheet names must be <= 31 chars. Compose safely.
        function sheetName(base, suffix=""){
          const suf = suffix || "";
          const MAX = 31;
          const safe = String(base||"").replace(/[^A-Za-z0-9]+/g, "_");
          const avail = Math.max(1, MAX - suf.length);
          return (safe.slice(0, avail) + suf) || "Sheet";
        }
        /* ---------- Theme ---------- */
    function fillThemes(){
      const sel1 = byId('themeSelect'), sel2 = byId('gen-theme');
      sel1.innerHTML = sel2.innerHTML = Object.keys(THEMES).map(n=> `<option>${n}</option>`).join('');
      sel1.value = state.meta.theme || "Dark";
      sel2.value = state.meta.theme || "Dark";
    }
    function applyTheme(name){
      const t = THEMES[name] || THEMES.Dark;
      document.documentElement.setAttribute('data-bs-theme', t.bs);
      document.documentElement.style.setProperty('--bg-grad-start', t.vars.bgStart);
      document.documentElement.style.setProperty('--bg-grad-end', t.vars.bgEnd);
      document.documentElement.style.setProperty('--ios', t.vars.ios);
      document.documentElement.style.setProperty('--android', t.vars.android);
      document.documentElement.style.setProperty('--web', t.vars.web);
      document.documentElement.style.setProperty('--be', t.vars.be);
      document.documentElement.style.setProperty('--qa', t.vars.qa);
      byId('themeSelect').value = name;
      byId('gen-theme').value = name;
    }

    /* ---------- Aggregation & Schedule ---------- */
    
    // Populate per-assignment efforts from BASELINE so calculations come from tasks directly.
    

    /* ---------- UI: Dashboard ---------- */
    function buildProjects(){
      byId('projectsLayer').innerHTML='';
      byId('plansLayer').style.display='none';
      byId('detail').style.display='none';
      state.projects.forEach(pr=>{
        const col = document.createElement('div'); col.className='col-12 col-md-6 col-xl-4';
        col.innerHTML = `<div class="card card-hover h-100"><div class="card-body d-flex flex-column gap-2">
          <h5 class="card-title mb-0">${pr.name}</h5>
          <div class="text-secondary small">${pr.description||''}</div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div class="small text-secondary">Plans: <b>${state.proposals.filter(p=>p.projectId===pr.id).length}</b></div>
            <button class="btn btn-outline-primary btn-sm">Open</button>
          </div>
        </div></div>`;
        col.querySelector('button').onclick = ()=> openProject(pr.id);
        byId('projectsLayer').appendChild(col);
      });
    }
    function openProject(projectId){
      const pr = getProject(projectId); if(!pr) return;
      byId('projectsLayer').innerHTML='';
      byId('plansLayer').style.display='block';
      byId('detail').style.display='none';
      byId('plans-title').textContent = pr.name + " — Delivery Plans";
      const grid = byId('plansGrid'); grid.innerHTML='';
      const plans = state.proposals.filter(p=>p.projectId===projectId);
      plans.forEach(p=> grid.appendChild(planCard(p)));
      byId('btn-back-projects').onclick = ()=> { try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); };
      byId('btn-export-project-pdf').onclick = ()=> exportProjectPDF(projectId);
      byId('btn-export-project-xlsx-basic').onclick = ()=> exportProjectExcel(projectId);
      if(byId('btn-open-efforts')){ byId('btn-open-efforts').onclick = ()=>{ const mm=new bootstrap.Modal(byId('manageModal')); mm.show(); byId('tab-efforts').click(); byId('eff-proj').value = projectId; byId('eff-proj').dispatchEvent(new Event('change')); }; }
    }
    function planCard(p){
      const aggr = aggregate(p, state.tasks, getTeam);
      const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      const totals = {BE:0,iOS:0,Android:0,Online:0,QA:0};
      Object.values(aggr.phaseTotals).forEach(pt=>{ for(const k in totals){ totals[k]+=(pt[k]||0);} });
      for(const k in totals) totals[k] = +totals[k].toFixed(1);
      const sumEff = totals.BE + totals.iOS + totals.Android + totals.Online + totals.QA || 1;
      const segBE=Math.max(2,Math.round(260*(totals.BE/sumEff)));
      const segiOS=Math.max(2,Math.round(260*(totals.iOS/sumEff)));
      const segAndroid=Math.max(2,Math.round(260*(totals.Android/sumEff)));
      const segWeb=Math.max(2,Math.round(260*(totals.Online/sumEff)));
      const segQA=260-segBE-segiOS-segAndroid-segWeb;
      const startStr = fmt(sched.chartStart), endStr = fmt(sched.chartEnd);
      const phases = p.phaseIds.map(id=> getPhase(id)?.name||id).join(' · ');
      const col = document.createElement('div'); col.className='col-12 col-md-6 col-xl-4';
      col.innerHTML = `<div class="card card-hover h-100" data-plan="${p.id}"><div class="card-body d-flex flex-column gap-2">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div><h5 class="card-title mb-0">${p.title}</h5><div class="text-secondary small">${p.description||''}</div></div>
          <div class="text-end">
            <div class="small text-secondary">${startStr} → ${endStr}</div>
            <div class="small">Team: <b>${getTeam(p.teamId)?.name||'—'}</b></div>
            <div class="small">Phases: ${phases}</div>
          </div>
        </div>
        <div class="mini-timeline">
          <div class="mini-phase">
            ${p.phaseIds.map((phId, i)=>`<div class="position-absolute top-0" style="left:${Math.round((i/p.phaseIds.length)*100)}%;height:8px;border-left:1px solid rgba(255,255,255,.35)"><span class="position-absolute top-100 start-0 translate-middle-x" style="font-size:.65rem">${getPhase(phId)?.name||phId}</span></div>`).join('')}
          </div>
          <div class="mini-platforms">
            <div class="seg-be" style="width:${segBE}px"></div>
            <div class="seg-ios" style="width:${segiOS}px"></div>
            <div class="seg-android" style="width:${segAndroid}px"></div>
            <div class="seg-web" style="width:${segWeb}px"></div>
            <div class="seg-qa" style="width:${Math.max(2,segQA)}px"></div>
          </div>
        </div>
        <div class="row row-cols-5 g-2 text-center">
          ${['BE','iOS','Android','Online','QA'].map(k=> `<div class="col"><div class="border rounded p-2"><div class="small text-secondary">${k}</div><div class="fw-bold">${totals[k]}</div><div class="small text-secondary">md</div></div></div>`).join('')}
        </div>
      </div></div>`;
      col.querySelector('.card').onclick = ()=> openDetail(p.id);
      return col;
    }

    /* ---------- Detail ---------- */
    let currentPlanId = null;
    function openDetail(planId){
      const p = state.proposals.find(x=>x.id===planId); if(!p) return;
      currentPlanId = planId;
      byId('plansLayer').style.display='none';
      byId('detail').style.display='block';
      const aggr = aggregate(p, state.tasks, getTeam);
      const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      byId('detail-title').textContent = p.title;
      byId('detail-team').textContent = getTeam(p.teamId)?.name || '—';
      byId('detail-buffer').textContent = p.bufferPct||0;
      const totalDays = Math.max(1, daysBetween(sched.chartStart, sched.chartEnd)+1);
      byId('detail-span').textContent = `${fmt(sched.chartStart)} → ${fmt(sched.chartEnd)} • ${totalDays} days`;
      const tb = byId('effTable').querySelector('tbody'); tb.innerHTML = '';
      p.phaseIds.forEach(pid=>{
        const t = aggr.phaseTotals[pid] || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${getPhase(pid)?.name||pid}</td>
          <td>${(t.BE||0).toFixed(1)}</td>
          <td>${(t.iOS||0).toFixed(1)}</td>
          <td>${(t.Android||0).toFixed(1)}</td>
          <td>${(t.Online||0).toFixed(1)}</td>
          <td>${(t.QA||0).toFixed(1)}</td>`;
        tb.appendChild(tr);
      });
      drawGantt(p, sched);
      renderPhaseBreakdownTables(p);
      document.querySelectorAll('.lane-filter').forEach(chk=> chk.onchange = ()=> drawGantt(p, computeSchedule(p, aggregate(p, state.tasks, getTeam), state.meta.efficiency, getPhase, state.meta.startDate)));
      byId('zoomRange').value = p.pxPerDay || state.meta.defaultPxPerDay || 18;
      byId('btn-back-plans').onclick = ()=> { openProject(p.projectId); };
      byId('btn-export-plan-pdf').onclick = ()=> exportPlanPDF(p.id);
      byId('btn-export-plan-xlsx-basic').onclick = ()=> exportPlanExcel(p.id);
    }
    function dayTicks(pxPerDay){
      if(pxPerDay >= 36) return { minor:1, labelEvery:2 };
      if(pxPerDay >= 28) return { minor:2, labelEvery:4 };
      if(pxPerDay >= 20) return { minor:3, labelEvery:6 };
      if(pxPerDay >= 14) return { minor:7, labelEvery:14 };
      return { minor:14, labelEvery:28 };
    }
    function drawGantt(p, sched){
      const container = byId('ganttContent');
      const scroll = byId('ganttScroll');
      container.innerHTML = '';
      const pxPerDay = p.pxPerDay || state.meta.defaultPxPerDay || 18;
      const totalDays = Math.max(1, daysBetween(sched.chartStart, sched.chartEnd)+1);
      const labelPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--label-pad'));
      const width = totalDays * pxPerDay + labelPad;
      const lanesOn = Array.from(document.querySelectorAll('.lane-filter')).filter(x=>x.checked).map(x=>x.value);
      sched.lanes.filter(l=> lanesOn.includes(l.key)).forEach(l=>{
        const lane = document.createElement('div'); lane.className='lane'; lane.style.width = width+'px'; lane.dataset.lane=l.key;
        const label = document.createElement('div'); label.className='lane-label'; label.textContent = l.name; lane.appendChild(label);
        sched.phaseWindows.forEach(w=>{
          const li = w.lanes.find(x=>x.key===l.key);
          const offset = Math.floor(((li.start - sched.chartStart)/dayMs) * pxPerDay) + labelPad;
          const bar = document.createElement('div'); bar.className = `bar ${l.cls}`; bar.style.left = offset+'px'; bar.style.width = (Math.max(1, li.days)*pxPerDay)+'px';
          bar.textContent = w.ph; bar.title = `${l.name} • ${w.ph} • ${fmt(li.start)} (${li.days}d)`;
          bar.dataset.lane = l.key; bar.dataset.phase = w.ph;
          makeDraggableBar(bar, p, sched, li.days);
          bar.addEventListener('click', (ev)=>{ ev.stopPropagation(); openBreakdown(p, w.ph, l.key); });
          lane.appendChild(bar);
        });
        container.appendChild(lane);
      });
      drawRulerAndGrid(scroll, sched.chartStart, totalDays, pxPerDay, container.scrollHeight || 0, sched.phaseWindows);
      const zr = byId('zoomRange'), zm = byId('zoomMinus'), zp = byId('zoomPlus'), zf = byId('zoomFit');
      zr.oninput = (e)=>{ p.pxPerDay = +e.target.value; save(); openDetail(p.id); };
      zm.onclick = ()=>{ p.pxPerDay = Math.max(6, (p.pxPerDay||pxPerDay)-2); save(); openDetail(p.id); };
      zp.onclick = ()=>{ p.pxPerDay = Math.min(44, (p.pxPerDay||pxPerDay)+2); save(); openDetail(p.id); };
      zf.onclick = ()=>{
        const visible = byId('ganttScroll').clientWidth - labelPad - 20;
        const fit = Math.max(6, Math.min(44, Math.floor(visible/totalDays)));
        p.pxPerDay = fit; save(); openDetail(p.id);
      };
      let isDown=false, startX=0, scrollLeft=0;
      scroll.addEventListener('mousedown', e=>{ if(e.target.classList.contains('bar')) return; isDown=true; startX=e.pageX - scroll.offsetLeft; scrollLeft=scroll.scrollLeft; });
      window.addEventListener('mouseup', ()=> isDown=false);
      scroll.addEventListener('mousemove', e=>{ if(!isDown) return; e.preventDefault(); const x=e.pageX - scroll.offsetLeft; const walk=(x-startX)*1.2; scroll.scrollLeft = scrollLeft - walk; });
    }
    function drawRulerAndGrid(scroll, chartStart, totalDays, pxPerDay, contentHeight, phaseWindows){
      scroll.querySelectorAll('.ruler,.grid,.phase-tag').forEach(n=> n.remove());
      const labelPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--label-pad'));
      const ruler = document.createElement('div'); ruler.className='ruler'; ruler.style.width = (totalDays*pxPerDay + labelPad) + 'px'; scroll.appendChild(ruler);
      const {minor, labelEvery} = dayTicks(pxPerDay);
      for(let d=0; d<=totalDays; d+=minor){
        const x = labelPad + d*pxPerDay;
        const tick = document.createElement('div'); tick.className='tick'; tick.style.left = x+'px'; ruler.appendChild(tick);
        if(d % labelEvery === 0){
          const label = document.createElement('div'); label.className='label'; label.style.left = x+'px';
          const dt = new Date(chartStart.getTime() + d*dayMs); label.textContent = dt.toLocaleDateString('en-GB',{day:'2-digit', month:'short'});
          ruler.appendChild(label);
        }
      }
      const firstMonth = new Date(chartStart); firstMonth.setDate(1);
      let m = new Date(firstMonth); if(m < chartStart) m.setMonth(m.getMonth()+1);
      while(m <= new Date(chartStart.getTime()+totalDays*dayMs)){
        const d = Math.floor((m-chartStart)/dayMs); const x = labelPad + d*pxPerDay;
        const tm = document.createElement('div'); tm.className='tick major'; tm.style.left = x+'px'; ruler.appendChild(tm);
        const ml = document.createElement('div'); ml.className='month'; ml.style.left = x+'px'; ml.textContent = m.toLocaleDateString('en-GB', { month:'short', year:'2-digit' }); ruler.appendChild(ml);
        m.setMonth(m.getMonth()+1);
      }
      const grid = document.createElement('div'); grid.className='grid'; grid.style.width = (totalDays*pxPerDay + labelPad) + 'px'; grid.style.height = (contentHeight - 60) + 'px'; scroll.appendChild(grid);
      const {minor:gn} = dayTicks(pxPerDay);
      for(let d=0; d<=totalDays; d+=gn){ const x = labelPad + d*pxPerDay; const gl = document.createElement('div'); gl.className='gridline'; gl.style.left = x+'px'; grid.appendChild(gl); }
      m = new Date(firstMonth); if(m < chartStart) m.setMonth(m.getMonth()+1);
      while(m <= new Date(chartStart.getTime()+totalDays*dayMs)){ const d = Math.floor((m-chartStart)/dayMs); const x = labelPad + d*pxPerDay; const gl = document.createElement('div'); gl.className='gridline major'; gl.style.left = x+'px'; grid.appendChild(gl); m.setMonth(m.getMonth()+1); }
      phaseWindows.forEach(w=>{
        const d0 = Math.floor((w.start - chartStart)/dayMs);
        const d1 = Math.floor((w.end - chartStart)/dayMs);
        const x = labelPad + d0*pxPerDay;
        const wpx = Math.max(1, (d1-d0+1)*pxPerDay);
        const tag = document.createElement('div'); tag.className='phase-tag'; tag.style.left = x+'px'; tag.style.width = wpx+'px'; tag.textContent = w.ph;
        scroll.appendChild(tag);
      });
    }
    function makeDraggableBar(bar, plan, sched, daysLen){
      let startX=0, origLeft=0, dragging=false;
      bar.addEventListener('mousedown', (e)=>{ dragging=true; startX=e.pageX; origLeft=parseInt(bar.style.left); document.body.style.userSelect='none'; });
      window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx = e.pageX - startX; bar.style.left = (origLeft + dx) + 'px'; });
      window.addEventListener('mouseup', ()=>{
        if(!dragging) return; dragging=false; document.body.style.userSelect='';
        const labelPad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--label-pad'));
        const left = parseInt(bar.style.left);
        const offsetPx = left - labelPad;
        const days = Math.max(0, Math.round(offsetPx / (plan.pxPerDay||state.meta.defaultPxPerDay||18)));
        const newDate = new Date(sched.chartStart.getTime() + days*dayMs);
        plan.overrides ||= {}; plan.overrides[bar.dataset.phase] ||= {}; plan.overrides[bar.dataset.phase][bar.dataset.lane] = iso(newDate);
        save(); openDetail(plan.id);
      });
    }

    /* ---------- Breakdown ---------- */
    
    
    function computeTaskEffortsForPhase(plan, phaseId){
      const tasks = state.tasks.filter(t=> t.projectId===plan.projectId && (t.assignments||[]).some(a=> a.proposalId===plan.id && a.phaseId===phaseId));
      const rows = [];
      const totals = {BE:0,iOS:0,Android:0,Online:0,QA:0,total:0};
      tasks.forEach(t=>{
        const eff = {BE:0,iOS:0,Android:0,Online:0,QA:0};
        (t.efforts||[]).forEach(e=>{ if(e.platform in eff){ eff[e.platform] += (+e.manDays||0); } });
        const sum = eff.BE+eff.iOS+eff.Android+eff.Online+eff.QA;
        rows.push({ id:t.id, title:t.title, BE:+eff.BE.toFixed(1), iOS:+eff.iOS.toFixed(1), Android:+eff.Android.toFixed(1), Online:+eff.Online.toFixed(1), QA:+eff.QA.toFixed(1), total:+sum.toFixed(1) });
        totals.BE += eff.BE; totals.iOS += eff.iOS; totals.Android += eff.Android; totals.Online += eff.Online; totals.QA += eff.QA; totals.total += sum;
      });
      for(const k in totals){ if(k!=='total') totals[k] = +totals[k].toFixed(1); }
      totals.total = +totals.total.toFixed(1);
      return {rows, totals};
    }

    function renderPhaseBreakdownTables(plan){
      const acc = byId('phaseBreakdown'); acc.innerHTML='';
      plan.phaseIds.forEach((phId, idx)=>{
        const ph = getPhase(phId);
        const aggr = aggregate(plan, state.tasks, getTeam);
        const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
        const win = sched.phaseWindows.find(w=> w.ph===phId);
        const span = win ? `${fmt(win.start)} → ${fmt(win.end)} (${daysBetween(win.start, win.end)} days)` : '';
        const data = computeTaskEffortsForPhase(plan, phId);
        const item = document.createElement('div'); item.className='accordion-item';
        item.innerHTML = `
          <h2 class="accordion-header">
            <button class="accordion-button ${idx>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${phId}">
              ${ph?.name||phId} — <span class="ms-1 text-secondary small">${span}</span>
            </button>
          </h2>
          <div id="collapse-${phId}" class="accordion-collapse collapse ${idx===0?'show':''}">
            <div class="accordion-body">
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                  <thead class="table-dark">
                    <tr><th style="width:10%">Task</th><th>Title</th><th style="width:10%;text-align:right">BE</th><th style="width:10%;text-align:right">iOS</th><th style="width:10%;text-align:right">Android</th><th style="width:10%;text-align:right">Online</th><th style="width:10%;text-align:right">QA</th><th style="width:10%;text-align:right">Total</th></tr>
                  </thead>
                  <tbody>
                    ${data.rows.map(r=> `<tr><td><code>${r.id}</code></td><td>${escapeHtml(r.title)}</td>
                      <td style="text-align:right">${r.BE.toFixed(1)}</td><td style="text-align:right">${r.iOS.toFixed(1)}</td>
                      <td style="text-align:right">${r.Android.toFixed(1)}</td><td style="text-align:right">${r.Online.toFixed(1)}</td>
                      <td style="text-align:right">${r.QA.toFixed(1)}</td><td style="text-align:right">${r.total.toFixed(1)}</td></tr>`).join('')}
                  </tbody>
                  <tfoot>
                    <tr class="table-secondary"><th colspan="2" class="text-end">Phase totals</th>
                      <th style="text-align:right">${data.totals.BE.toFixed(1)}</th>
                      <th style="text-align:right">${data.totals.iOS.toFixed(1)}</th>
                      <th style="text-align:right">${data.totals.Android.toFixed(1)}</th>
                      <th style="text-align:right">${data.totals.Online.toFixed(1)}</th>
                      <th style="text-align:right">${data.totals.QA.toFixed(1)}</th>
                      <th style="text-align:right">${data.totals.total.toFixed(1)}</th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>`;
        
        // Deliverable Scope (Viable Product)
        const scopeCard = document.createElement('div'); scopeCard.className='pdf-card mt-3';
        const sHead = document.createElement('div'); sHead.className='pdf-h3'; sHead.textContent = 'Deliverable Scope (Viable Product)';
        scopeCard.appendChild(sHead);
        const sTable = document.createElement('table'); sTable.className='table table-sm table-bordered'; sTable.style.width='100%';
        sTable.innerHTML = `<thead class="table-light"><tr><th style="width:12%">Task</th><th>Title</th></tr></thead><tbody></tbody>`;
        const sBody = sTable.querySelector('tbody');
          state.tasks.filter(t=> t.projectId===plan.projectId && t.viableProduct && (t.assignments||[]).some(a=> a.proposalId===plan.id && a.phaseId===phId)).forEach(t=>{
            const tr=document.createElement('tr'); tr.innerHTML = `<td><code>${t.id}</code></td><td>${escapeHtml(t.title)}</td>`; sBody.appendChild(tr);
          });
        scopeCard.appendChild(sTable);
        item.querySelector('.accordion-body').appendChild(scopeCard);

        acc.appendChild(item);
      });
    }

    /* ---------- PDF Export (unchanged) ---------- */
    
    function buildStaticTimelineNode(plan){
      const aggr = aggregate(plan, state.tasks, getTeam);
      const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      // A4 landscape content width ~1100px; respect padding used in .pdf-sheet (24px)
      const pageWidth = 1100 - 2*24;
      const labelPad = 140;
      const totalDays = Math.max(1, daysBetween(sched.chartStart, sched.chartEnd)+1);
      const pxPerDay = Math.max(3, Math.floor((pageWidth - labelPad) / totalDays));
      const width = totalDays * pxPerDay + labelPad;
      const wrap = document.createElement('div');
      wrap.className = 'pdf-card';
      const head = document.createElement('div'); head.className='pdf-h3'; head.textContent='Mini Gantt';
      wrap.appendChild(head);
      const container = document.createElement('div');
      container.style.position='relative'; container.style.overflow='visible'; container.style.width = width+'px'; container.style.border='1px solid #333';
      container.style.padding='0'; container.style.height = (plan.phaseIds.length*28 + 36)+'px';
      const grid = document.createElement('div'); grid.style.position='absolute'; grid.style.left=labelPad+'px'; grid.style.top='0'; grid.style.bottom='0'; grid.style.right='0';
      // vertical day lines every 7 days
      for(let d=0; d<totalDays; d+=7){
        const x = labelPad + d*pxPerDay;
        const v = document.createElement('div'); v.style.position='absolute'; v.style.left=x+'px'; v.style.top='0'; v.style.bottom='0'; v.style.width='0'; v.style.borderLeft='1px dashed rgba(127,127,127,.5)';
        container.appendChild(v);
      }
      // y rows
      plan.phaseIds.forEach((phId, idx)=>{
        const row = document.createElement('div'); row.style.position='relative'; row.style.height='28px'; row.style.borderTop='1px solid #333';
        const label = document.createElement('div'); label.textContent = getPhase(phId)?.name||phId; label.style.position='absolute'; label.style.left='8px'; label.style.top='4px'; label.style.width=(labelPad-16)+'px'; label.style.whiteSpace='nowrap'; label.style.overflow='hidden'; label.style.textOverflow='ellipsis';
        row.appendChild(label);
        const barWrap = document.createElement('div'); barWrap.style.position='absolute'; barWrap.style.left=labelPad+'px'; barWrap.style.right='0'; barWrap.style.top='3px'; barWrap.style.height='22px';
        const seg = (sched.phaseWindows||[]).find(w => w.ph === phId);
        if(seg){
          const left = daysBetween(sched.chartStart, seg.start) * pxPerDay;
          const segDays = Math.max(1, daysBetween(seg.start, seg.end) + 1);
          const w = segDays * pxPerDay;
          const bar = document.createElement('div');
          bar.style.position='absolute'; bar.style.left = (labelPad + left)+'px'; bar.style.top='0'; bar.style.height='100%'; bar.style.width = w+'px';
          bar.style.background='#4f46e5';
          container.appendChild(bar);
        }
        container.appendChild(row);
      });
      wrap.appendChild(container);
      return wrap;
    }

    function buildPlanBreakdownNode(plan){
      const node = document.createElement('div');
      const title = document.createElement('div'); title.className='pdf-h2'; title.textContent = plan.title;
      const meta = document.createElement('div'); meta.className='pdf-meta';
      const aggr = aggregate(plan, state.tasks, getTeam); const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      meta.textContent = `Team: ${getTeam(plan.teamId)?.name||'—'} • Buffer ${plan.bufferPct||0}% • ${fmt(sched.chartStart)} → ${fmt(sched.chartEnd)}`;
      node.appendChild(title); node.appendChild(meta);
      node.appendChild(buildStaticTimelineNode(plan));
      plan.phaseIds.forEach(phId=>{
        const ph = getPhase(phId);
        const data = computeTaskEffortsForPhase(plan, phId);
        const card = document.createElement('div'); card.className='pdf-card';
        const head = document.createElement('div'); head.className='pdf-h3'; head.textContent = `Phase: ${ph?.name||phId}`; card.appendChild(head);
        const tbl = document.createElement('table'); tbl.style.width='100%'; tbl.className='table table-sm table-bordered';
        tbl.innerHTML = `<thead class="table-light"><tr>
            <th style="width:10%">Task</th><th>Title</th>
            <th style="width:10%;text-align:right">BE</th>
            <th style="width:10%;text-align:right">iOS</th>
            <th style="width:10%;text-align:right">Android</th>
            <th style="width:10%;text-align:right">Online</th>
            <th style="width:10%;text-align:right">QA</th>
            <th style="width:10%;text-align:right">Total</th>
          </tr></thead><tbody></tbody>`;
        const tb = tbl.querySelector('tbody');
        data.rows.forEach(r=>{
          const tr=document.createElement('tr'); tr.innerHTML = `<td><code>${r.id}</code></td><td>${r.title}</td>
            <td style="text-align:right">${r.BE.toFixed(1)}</td>
            <td style="text-align:right">${r.iOS.toFixed(1)}</td>
            <td style="text-align:right">${r.Android.toFixed(1)}</td>
            <td style="text-align:right">${r.Online.toFixed(1)}</td>
            <td style="text-align:right">${r.QA.toFixed(1)}</td>
            <td style="text-align:right">${r.total.toFixed(1)}</td>`;
          tb.appendChild(tr);
        });
        const tf = document.createElement('tfoot'); tf.innerHTML = `<tr class="table-secondary">
          <th colspan="2" class="text-end">Phase totals</th>
          <th style="text-align:right">${data.totals.BE.toFixed(1)}</th>
          <th style="text-align:right">${data.totals.iOS.toFixed(1)}</th>
          <th style="text-align:right">${data.totals.Android.toFixed(1)}</th>
          <th style="text-align:right">${data.totals.Online.toFixed(1)}</th>
          <th style="text-align:right">${data.totals.QA.toFixed(1)}</th>
          <th style="text-align:right">${data.totals.total.toFixed(1)}</th>
        </tr>`;
        tbl.appendChild(tf);
        card.appendChild(tbl);
        node.appendChild(card);
      });
      return node;
    }
    async function exportProjectPDF(projectId){
      const pr = getProject(projectId); if(!pr) return;
      const container = document.createElement('div'); container.className='pdf-sheet';
      const h1 = document.createElement('div'); h1.className='pdf-h1'; h1.textContent = `Project: ${pr.name}`;
      const meta = document.createElement('div'); meta.className='pdf-meta'; meta.textContent = `${new Date().toLocaleString()} • Start ${state.meta.startDate} • Efficiency ${state.meta.efficiency} md/eng/day`;
      container.appendChild(h1); container.appendChild(meta);
      state.proposals.filter(p=>p.projectId===projectId).forEach(p=>{
        const block = buildPlanBreakdownNode(p);
        container.appendChild(block);
      });
      const opt = { margin: 10, filename: `${pr.name.replace(/\s+/g,'_')}.pdf`, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['css','legacy'] } };
      await html2pdf().from(container).set(opt).save();
    }
    
    async function exportPlanPDF(planId){
      const p = state.proposals.find(x=>x.id===planId); if(!p) return;
      const container = document.createElement('div'); container.className='pdf-sheet';
      const h1 = document.createElement('div'); h1.className='pdf-h1'; h1.textContent = `Delivery Plan: ${p.title}`;
      const pr = getProject(p.projectId);
      const meta = document.createElement('div'); meta.className='pdf-meta'; meta.textContent = `Project: ${pr?.name||'—'} • Team: ${getTeam(p.teamId)?.name||'—'} • Phases: ${p.phaseIds.map(id=> getPhase(id)?.name||id).join(' · ')}`;
      container.appendChild(h1); container.appendChild(meta);
      container.appendChild(buildPlanBreakdownNode(p));
      try{
        if(typeof html2pdf === 'function'){
          const opt = { margin: 10, filename: `Plan_${slug(p.title)}.pdf`, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }, pagebreak: { mode: ['css','legacy'] } };
          await html2pdf().from(container).set(opt).save();
          return;
        }
      }catch(e){ console.warn('html2pdf failed, falling back to print', e); }
      // Fallback: open print window
      const w = window.open('', '_blank');
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Plan PDF</title>
        <style>
          @page { size: A4 landscape; margin: 10mm; }
          body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;color:#111;background:#fff;}
          .pdf-sheet{padding:0; margin:0;}
        </style></head><body></body></html>`);
      w.document.body.appendChild(container);
      setTimeout(()=>{ w.focus(); w.print(); }, 250);
    }
    

    /* ---------- Basic Excel Export (SheetJS) ---------- */
    async function exportProjectExcel(projectId){
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const wb = XLSX.utils.book_new();
      const pr = getProject(projectId);
      const sheet = [["Project", pr?.name||"—"], ["Generated", new Date().toLocaleString()], [""], ["Plan","Team","Phases","Buffer%","Start","End","BE","iOS","Android","Online","QA"]];
      state.proposals.filter(p=>p.projectId===projectId).forEach(p=>{
        const aggr = aggregate(p, state.tasks, getTeam);
        const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
        const totals = {BE:0,iOS:0,Android:0,Online:0,QA:0};
        Object.values(aggr.phaseTotals).forEach(pt=>{ for(const k in totals){ totals[k]+=(pt[k]||0);} });
        sheet.push([p.title, getTeam(p.teamId)?.name||"—", p.phaseIds.map(id=>getPhase(id)?.name||id).join(" / "), p.bufferPct||0, sched.chartStart.toISOString().slice(0,10), sched.chartEnd.toISOString().slice(0,10), totals.BE, totals.iOS, totals.Android, totals.Online, totals.QA]);
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet), "Summary");
      state.proposals.filter(p=>p.projectId===projectId).forEach(p=> buildPlanSheetsForExcelBasic(wb,p));
      XLSX.writeFile(wb, (pr?.name||"Project")+"_Delivery.xlsx");
    }
    async function exportPlanExcel(planId){
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const wb = XLSX.utils.book_new();
      const p = state.proposals.find(x=>x.id===planId);
      buildPlanSheetsForExcelBasic(wb, p);
      XLSX.writeFile(wb, (p?.title||"Plan")+"_Delivery.xlsx");
    }
    function buildPlanSheetsForExcelBasic(wb, plan){
      const aggr = aggregate(plan, state.tasks, getTeam);
      const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      const overview = [
        ["Delivery Plan", plan.title],
        ["Project", getProject(plan.projectId)?.name||"—"],
        ["Team", getTeam(plan.teamId)?.name||"—"],
        ["Buffer %", plan.bufferPct||0],
        ["Schedule", fmt(sched.chartStart)+" → "+fmt(sched.chartEnd)],
        [""],
        ["Phase","BE","iOS","Android","Online","QA"]
      ];
      plan.phaseIds.forEach(pid=>{
        const t = aggr.phaseTotals[pid]||{};
        overview.push([getPhase(pid)?.name||pid, t.BE||0, t.iOS||0, t.Android||0, t.Online||0, t.QA||0]);
      });
      const sh_over = XLSX.utils.aoa_to_sheet(overview);
      XLSX.utils.book_append_sheet(wb, sh_over, sheetName(plan.title,"_Overview"));
      const rows = [["Phase","Task ID","Title","BE","iOS","Android","Online","QA","Total"]];
      plan.phaseIds.forEach(pid=>{
        const data = computeTaskEffortsForPhase(plan, pid);
        data.rows.forEach(r=> rows.push([getPhase(pid)?.name||pid, r.id, r.title, r.BE, r.iOS, r.Android, r.Online, r.QA, r.total]));
        rows.push(["Phase totals","","", data.totals.BE, data.totals.iOS, data.totals.Android, data.totals.Online, data.totals.QA, data.totals.total]);
        rows.push([""]);
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), sheetName(plan.title,"_Tasks"));
      const totalDays = Math.max(1, daysBetween(sched.chartStart, sched.chartEnd)+1);
      const header = ["Lane","Phase","Start","Days"];
      for(let d=0; d<totalDays; d++){
        const dt = new Date(sched.chartStart.getTime()+d*dayMs);
        header.push(dt.toISOString().slice(0,10));
      }
      const ganttRows = [header];
      sched.phaseWindows.forEach(w=>{
        w.lanes.forEach(li=>{
          const row = [li.key, w.ph, li.start.toISOString().slice(0,10), li.days];
          const startIdx = Math.max(0, Math.floor((li.start - sched.chartStart)/dayMs));
          for(let i=0;i<totalDays;i++){
            row.push(i>=startIdx && i<startIdx+li.days ? "■" : "");
          }
          ganttRows.push(row);
        });
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ganttRows), sheetName(plan.title,"_Gantt"));
    }

    /* ---------- Styled Excel Export (XlsxPopulate + Chart.js) ---------- */
    function platColorHex(role){
      const get = (v)=> getComputedStyle(document.documentElement).getPropertyValue(v).trim().replace('#','');
      const map = { BE:'--be', iOS:'--ios', Android:'--android', Online:'--web', QA:'--qa' };
      const hex = get(map[role]) || '888888';
      return '#'+hex;
    }
    async function exportProjectExcelStyled(projectId){
      if(!await ensureXPOP()){ alert("Could not load XlsxPopulate."); return; }
      const pr = getProject(projectId); const plans = state.proposals.filter(p=>p.projectId===projectId);
      const wb = await XlsxPopulate.fromBlankAsync();
      const sum = wb.sheet(0); sum.name("Summary");
      // Header
      sum.cell("A1").value("Project").style({bold:true, fill:"FFE699"});
      sum.cell("B1").value(pr?.name||"—").style({bold:true});
      sum.cell("A2").value("Generated").style({bold:true, fill:"FFE699"});
      sum.cell("B2").value(new Date()).style({numberFormat:"yyyy-mm-dd hh:mm"});
      sum.range("A1:B2").style({border:true});
      // Table header
      const header = ["Plan","Team","Phases","Buffer%","Start","End","BE","iOS","Android","Online","QA","Total"];
      sum.cell("A4").value([header]).style({bold:true, fill:"FFD966", border:true});
      let r=5;
      const totalsAll = {BE:0,iOS:0,Android:0,Online:0,QA:0};
      for(const p of plans){
        const aggr = aggregate(p, state.tasks, getTeam);
        const sched = computeSchedule(p, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
        const totals = {BE:0,iOS:0,Android:0,Online:0,QA:0};
        Object.values(aggr.phaseTotals).forEach(pt=>{ for(const k in totals){ totals[k]+=(pt[k]||0);} });
        for(const k in totals){ totalsAll[k]+=totals[k]; }
        const row = [p.title, getTeam(p.teamId)?.name||"—", p.phaseIds.map(id=>getPhase(id)?.name||id).join(" / "), p.bufferPct||0, sched.chartStart, sched.chartEnd, totals.BE, totals.iOS, totals.Android, totals.Online, totals.QA, totals.BE+totals.iOS+totals.Android+totals.Online+totals.QA];
        sum.cell("A"+r).value([row]).style({border:true});
        sum.cell("E"+r).style({numberFormat:"yyyy-mm-dd"});
        sum.cell("F"+r).style({numberFormat:"yyyy-mm-dd"});
        r++;
      }
      sum.column("A").width(32); sum.column("B").width(20); sum.column("C").width(30);
      for(const c of ["D","E","F","G","H","I","J","K","L"]) sum.column(c).width(14);
      // Add a simple summary chart as image (optional)
      try{
        if(await ensureCHART()){
          const canvas = document.createElement('canvas'); canvas.width=900; canvas.height=360;
          const ctx = canvas.getContext('2d');
          const labels = ["BE","iOS","Android","Online","QA"];
          const data = labels.map(k=> totalsAll[k]);
          new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Man-days', data }] }, options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#222'}}, y:{ticks:{color:'#222'}}} } });
          const png = canvas.toDataURL("image/png");
          const imgId = wb.addImage({ base64: png });
          sum.addImage(imgId, { tl: { col: 0, row: 0 }, ext: { width: 880, height: 280 }, br: { col: 8, row: 15 } });
        }
      }catch(e){ /* ignore if chart embedding not supported */ }
      // Per-plan sheets
      for(const p of plans){ await buildPlanSheetsStyled(wb, p); }
      const blob = await wb.outputAsync();
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(pr?.name||"Project")+"_Delivery_Styled.xlsx"; a.click(); URL.revokeObjectURL(a.href);
    }
    async function exportPlanExcelStyled(planId){
      if(!await ensureXPOP()){ alert("Could not load XlsxPopulate."); return; }
      const p = state.proposals.find(x=>x.id===planId); const wb = await XlsxPopulate.fromBlankAsync();
      await buildPlanSheetsStyled(wb, p);
      const blob = await wb.outputAsync();
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(p?.title||"Plan")+"_Delivery_Styled.xlsx"; a.click(); URL.revokeObjectURL(a.href);
    }
    async function buildPlanSheetsStyled(wb, plan){
      const aggr = aggregate(plan, state.tasks, getTeam);
      const sched = computeSchedule(plan, aggr, state.meta.efficiency, getPhase, state.meta.startDate);
      // Overview
      const shO = wb.addSheet(sheetName(plan.title,"_Overview"));
      shO.cell("A1").value("Delivery Plan").style({bold:true, fill:"FFE699"});
      shO.cell("B1").value(plan.title).style({bold:true});
      shO.cell("A2").value("Project").style({bold:true, fill:"FFE699"});
      shO.cell("B2").value(getProject(plan.projectId)?.name||"—");
      shO.cell("A3").value("Team").style({bold:true, fill:"FFE699"});
      shO.cell("B3").value(getTeam(plan.teamId)?.name||"—");
      shO.cell("A4").value("Buffer %").style({bold:true, fill:"FFE699"});
      shO.cell("B4").value(plan.bufferPct||0);
      shO.cell("A5").value("Schedule").style({bold:true, fill:"FFE699"});
      shO.cell("B5").value(fmt(sched.chartStart)+" → "+fmt(sched.chartEnd));
      shO.range("A1:B5").style({border:true});
      shO.cell("A7").value([["Phase","BE","iOS","Android","Online","QA","Total"]]).style({bold:true, fill:"FFD966", border:true});
      let rr=8;
      plan.phaseIds.forEach(pid=>{
        const t = aggr.phaseTotals[pid]||{};
        shO.cell("A"+rr).value([[getPhase(pid)?.name||pid, t.BE||0, t.iOS||0, t.Android||0, t.Online||0, t.QA||0, (t.BE||0)+(t.iOS||0)+(t.Android||0)+(t.Online||0)+(t.QA||0)]]).style({border:true});
        rr++;
      });
      shO.column("A").width(26); for(const c of "BCDEFG") shO.column(c).width(14);

      // Tasks
      const shT = wb.addSheet(sheetName(plan.title,"_Tasks"));
      shT.cell("A1").value([["Phase","Task ID","Title","BE","iOS","Android","Online","QA","Total"]]).style({bold:true, fill:"C6E0B4", border:true});
      let tr=2;
      plan.phaseIds.forEach(pid=>{
        const data = computeTaskEffortsForPhase(plan, pid);
        data.rows.forEach(r=>{
          shT.cell("A"+tr).value([[getPhase(pid)?.name||pid, r.id, r.title, r.BE, r.iOS, r.Android, r.Online, r.QA, r.total]]).style({border:true});
          tr++;
        });
        shT.cell("A"+tr).value([["Phase totals","","", data.totals.BE, data.totals.iOS, data.totals.Android, data.totals.Online, data.totals.QA, data.totals.total]]).style({bold:true, fill:"FCE4D6", border:true}); tr++;
        tr++;
      });
      shT.column("A").width(18); shT.column("B").width(12); shT.column("C").width(48);
      for(const c of "DEFGHI") shT.column(c).width(12);

      // Gantt (colored cells)
      const shG = wb.addSheet(sheetName(plan.title,"_Gantt"));
      const totalDays = Math.max(1, daysBetween(sched.chartStart, sched.chartEnd)+1);
      const header = ["Lane","Phase","Start","Days"];
      for(let d=0; d<totalDays; d++){ const dt = new Date(sched.chartStart.getTime()+d*dayMs); header.push(dt.toISOString().slice(0,10)); }
      shG.cell("A1").value([header]).style({bold:true, fill:"9BC2E6", border:true});
      let gr=2;
      sched.phaseWindows.forEach(w=>{
        w.lanes.forEach(li=>{
          const row = [li.key, w.ph, li.start.toISOString().slice(0,10), li.days];
          shG.cell("A"+gr).value([row]).style({border:true});
          const startIdx = Math.max(0, Math.floor((li.start - sched.chartStart)/dayMs));
          for(let i=0;i<totalDays;i++){
            const cell = shG.cell(4 + i + 1, gr); // (col,row) is 1-based; col 5 = first date column
          }
          // Fill colored cells for the bar
          const laneColor = platColorHex(li.key==='Online'?'Online':li.key);
          for(let i=startIdx;i<startIdx+li.days;i++){
            const col = 5 + i; // A=1 -> 5 is first date column
            shG.cell(gr, col).style({ fill: laneColor, border:true });
          }
          gr++;
        });
      });
      shG.column(1).width(12); shG.column(2).width(10); shG.column(3).width(12); shG.column(4).width(8);
      for(let c=5;c<5+totalDays;c++) shG.column(c).width(3);
      try{ shG.freezePanes(2,5); }catch(e){ /* some versions of XlsxPopulate may lack freezePanes */ }
    }

    /* ---------- Tasks CSV/XLSX Import/Export ---------- */
    function tasksToRows(){
      const rows = [["id","title","description","startDate","be_md","be_start","ios_md","ios_start","android_md","android_start","online_md","online_start","qa_md","qa_start","assignments"]];
      state.tasks.forEach(t=>{
        const eff = {BE:{},iOS:{},Android:{},Online:{},QA:{}};
        (t.efforts||[]).forEach(e=>{ eff[e.platform]={ md:e.manDays||"", start:e.startDate||"" }; });
        const asg = (t.assignments||[]).map(a=> `${a.proposalId}:${a.phaseId}`).join(";");
        rows.push([t.id, t.title, t.description||"", t.startDate||"", eff.BE.md||"", eff.BE.start||"", eff.iOS.md||"", eff.iOS.start||"", eff.Android.md||"", eff.Android.start||"", eff.Online.md||"", eff.Online.start||"", eff.QA.md||"", eff.QA.start||"", asg]);
      });
      return rows;
    }
    function exportTasksCSV(){
      const rows = tasksToRows();
      const csv = rows.map(r=> r.map(v=> {
        const s = (v==null?"":String(v)); if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"'; return s;
      }).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tasks_export.csv'; a.click(); URL.revokeObjectURL(a.href);
    }
    async function exportTasksXLSX(){
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(tasksToRows()), "Tasks");
      XLSX.writeFile(wb, "tasks_export.xlsx");
    }
    async function importTasksFile(file){
      const name = (file?.name||"").toLowerCase();
      if(name.endsWith(".csv")){
        const text = await file.text();
        const rows = text.split(/\r?\n/).map(line=>{
          const out=[]; let cur=""; let q=false;
          for(let i=0;i<line.length;i++){
            const ch=line[i];
            if(ch=='"'){ if(q && line[i+1]=='"'){ cur+='"'; i++; } else { q=!q; } }
            else if(ch==',' && !q){ out.push(cur); cur=""; }
            else cur+=ch;
          }
          out.push(cur); return out;
        });
        const headers = rows.shift().map(h=>h.trim().toLowerCase());
        validateColumns(Object.fromEntries(headers.map(h=>[h,true])), ['id','title','assignments']);
        const idx = (k)=> headers.indexOf(k);
        rows.forEach(cols=>{
          if(!cols.length) return;
          const get = (k)=> cols[idx(k)]||"";
          const id = get("id"); if(!id) return;
          const t = { id, title:get("title"), description:get("description"), startDate:get("startdate"), efforts:[], assignments:[] };
          [["be","BE"],["ios","iOS"],["android","Android"],["online","Online"],["qa","QA"]].forEach(([k,plat])=>{
            const md = parseFloat(get(k+"_md")); const sd = get(k+"_start");
            if(!isNaN(md) && md>0) t.efforts.push({platform:plat, manDays:md, startDate:sd});
          });
          const asg = get("assignments").split(";").map(s=>s.trim()).filter(Boolean).map(tok=>{ const [proposalId,phaseId]=tok.split(":"); return (proposalId&&phaseId)?{proposalId,phaseId}:null; }).filter(Boolean);
          t.assignments = asg;
          const at = state.tasks.findIndex(x=>x.id===id);
          if(at>=0) state.tasks[at]=t; else state.tasks.push(t);
        });
        save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); toast("Tasks imported (CSV)");
        return;
      }
      if(!await ensureXLSX()){ alert("Excel library couldn't be loaded. Use CSV export instead from Data ▸ Export Tasks (CSV)."); return; }
      const data = new Uint8Array(await file.arrayBuffer());
      const wb = XLSX.read(data, {type:"array"});
      const first = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(first, {defval:""});
      const norm = n=> String(n||"").trim().toLowerCase();
      json.forEach(row=>{
        const map = {}; Object.keys(row).forEach(k=> map[norm(k)] = row[k]);
        const id = map["id"]; if(!id) return;
        const t = {
          id,
          title: map["title"]||"",
          description: map["description"]||"",
          startDate: map["startdate"]||"",
          efforts: [],
          assignments: (map["assignments"]||"").split(";").map(s=>s.trim()).filter(Boolean).map(tok=>{ const [proposalId, phaseId] = tok.split(":"); return (proposalId&&phaseId)?{proposalId, phaseId}:null; }).filter(Boolean)
        };
        [["be","BE"],["ios","iOS"],["android","Android"],["online","Online"],["qa","QA"]].forEach(([k,plat])=>{
          const md = parseFloat(map[k+"_md"]); const sd = map[k+"_start"]||"";
          if(!isNaN(md) && md>0){ t.efforts.push({ platform:plat, manDays: md, startDate: sd }); }
        });
        const idx = state.tasks.findIndex(x=> x.id===id);
        if(idx>=0) state.tasks[idx] = t; else state.tasks.push(t);
      });
      save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); toast("Tasks imported (Excel)");
    }

    /* ---------- CRUD (Manage) with ID rules ---------- */
    const manageModal = new bootstrap.Modal('#manageModal');
    const editModal = new bootstrap.Modal('#editModal');
    byId('btn-manage').onclick = ()=>{ refreshManage(); manageModal.show(); };
    byId('btn-save-manage').onclick = ()=>{ save(); refreshManage(); };

    function refreshManage(){
      const filterP = (byId('search-projects').value||'').toLowerCase();
      const tbP = byId('tbl-projects').querySelector('tbody'); tbP.innerHTML='';
      state.projects.filter(p=> (p.name+' '+p.id).toLowerCase().includes(filterP)).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.name}</td><td>${p.description||''}</td><td><code>${p.id}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('project', p.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete project?')){
          state.proposals.forEach(pr=>{ if(pr.projectId===p.id) pr.projectId = state.projects[0]?.id || ''; });
          state.projects = state.projects.filter(x=>x.id!==p.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbP.appendChild(tr);
      });
      const filterPl = (byId('search-plans').value||'').toLowerCase();
      const tbPl = byId('tbl-plans').querySelector('tbody'); tbPl.innerHTML='';
      state.proposals.filter(p=> (p.title+' '+p.id).toLowerCase().includes(filterPl)).forEach(p=>{
        const aggr = aggregate(p, state.tasks, getTeam);
        const totals = {BE:0,iOS:0,Android:0,Online:0,QA:0};
        Object.values(aggr.phaseTotals).forEach(pt=>{ for(const k in totals){ totals[k]+=(pt[k]||0);} });
        const sumEff = totals.BE+totals.iOS+totals.Android+totals.Online+totals.QA || 1;
        const seg = { BE:Math.max(2,Math.round(180*(totals.BE/sumEff))), iOS:Math.max(2,Math.round(180*(totals.iOS/sumEff))),
                      Android:Math.max(2,Math.round(180*(totals.Android/sumEff))), Online:Math.max(2,Math.round(180*(totals.Online/sumEff))) };
        const segQA = 180 - seg.BE - seg.iOS - seg.Android - seg.Online;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.title}</td><td>${getProject(p.projectId)?.name||'—'}</td><td>${getTeam(p.teamId)?.name||'—'}</td>
          <td>${p.phaseIds.map(id=> getPhase(id)?.name||id).join(' · ')}</td>
          <td>${p.bufferPct||0}</td>
          <td><div class="mini-timeline"><div class="mini-phase">
            ${p.phaseIds.map((phId, i)=>`<div class="position-absolute top-0" style="left:${Math.round((i/p.phaseIds.length)*100)}%;height:8px;border-left:1px solid rgba(127,127,127,.6)"></div>`).join('')}
          </div>
          <div class="mini-platforms">
            <div class="seg-be" style="width:${seg.BE}px"></div>
            <div class="seg-ios" style="width:${seg.iOS}px"></div>
            <div class="seg-android" style="width:${seg.Android}px"></div>
            <div class="seg-web" style="width:${seg.Online}px"></div>
            <div class="seg-qa" style="width:${Math.max(2,segQA)}px"></div>
          </div></div></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('plan', p.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete plan?')){
          state.tasks.forEach(t=> t.assignments = (t.assignments||[]).filter(a=>a.proposalId!==p.id));
          state.proposals = state.proposals.filter(x=>x.id!==p.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbPl.appendChild(tr);
      });
      const filterPh = (byId('search-phases').value||'').toLowerCase();
      const tbPh = byId('tbl-phases').querySelector('tbody'); tbPh.innerHTML='';
      state.phases.slice().sort((a,b)=>(a.order||0)-(b.order||0)).filter(p=> (p.name+' '+p.id).toLowerCase().includes(filterPh)).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.name}</td><td>${p.description||''}</td><td>${p.order||1}</td><td><code>${p.id}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('phase', p.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete phase?')){
          state.proposals.forEach(pr=> pr.phaseIds = (pr.phaseIds||[]).filter(id=>id!==p.id));
          state.tasks.forEach(t=> t.assignments = (t.assignments||[]).filter(a=>a.phaseId!==p.id));
          state.phases = state.phases.filter(x=>x.id!==p.id);
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbPh.appendChild(tr);
      });
      const filterTm = (byId('search-teams').value||'').toLowerCase();
      const tbTm = byId('tbl-teams').querySelector('tbody'); tbTm.innerHTML='';
      state.teams.filter(t=> (t.name+' '+t.id).toLowerCase().includes(filterTm)).forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.name}</td><td>${t.sizes.BE||0}</td><td>${t.sizes.iOS||0}</td><td>${t.sizes.Android||0}</td><td>${t.sizes.Online||0}</td><td>${t.sizes.QA||0}</td><td><code>${t.id}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('team', t.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete team?')){
          state.proposals.forEach(p=>{ if(p.teamId===t.id) p.teamId = state.teams[0]?.id || ''; });
          state.teams = state.teams.filter(x=>x.id!==t.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        } };
        tbTm.appendChild(tr);
      });
      const filterTk = (byId('search-tasks').value||'').toLowerCase();
      const tbTk = byId('tbl-tasks').querySelector('tbody'); tbTk.innerHTML='';
      state.tasks.filter(t=> (t.title+' '+t.id).toLowerCase().includes(filterTk)).forEach(t=>{
        const eff = (t.efforts||[]).map(e=> `${e.platform}:${e.manDays}${e.startDate? ' ('+e.startDate+')':''}`).join(', ');
        const asg = (t.assignments||[]).map(a=> `${a.proposalId}/${a.phaseId}`).join(', ');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.title}</td><td>${t.startDate||''}</td><td>${getProject(t.projectId)?.name||'—'}</td><td>${t.viableProduct?'Yes':'No'}</td><td>${eff||'-'}</td><td><code>${t.id}</code></td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary">Edit</button><button class="btn btn-sm btn-outline-danger ms-1">Delete</button></td>`;
        tr.querySelector('.btn-outline-primary').onclick = ()=> openEditor('task', t.id);
        tr.querySelector('.btn-outline-danger').onclick = ()=>{ if(confirm('Delete task?')){ state.tasks = state.tasks.filter(x=>x.id!==t.id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); } };
        tbTk.appendChild(tr);
      });
      byId('btn-add-project').onclick = ()=> openEditor('project', null);
      byId('btn-add-plan').onclick = ()=> openEditor('plan', null);
      byId('btn-add-phase').onclick = ()=> openEditor('phase', null);
      byId('btn-add-team').onclick = ()=> openEditor('team', null);
      byId('btn-add-task').onclick = ()=> openEditor('task', null);
      byId('search-projects').oninput = refreshManage;
      byId('search-plans').oninput = refreshManage;
      byId('search-phases').oninput = refreshManage;
      byId('search-teams').oninput = refreshManage;
      byId('search-tasks').oninput = refreshManage;
      // Phase Tasks tab wiring
      const ptProjSel = byId('pt-proj');
      const ptContainers = byId('phaseTaskContainers');
      if(ptContainers){
        ptProjSel.innerHTML = (state.projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        if(!ptProjSel.value && state.projects[0]) ptProjSel.value = state.projects[0].id;
        function renderPhaseTasks(){
          const pid = ptProjSel.value;
          ptContainers.innerHTML = '';
          state.phases.forEach(ph=>{
            const box=document.createElement('div');
            box.className='border rounded p-2';
            box.style.minWidth='220px';
            box.innerHTML=`<h6>${ph.name}</h6><div class="vstack gap-1" data-ph="${ph.id}"></div>`;
            ptContainers.appendChild(box);
          });
          state.tasks.filter(t=> t.projectId===pid).forEach(t=>{
            (t.phaseIds||[]).forEach(phId=>{
              const dest=ptContainers.querySelector(`div[data-ph="${phId}"]`);
              if(dest){
                const item=document.createElement('div');
                item.className='border rounded px-2 py-1 bg-body-secondary';
                item.textContent=t.title;
                dest.appendChild(item);
              }
            });
          });
        }
        ptProjSel.onchange = renderPhaseTasks;
        renderPhaseTasks();
        const saveBtn = byId('pt-save');
        if(saveBtn) saveBtn.onclick = ()=>{ save(); toast('Phase tasks updated'); };
      }
      // Efforts tab wiring
      const effProjSel = byId('eff-proj');
      const effSearch = byId('eff-search');
      const effBody = byId('tbl-eff')?.querySelector('tbody');
      if(effBody){
        effProjSel.innerHTML = (state.projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        if(!effProjSel.value && state.projects[0]) effProjSel.value = state.projects[0].id;
        function renderEffTbl(){
          const pid = effProjSel.value; const q=(effSearch.value||'').toLowerCase();
          effBody.innerHTML='';
          state.tasks.filter(t=> t.projectId===pid && (t.title+' '+t.id).toLowerCase().includes(q)).forEach(t=>{
            const m = Object.fromEntries((t.efforts||[]).map(e=> [e.platform, e.manDays]));
            const tr=document.createElement('tr');
            tr.innerHTML = `<td><code>${t.id}</code></td><td>${t.title}</td>
              <td><input type="number" step="0.1" min="0" class="form-control form-control-sm" data-tid="${t.id}" data-k="BE" value="${m.BE??''}"></td>
              <td><input type="number" step="0.1" min="0" class="form-control form-control-sm" data-tid="${t.id}" data-k="iOS" value="${m.iOS??''}"></td>
              <td><input type="number" step="0.1" min="0" class="form-control form-control-sm" data-tid="${t.id}" data-k="Android" value="${m.Android??''}"></td>
              <td><input type="number" step="0.1" min="0" class="form-control form-control-sm" data-tid="${t.id}" data-k="Online" value="${m.Online??''}"></td>
              <td><input type="number" step="0.1" min="0" class="form-control form-control-sm" data-tid="${t.id}" data-k="QA" value="${m.QA??''}"></td>`;
            effBody.appendChild(tr);
          });
        }
        effProjSel.onchange = renderEffTbl; effSearch.oninput = renderEffTbl; renderEffTbl();
        byId('eff-save').onclick = ()=>{
          const inputs = Array.from(effBody.querySelectorAll('input'));
          const byTask = new Map();
          inputs.forEach(inp=>{ const tid=inp.dataset.tid; if(!byTask.has(tid)) byTask.set(tid, []); byTask.get(tid).push(inp); });
          byTask.forEach((arr, tid)=>{
            const t = state.tasks.find(x=> x.id===tid); if(!t) return; const map={};
            arr.forEach(inp=>{ const k=inp.dataset.k; const v= inp.value===''? null : Math.max(0, +inp.value); if(v!=null) map[k]=+v.toFixed(1); });
            t.efforts = Object.entries(map).map(([platform, manDays])=>({platform, manDays}));
          });
          save(); toast('Efforts updated'); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
        };
      }

      byId('gen-start').value = state.meta.startDate;
      byId('gen-eff').value = state.meta.efficiency;
      byId('gen-px').value = state.meta.defaultPxPerDay||18;
      byId('gen-rtl').checked = !!state.meta.rtl;
      fillThemes();
      byId('gen-theme').value = state.meta.theme || "Dark";
      byId('gen-save').onclick = ()=>{
        state.meta.startDate = byId('gen-start').value || state.meta.startDate;
        state.meta.efficiency = Math.max(0.2, Math.min(1.2, +byId('gen-eff').value || state.meta.efficiency));
        state.meta.defaultPxPerDay = Math.max(6, Math.min(44, +byId('gen-px').value || state.meta.defaultPxPerDay || 18));
        state.meta.rtl = !!byId('gen-rtl').checked;
        state.meta.theme = byId('gen-theme').value || "Dark";
        document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr');
        applyTheme(state.meta.theme);
        save(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
      };
      byId('gen-apply-px').onclick = ()=>{
        const px = Math.max(6, Math.min(44, +byId('gen-px').value || 18));
        state.proposals.forEach(p=> p.pxPerDay = px);
        state.meta.defaultPxPerDay = px;
        save(); toast('Applied zoom to all plans'); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
      };
    }
    function openEditor(kind, id){
      const form = byId('editForm'); const title = byId('editTitle'); const del = byId('editDelete');
      form.innerHTML=''; del.classList.toggle('d-none', !id);
      function field(label, inner){ return `<div><label class="form-label">${label}</label>${inner}</div>`; }
      function val(id){ return byId(id).value.trim(); }
      function idInputHtml(value, isEdit){ return `<input id="f-id" class="form-control" value="${escapeHtml(value)}" ${isEdit?'readonly disabled':''}>`; }
      function ensureUniqueId(collection, idVal){ return !collection.some(x=> x.id===idVal); }

      if(kind==='project'){
        const isEdit = !!id;
        const data = isEdit ? state.projects.find(x=>x.id===id) : { id:'proj-'+Math.random().toString(36).slice(2,6), name:'', description:'' };
        title.textContent = isEdit? 'Edit Project' : 'Add Project';
        form.innerHTML = [
          field('Name', `<input id="f-name" class="form-control" value="${escapeHtml(data.name)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.projects, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, name:val('f-name'), description:val('f-desc') };
          if(isEdit){ Object.assign(state.projects.find(x=>x.id===id), obj); } else { state.projects.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete project?')){ state.proposals.forEach(p=>{ if(p.projectId===id) p.projectId = state.projects[0]?.id || ''; }); state.projects = state.projects.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
      if(kind==='plan'){
        const isEdit = !!id;
        const data = isEdit ? state.proposals.find(x=>x.id===id) : { id:'prop'+Math.random().toString(36).slice(2,7), projectId:state.projects[0]?.id||'', title:'', description:'', teamId:state.teams[0]?.id||'', bufferPct:12, phaseIds:[], pxPerDay:state.meta.defaultPxPerDay||18, overrides:{} };
        title.textContent = isEdit? 'Edit Delivery Plan' : 'Add Delivery Plan';
        form.innerHTML = [
          field('Project', `<select id="f-project" class="form-select">${state.projects.map(p=> `<option value="${p.id}" ${p.id===data.projectId?'selected':''}>${escapeHtml(p.name)}</option>`).join('')}</select>`),
          field('Title', `<input id="f-title" class="form-control" value="${escapeHtml(data.title)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('Team', `<select id="f-team" class="form-select">${state.teams.map(t=> `<option value="${t.id}" ${t.id===data.teamId?'selected':''}>${escapeHtml(t.name)}</option>`).join('')}</select>`),
          field('Buffer %', `<input id="f-buffer" class="form-control" type="number" min="0" step="1" value="${data.bufferPct||0}">`),
          field('Phases (multi-select)', `<select id="f-phases" class="form-select" multiple size="6">${state.phases.map(ph=> `<option value="${ph.id}" ${data.phaseIds.includes(ph.id)?'selected':''}>${escapeHtml(ph.name)}</option>`).join('')}</select>`),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.proposals, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, projectId:val('f-project'), title:val('f-title'), description:val('f-desc'), teamId:val('f-team'), bufferPct:+val('f-buffer')||0, phaseIds: Array.from(byId('f-phases').selectedOptions).map(o=>o.value), pxPerDay:data.pxPerDay||state.meta.defaultPxPerDay||18, overrides:data.overrides||{} };
          if(isEdit){ Object.assign(state.proposals.find(x=>x.id===id), obj); } else { state.proposals.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete plan?')){ state.tasks.forEach(t=> t.assignments = (t.assignments||[]).filter(a=>a.proposalId!==id)); state.proposals = state.proposals.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
      if(kind==='phase'){
        const isEdit = !!id;
        const data = isEdit ? state.phases.find(x=>x.id===id) : { id:'PH'+Math.random().toString(36).slice(2,6), name:'', description:'', order:1 };
        title.textContent = isEdit? 'Edit Phase' : 'Add Phase';
        form.innerHTML = [
          field('Title', `<input id="f-name" class="form-control" value="${escapeHtml(data.name)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('Order', `<input id="f-order" class="form-control" type="number" min="1" step="1" value="${data.order||1}">`),
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.phases, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, name:val('f-name'), description:val('f-desc'), order:+val('f-order')||1 };
          if(isEdit){ Object.assign(state.phases.find(x=>x.id===id), obj); } else { state.phases.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete phase?')){ state.proposals.forEach(p=> p.phaseIds=(p.phaseIds||[]).filter(x=>x!==id)); state.tasks.forEach(t=> t.assignments=(t.assignments||[]).filter(a=>a.phaseId!==id)); state.phases = state.phases.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
      if(kind==='team'){
        const isEdit = !!id;
        const data = isEdit ? state.teams.find(x=>x.id===id) : { id:'team-'+Math.random().toString(36).slice(2,6), name:'', sizes:{BE:0,iOS:0,Android:0,Online:0,QA:0} };
        title.textContent = isEdit? 'Edit Team' : 'Add Team';
        form.innerHTML = [
          field('Name', `<input id="f-name" class="form-control" value="${escapeHtml(data.name)}">`),
          `<div class="row g-2">
            <div class="col">${field('BE', `<input id="f-be" class="form-control" type="number" value="${data.sizes.BE||0}">`)}</div>
            <div class="col">${field('iOS', `<input id="f-ios" class="form-control" type="number" value="${data.sizes.iOS||0}">`)}</div>
            <div class="col">${field('Android', `<input id="f-android" class="form-control" type="number" value="${data.sizes.Android||0}">`)}</div>
            <div class="col">${field('Online', `<input id="f-online" class="form-control" type="number" value="${data.sizes.Online||0}">`)}</div>
            <div class="col">${field('QA', `<input id="f-qa" class="form-control" type="number" value="${data.sizes.QA||0}">`)}</div>
          </div>`,
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && !ensureUniqueId(state.teams, newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, name:val('f-name'), sizes:{ BE:+val('f-be')||0, iOS:+val('f-ios')||0, Android:+val('f-android')||0, Online:+val('f-online')||0, QA:+val('f-qa')||0 } };
          if(isEdit){ Object.assign(state.teams.find(x=>x.id===id), obj); } else { state.teams.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete team?')){ state.proposals.forEach(p=>{ if(p.teamId===id) p.teamId = state.teams[0]?.id || ''; }); state.teams = state.teams.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
      
      if(kind==='task'){
        const isEdit = !!id;
        const data = isEdit ? state.tasks.find(x=>x.id===id) : { id: Math.random().toString(36).slice(2,6), title:'', description:'', startDate:'', projectId: (state.projects[0]?.id||''), viableProduct:false, efforts:[], assignments:[] };
        title.textContent = isEdit? 'Edit Task' : 'Add Task';
        form.innerHTML = [
          field('Title', `<input id="f-title" class="form-control" value="${escapeHtml(data.title)}">`),
          field('Description', `<textarea id="f-desc" class="form-control" rows="3">${escapeHtml(data.description||'')}</textarea>`),
          field('Project', `<select id="f-project" class="form-select">${state.projects.map(p=>`<option value="${p.id}" ${p.id===(data.projectId||state.projects[0]?.id)?'selected':''}>${escapeHtml(p.name)}</option>`).join('')}</select>`),
          field('Task start (optional)', `<input id="f-start" type="date" class="form-control" value="${escapeHtml(data.startDate||'')}">`),
          `<div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="f-vp" ${data.viableProduct?'checked':''}><label class="form-check-label" for="f-vp">Viable Product</label></div>`,
          `<hr><h6>Assignments</h6>
           <div class="row g-2 align-items-end">
             <div class="col-5">${field('Delivery Plan', `<select id="f-asg-plan" class="form-select">${state.proposals.map(p=>`<option value="${p.id}">${escapeHtml(p.title)}</option>`).join('')}</select>`)}</div>
             <div class="col-5">${field('Phase', `<select id="f-asg-phase" class="form-select">${state.phases.map(ph=>`<option value="${ph.id}">${escapeHtml(ph.name)}</option>`).join('')}</select>`)}</div>
             <div class="col-2"><button type="button" class="btn btn-outline-secondary w-100" id="btn-asg-add"><i class="bi bi-plus-lg"></i> Add</button></div>
           </div>
           <div id="asg-list" class="small text-secondary"></div>`,
          field('ID', idInputHtml(data.id, isEdit)),
        ].join('');
        const asgList = byId('asg-list');
        function renderAsg(){
          asgList.innerHTML = (data.assignments||[]).map((a,i)=>`<div class="d-flex justify-content-between align-items-center border rounded px-2 py-1 my-1">
            <div>${getProposal(a.proposalId)?.title||a.proposalId} • ${getPhase(a.phaseId)?.name||a.phaseId}</div>
            <button class="btn btn-sm btn-outline-danger" data-i="${i}">Delete</button>
          </div>`).join('') || '<div class="text-secondary">No assignments</div>';
          Array.from(asgList.querySelectorAll('button[data-i]')).forEach(btn=> btn.onclick = ()=>{ const i=+btn.dataset.i; data.assignments.splice(i,1); renderAsg(); });
        }
        renderAsg();
        byId('btn-asg-add').onclick = ()=>{
          const a={ proposalId: val('f-asg-plan'), phaseId: val('f-asg-phase') };
          data.assignments = data.assignments||[]; data.assignments.push(a); renderAsg();
        };
        byId('editSave').onclick = ()=>{
          const newId = val('f-id'); if(!isEdit && state.tasks.some(x=>x.id===newId)) return alert('ID already exists.');
          const obj = { id: isEdit? data.id : newId, title:val('f-title'), description:val('f-desc'), startDate:byId('f-start').value, projectId: byId('f-project').value, viableProduct: !!byId('f-vp').checked, efforts:data.efforts||[], assignments:data.assignments||[] };
          if(isEdit){ Object.assign(state.tasks.find(x=>x.id===id), obj); } else { state.tasks.push(obj); }
          save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide();
        };
        del.onclick = ()=>{ if(confirm('Delete task?')){ state.tasks = state.tasks.filter(x=>x.id!==id); save(); refreshManage(); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects(); bootstrap.Modal.getInstance(byId('editModal')).hide(); } };
      }
    
      new bootstrap.Modal('#editModal').show();
    }

    /* ---------- Export/Import/Reset ---------- */
    byId('btn-export').onclick = ()=>{
      let data;
      if(currentPlanId){
        const plan = state.proposals.find(p=>p.id===currentPlanId);
        data = exportPlanJSON(plan);
      }else{
        data = JSON.stringify(state,null,2);
      }
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='project_planner_v20.json'; a.click(); URL.revokeObjectURL(url);
    };
      byId('file-import').onchange = (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.phaseIds){ state.proposals.push(importPlanJSON(r.result)); } else { replaceState(obj); } save(); applyTheme(state.meta.theme||"Dark"); document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr'); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
        buildProjects(); }catch(err){ alert('Invalid JSON: '+err); } }; r.readAsText(f); };
      byId('btn-reset').onclick = ()=>{ if(confirm('Reset to defaults?')){ replaceState(structuredClone(DEFAULT_DATA)); save(); applyTheme(state.meta.theme||"Dark"); document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr'); try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
        buildProjects(); } };
    byId('themeSelect').onchange = (e)=>{ state.meta.theme = e.target.value; applyTheme(state.meta.theme); save(); };
    // Data menu
    byId('exportTasksCSV').onclick = exportTasksCSV;
    byId('exportTasksXLSX').onclick = exportTasksXLSX;
    byId('importTasks').onchange = (e)=>{ const f=e.target.files[0]; if(f) importTasksFile(f); };
    // Styled Excel menu
    byId('btn-export-project-xlsx-styled').onclick = ()=>{
      const pr = state.projects[0]; if(pr) exportProjectExcelStyled(pr.id); else alert('No project found.');
    };
    byId('btn-export-plan-xlsx-styled').onclick = ()=>{
      if(!currentPlanId){ alert('Open a plan first (Details view).'); return; }
      exportPlanExcelStyled(currentPlanId);
    };
    // Basic Excel menu (header dropdown already present)
    byId('btn-export-project-xlsx').onclick = ()=>{
      const pr = state.projects[0]; if(pr) exportProjectExcel(pr.id); else alert('No project found.');
    };
    byId('btn-export-plan-xlsx').onclick = ()=>{
      if(!currentPlanId){ alert('Open a plan first (Details view).'); return; }
      exportPlanExcel(currentPlanId);
    };

    // Boot
    function initApp(){
      fillThemes();
      applyTheme(state.meta.theme||"Dark");
      document.documentElement.setAttribute('dir', state.meta.rtl ? 'rtl' : 'ltr');
      byId('startLabel').textContent = state.meta.startDate;
      byId('effLabel').textContent = state.meta.efficiency;
      
      // Migration: ensure each task has a projectId
      try{
        const defaultProj = state.proposals[0]?.projectId || state.projects[0]?.id || '';
        state.tasks.forEach(t=>{ if(!t.projectId){ t.projectId = defaultProj; } });
        save();
      }catch(e){}
      try{ let need=false; (state.tasks||[]).forEach(t=>{ if(!t.efforts || !t.efforts.length) need=true; }); if(need){ seedEffortsFromBaselineGlobal(); save(); } }catch(e){}
      buildProjects();
    
      }
    initApp();
  </script>

</body>
</html>
